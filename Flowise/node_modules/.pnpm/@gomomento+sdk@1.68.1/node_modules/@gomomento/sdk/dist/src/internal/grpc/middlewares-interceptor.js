"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.middlewaresInterceptor = void 0;
const grpc_js_1 = require("@grpc/grpc-js");
const middleware_1 = require("../../config/middleware/middleware");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
const connectivity_state_1 = require("@grpc/grpc-js/build/src/connectivity-state");
function middlewaresInterceptor(loggerFactory, middlewares, middlewareRequestContext, grpcClient = null) {
    const logger = loggerFactory.getLogger('grpc-interceptor');
    return (options, nextCall) => {
        const middlewareRequestHandlers = middlewares.map(m => m.onNewRequest(middlewareRequestContext));
        // create a copy of the handlers and reverse it, because for the response life cycle actions we should call
        // the middlewares in the opposite order.
        const reversedMiddlewareRequestHandlers = [
            ...middlewareRequestHandlers,
        ].reverse();
        const requester = {
            start: function (metadata, listener, next) {
                const newListener = {
                    onReceiveMetadata: function (metadata, next) {
                        applyMiddlewareHandlers('onResponseMetadata', reversedMiddlewareRequestHandlers, (h) => (m) => h.onResponseMetadata(m), new middleware_1.MiddlewareMetadata(metadata), (metadata) => next(metadata._grpcMetadata));
                    },
                    onReceiveMessage: function (
                    // unfortunately grpc uses `any` in their type defs for these
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    message, 
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    next) {
                        applyMiddlewareHandlers('onResponseBody', reversedMiddlewareRequestHandlers, (h) => (request) => h.onResponseBody(request), new middleware_1.MiddlewareMessage(message), (msg) => next(msg === null || msg === void 0 ? void 0 : msg._grpcMessage));
                    },
                    onReceiveStatus: function (status, next) {
                        var _a, _b;
                        if (status.code === constants_1.Status.DEADLINE_EXCEEDED) {
                            // getConnectivityState(true) will return state of connection and
                            // also try to connect if it's idle, false will just get the status
                            const connectionStatus = (_b = (_a = grpcClient === null || grpcClient === void 0 ? void 0 : grpcClient.getChannel()) === null || _a === void 0 ? void 0 : _a.getConnectivityState(false)) !== null && _b !== void 0 ? _b : null;
                            logger.warn(`Deadline Exceeded! Received status: ${status.code} ${status.details} and grpc connection status: ${connectionStatus
                                ? connectivity_state_1.ConnectivityState[connectionStatus]
                                : 'unable to get connection status'}`);
                        }
                        applyMiddlewareHandlers('onResponseStatus', reversedMiddlewareRequestHandlers, (h) => (s) => h.onResponseStatus(s), new middleware_1.MiddlewareStatus(status), (s) => next(s._grpcStatus));
                    },
                };
                applyMiddlewareHandlers('onRequestMetadata', middlewareRequestHandlers, (h) => (m) => h.onRequestMetadata(m), new middleware_1.MiddlewareMetadata(metadata), (m) => next(m._grpcMetadata, newListener));
            },
            // unfortunately grpc uses `any` in their type defs for these
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            sendMessage: function (message, next) {
                applyMiddlewareHandlers('onRequestBody', middlewareRequestHandlers, (h) => (request) => h.onRequestBody(request), new middleware_1.MiddlewareMessage(message), (m) => next(m._grpcMessage));
            },
        };
        return new grpc_js_1.InterceptingCall(nextCall(options), requester);
    };
}
exports.middlewaresInterceptor = middlewaresInterceptor;
function applyMiddlewareHandlers(name, handlers, middlewareHandlerReduceFn, originalInput, nextFn) {
    let remainingHandlers = handlers;
    let middlewarePromise = Promise.resolve(originalInput);
    while (remainingHandlers.length > 0) {
        const nextHandler = middlewareHandlerReduceFn(remainingHandlers[0]);
        middlewarePromise = middlewarePromise
            .then(newT => nextHandler(newT))
            .catch(e => {
            throw e;
        });
        remainingHandlers = remainingHandlers.slice(1);
    }
    middlewarePromise
        .then(newT => nextFn(newT))
        .catch(e => {
        throw e;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZXMtaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvaW50ZXJuYWwvZ3JwYy9taWRkbGV3YXJlcy1pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FRdUI7QUFFdkIsbUVBTzRDO0FBSTVDLGlFQUF5RDtBQUN6RCxtRkFBNkU7QUFFN0UsU0FBZ0Isc0JBQXNCLENBQ3BDLGFBQW1DLEVBQ25DLFdBQXlCLEVBQ3pCLHdCQUF5RCxFQUN6RCxhQUE0QyxJQUFJO0lBRWhELE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUUzRCxPQUFPLENBQUMsT0FBMkIsRUFBRSxRQUFrQixFQUFFLEVBQUU7UUFDekQsTUFBTSx5QkFBeUIsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3BELENBQUMsQ0FBQyxZQUFZLENBQUMsd0JBQXdCLENBQUMsQ0FDekMsQ0FBQztRQUNGLDJHQUEyRztRQUMzRyx5Q0FBeUM7UUFDekMsTUFBTSxpQ0FBaUMsR0FBRztZQUN4QyxHQUFHLHlCQUF5QjtTQUM3QixDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRVosTUFBTSxTQUFTLEdBQWM7WUFDM0IsS0FBSyxFQUFFLFVBQ0wsUUFBa0IsRUFDbEIsUUFBa0IsRUFDbEIsSUFBc0Q7Z0JBRXRELE1BQU0sV0FBVyxHQUFhO29CQUM1QixpQkFBaUIsRUFBRSxVQUNqQixRQUFrQixFQUNsQixJQUFrQzt3QkFFbEMsdUJBQXVCLENBQ3JCLG9CQUFvQixFQUNwQixpQ0FBaUMsRUFDakMsQ0FBQyxDQUEyQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQXFCLEVBQUUsRUFBRSxDQUN6RCxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLEVBQ3pCLElBQUksK0JBQWtCLENBQUMsUUFBUSxDQUFDLEVBQ2hDLENBQUMsUUFB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LFFBQW9DLEVBQ3BDLHlCQUV5QixFQUN6QixhQUFnQixFQUNoQixNQUFzQjtJQUV0QixJQUFJLGlCQUFpQixHQUFHLFFBQVEsQ0FBQztJQUNqQyxJQUFJLGlCQUFpQixHQUFlLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkUsT0FBTyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ25DLE1BQU0sV0FBVyxHQUFHLHlCQUF5QixDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEUsaUJBQWlCLEdBQUcsaUJBQWlCO2FBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMvQixLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDVCxNQUFNLENBQUMsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUFDO1FBQ0wsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2hEO0lBRUQsaUJBQWlCO1NBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFCLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNULE1BQU0sQ0FBQyxDQUFDO0lBQ1YsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW50ZXJjZXB0aW5nQ2FsbCxcbiAgSW50ZXJjZXB0b3IsXG4gIEludGVyY2VwdG9yT3B0aW9ucyxcbiAgTGlzdGVuZXIsXG4gIE1ldGFkYXRhLFxuICBSZXF1ZXN0ZXIsXG4gIFN0YXR1c09iamVjdCxcbn0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge05leHRDYWxsfSBmcm9tICdAZ3JwYy9ncnBjLWpzL2J1aWxkL3NyYy9jbGllbnQtaW50ZXJjZXB0b3JzJztcbmltcG9ydCB7XG4gIE1pZGRsZXdhcmUsXG4gIE1pZGRsZXdhcmVNZXNzYWdlLFxuICBNaWRkbGV3YXJlTWV0YWRhdGEsXG4gIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcixcbiAgTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dCxcbiAgTWlkZGxld2FyZVN0YXR1cyxcbn0gZnJvbSAnLi4vLi4vY29uZmlnL21pZGRsZXdhcmUvbWlkZGxld2FyZSc7XG5pbXBvcnQge01lc3NhZ2V9IGZyb20gJ2dvb2dsZS1wcm90b2J1Zic7XG5pbXBvcnQge01vbWVudG9Mb2dnZXJGYWN0b3J5fSBmcm9tICcuLi8uLi8nO1xuaW1wb3J0IHtjYWNoZV9jbGllbnR9IGZyb20gJ0Bnb21vbWVudG8vZ2VuZXJhdGVkLXR5cGVzL2Rpc3QvY2FjaGVjbGllbnQnO1xuaW1wb3J0IHtTdGF0dXN9IGZyb20gJ0BncnBjL2dycGMtanMvYnVpbGQvc3JjL2NvbnN0YW50cyc7XG5pbXBvcnQge0Nvbm5lY3Rpdml0eVN0YXRlfSBmcm9tICdAZ3JwYy9ncnBjLWpzL2J1aWxkL3NyYy9jb25uZWN0aXZpdHktc3RhdGUnO1xuXG5leHBvcnQgZnVuY3Rpb24gbWlkZGxld2FyZXNJbnRlcmNlcHRvcihcbiAgbG9nZ2VyRmFjdG9yeTogTW9tZW50b0xvZ2dlckZhY3RvcnksXG4gIG1pZGRsZXdhcmVzOiBNaWRkbGV3YXJlW10sXG4gIG1pZGRsZXdhcmVSZXF1ZXN0Q29udGV4dDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dCxcbiAgZ3JwY0NsaWVudDogY2FjaGVfY2xpZW50LlNjc0NsaWVudCB8IG51bGwgPSBudWxsXG4pOiBJbnRlcmNlcHRvciB7XG4gIGNvbnN0IGxvZ2dlciA9IGxvZ2dlckZhY3RvcnkuZ2V0TG9nZ2VyKCdncnBjLWludGVyY2VwdG9yJyk7XG5cbiAgcmV0dXJuIChvcHRpb25zOiBJbnRlcmNlcHRvck9wdGlvbnMsIG5leHRDYWxsOiBOZXh0Q2FsbCkgPT4ge1xuICAgIGNvbnN0IG1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMgPSBtaWRkbGV3YXJlcy5tYXAobSA9PlxuICAgICAgbS5vbk5ld1JlcXVlc3QobWlkZGxld2FyZVJlcXVlc3RDb250ZXh0KVxuICAgICk7XG4gICAgLy8gY3JlYXRlIGEgY29weSBvZiB0aGUgaGFuZGxlcnMgYW5kIHJldmVyc2UgaXQsIGJlY2F1c2UgZm9yIHRoZSByZXNwb25zZSBsaWZlIGN5Y2xlIGFjdGlvbnMgd2Ugc2hvdWxkIGNhbGxcbiAgICAvLyB0aGUgbWlkZGxld2FyZXMgaW4gdGhlIG9wcG9zaXRlIG9yZGVyLlxuICAgIGNvbnN0IHJldmVyc2VkTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyA9IFtcbiAgICAgIC4uLm1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgXS5yZXZlcnNlKCk7XG5cbiAgICBjb25zdCByZXF1ZXN0ZXI6IFJlcXVlc3RlciA9IHtcbiAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoXG4gICAgICAgIG1ldGFkYXRhOiBNZXRhZGF0YSxcbiAgICAgICAgbGlzdGVuZXI6IExpc3RlbmVyLFxuICAgICAgICBuZXh0OiAobWV0YWRhdGE6IE1ldGFkYXRhLCBsaXN0ZW5lcjogTGlzdGVuZXIpID0+IHZvaWRcbiAgICAgICk6IHZvaWQge1xuICAgICAgICBjb25zdCBuZXdMaXN0ZW5lcjogTGlzdGVuZXIgPSB7XG4gICAgICAgICAgb25SZWNlaXZlTWV0YWRhdGE6IGZ1bmN0aW9uIChcbiAgICAgICAgICAgIG1ldGFkYXRhOiBNZXRhZGF0YSxcbiAgICAgICAgICAgIG5leHQ6IChtZXRhZGF0YTogTWV0YWRhdGEpID0+IHZvaWRcbiAgICAgICAgICApOiB2b2lkIHtcbiAgICAgICAgICAgIGFwcGx5TWlkZGxld2FyZUhhbmRsZXJzKFxuICAgICAgICAgICAgICAnb25SZXNwb25zZU1ldGFkYXRhJyxcbiAgICAgICAgICAgICAgcmV2ZXJzZWRNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJzLFxuICAgICAgICAgICAgICAoaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKSA9PiAobTogTWlkZGxld2FyZU1ldGFkYXRhKSA9PlxuICAgICAgICAgICAgICAgIGgub25SZXNwb25zZU1ldGFkYXRhKG0pLFxuICAgICAgICAgICAgICBuZXcgTWlkZGxld2FyZU1ldGFkYXRhKG1ldGFkYXRhKSxcbiAgICAgICAgICAgICAgKG1ldGFkYXRhOiBNaWRkbGV3YXJlTWV0YWRhdGEpID0+IG5leHQobWV0YWRhdGEuX2dycGNNZXRhZGF0YSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBvblJlY2VpdmVNZXNzYWdlOiBmdW5jdGlvbiAoXG4gICAgICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5IGdycGMgdXNlcyBgYW55YCBpbiB0aGVpciB0eXBlIGRlZnMgZm9yIHRoZXNlXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICAgICAgbWVzc2FnZTogYW55LFxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgICAgICAgIG5leHQ6IChtZXNzYWdlOiBhbnkpID0+IHZvaWRcbiAgICAgICAgICApOiB2b2lkIHtcbiAgICAgICAgICAgIGFwcGx5TWlkZGxld2FyZUhhbmRsZXJzKFxuICAgICAgICAgICAgICAnb25SZXNwb25zZUJvZHknLFxuICAgICAgICAgICAgICByZXZlcnNlZE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgICAgIChoOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIpID0+XG4gICAgICAgICAgICAgICAgKHJlcXVlc3Q6IE1pZGRsZXdhcmVNZXNzYWdlIHwgbnVsbCkgPT5cbiAgICAgICAgICAgICAgICAgIGgub25SZXNwb25zZUJvZHkocmVxdWVzdCksXG4gICAgICAgICAgICAgIG5ldyBNaWRkbGV3YXJlTWVzc2FnZShtZXNzYWdlIGFzIE1lc3NhZ2UpLFxuICAgICAgICAgICAgICAobXNnOiBNaWRkbGV3YXJlTWVzc2FnZSB8IG51bGwpID0+IG5leHQobXNnPy5fZ3JwY01lc3NhZ2UpXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgb25SZWNlaXZlU3RhdHVzOiBmdW5jdGlvbiAoXG4gICAgICAgICAgICBzdGF0dXM6IFN0YXR1c09iamVjdCxcbiAgICAgICAgICAgIG5leHQ6IChzdGF0dXM6IFN0YXR1c09iamVjdCkgPT4gdm9pZFxuICAgICAgICAgICk6IHZvaWQge1xuICAgICAgICAgICAgaWYgKHN0YXR1cy5jb2RlID09PSBTdGF0dXMuREVBRExJTkVfRVhDRUVERUQpIHtcbiAgICAgICAgICAgICAgLy8gZ2V0Q29ubmVjdGl2aXR5U3RhdGUodHJ1ZSkgd2lsbCByZXR1cm4gc3RhdGUgb2YgY29ubmVjdGlvbiBhbmRcbiAgICAgICAgICAgICAgLy8gYWxzbyB0cnkgdG8gY29ubmVjdCBpZiBpdCdzIGlkbGUsIGZhbHNlIHdpbGwganVzdCBnZXQgdGhlIHN0YXR1c1xuICAgICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uU3RhdHVzID1cbiAgICAgICAgICAgICAgICBncnBjQ2xpZW50Py5nZXRDaGFubmVsKCk/LmdldENvbm5lY3Rpdml0eVN0YXRlKGZhbHNlKSA/PyBudWxsO1xuICAgICAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICAgICBgRGVhZGxpbmUgRXhjZWVkZWQhIFJlY2VpdmVkIHN0YXR1czogJHtzdGF0dXMuY29kZX0gJHtcbiAgICAgICAgICAgICAgICAgIHN0YXR1cy5kZXRhaWxzXG4gICAgICAgICAgICAgICAgfSBhbmQgZ3JwYyBjb25uZWN0aW9uIHN0YXR1czogJHtcbiAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0dXNcbiAgICAgICAgICAgICAgICAgICAgPyBDb25uZWN0aXZpdHlTdGF0ZVtjb25uZWN0aW9uU3RhdHVzXVxuICAgICAgICAgICAgICAgICAgICA6ICd1bmFibGUgdG8gZ2V0IGNvbm5lY3Rpb24gc3RhdHVzJ1xuICAgICAgICAgICAgICAgIH1gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAgICAgJ29uUmVzcG9uc2VTdGF0dXMnLFxuICAgICAgICAgICAgICByZXZlcnNlZE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgICAgIChoOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIpID0+IChzOiBNaWRkbGV3YXJlU3RhdHVzKSA9PlxuICAgICAgICAgICAgICAgIGgub25SZXNwb25zZVN0YXR1cyhzKSxcbiAgICAgICAgICAgICAgbmV3IE1pZGRsZXdhcmVTdGF0dXMoc3RhdHVzKSxcbiAgICAgICAgICAgICAgKHM6IE1pZGRsZXdhcmVTdGF0dXMpID0+IG5leHQocy5fZ3JwY1N0YXR1cylcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAnb25SZXF1ZXN0TWV0YWRhdGEnLFxuICAgICAgICAgIG1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgKGg6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcikgPT4gKG06IE1pZGRsZXdhcmVNZXRhZGF0YSkgPT5cbiAgICAgICAgICAgIGgub25SZXF1ZXN0TWV0YWRhdGEobSksXG4gICAgICAgICAgbmV3IE1pZGRsZXdhcmVNZXRhZGF0YShtZXRhZGF0YSksXG4gICAgICAgICAgKG06IE1pZGRsZXdhcmVNZXRhZGF0YSkgPT4gbmV4dChtLl9ncnBjTWV0YWRhdGEsIG5ld0xpc3RlbmVyKVxuICAgICAgICApO1xuICAgICAgfSxcbiAgICAgIC8vIHVuZm9ydHVuYXRlbHkgZ3JwYyB1c2VzIGBhbnlgIGluIHRoZWlyIHR5cGUgZGVmcyBmb3IgdGhlc2VcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICBzZW5kTWVzc2FnZTogZnVuY3Rpb24gKG1lc3NhZ2U6IGFueSwgbmV4dDogKG1lc3NhZ2U6IGFueSkgPT4gdm9pZCk6IHZvaWQge1xuICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAnb25SZXF1ZXN0Qm9keScsXG4gICAgICAgICAgbWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAoaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKSA9PiAocmVxdWVzdDogTWlkZGxld2FyZU1lc3NhZ2UpID0+XG4gICAgICAgICAgICBoLm9uUmVxdWVzdEJvZHkocmVxdWVzdCksXG4gICAgICAgICAgbmV3IE1pZGRsZXdhcmVNZXNzYWdlKG1lc3NhZ2UgYXMgTWVzc2FnZSksXG4gICAgICAgICAgKG06IE1pZGRsZXdhcmVNZXNzYWdlKSA9PiBuZXh0KG0uX2dycGNNZXNzYWdlKVxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9O1xuICAgIHJldHVybiBuZXcgSW50ZXJjZXB0aW5nQ2FsbChuZXh0Q2FsbChvcHRpb25zKSwgcmVxdWVzdGVyKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gYXBwbHlNaWRkbGV3YXJlSGFuZGxlcnM8VD4oXG4gIG5hbWU6IHN0cmluZyxcbiAgaGFuZGxlcnM6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcltdLFxuICBtaWRkbGV3YXJlSGFuZGxlclJlZHVjZUZuOiAoXG4gICAgaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyXG4gICkgPT4gKHQ6IFQpID0+IFByb21pc2U8VD4sXG4gIG9yaWdpbmFsSW5wdXQ6IFQsXG4gIG5leHRGbjogKHQ6IFQpID0+IHZvaWRcbikge1xuICBsZXQgcmVtYWluaW5nSGFuZGxlcnMgPSBoYW5kbGVycztcbiAgbGV0IG1pZGRsZXdhcmVQcm9taXNlOiBQcm9taXNlPFQ+ID0gUHJvbWlzZS5yZXNvbHZlKG9yaWdpbmFsSW5wdXQpO1xuICB3aGlsZSAocmVtYWluaW5nSGFuZGxlcnMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IG5leHRIYW5kbGVyID0gbWlkZGxld2FyZUhhbmRsZXJSZWR1Y2VGbihyZW1haW5pbmdIYW5kbGVyc1swXSk7XG4gICAgbWlkZGxld2FyZVByb21pc2UgPSBtaWRkbGV3YXJlUHJvbWlzZVxuICAgICAgLnRoZW4obmV3VCA9PiBuZXh0SGFuZGxlcihuZXdUKSlcbiAgICAgIC5jYXRjaChlID0+IHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH0pO1xuICAgIHJlbWFpbmluZ0hhbmRsZXJzID0gcmVtYWluaW5nSGFuZGxlcnMuc2xpY2UoMSk7XG4gIH1cblxuICBtaWRkbGV3YXJlUHJvbWlzZVxuICAgIC50aGVuKG5ld1QgPT4gbmV4dEZuKG5ld1QpKVxuICAgIC5jYXRjaChlID0+IHtcbiAgICAgIHRocm93IGU7XG4gICAgfSk7XG59XG4iXX0=