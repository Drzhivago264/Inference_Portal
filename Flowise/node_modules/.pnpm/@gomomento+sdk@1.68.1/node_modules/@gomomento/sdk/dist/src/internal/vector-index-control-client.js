"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VectorIndexControlClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const __1 = require("..");
const package_json_1 = require("../../package.json");
const idle_grpc_client_wrapper_1 = require("./grpc/idle-grpc-client-wrapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const errors_1 = require("@gomomento/sdk-core/dist/src/errors");
const sdk_core_1 = require("@gomomento/sdk-core");
const clients_1 = require("@gomomento/sdk-core/dist/src/internal/clients");
var grpcControl = generated_types_1.control.control_client;
class VectorIndexControlClient {
    /**
     * @param {ControlClientProps} props
     */
    constructor(props) {
        this.logger = props.configuration.getLoggerFactory().getLogger(this);
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(props.configuration.getThrowOnErrors());
        const headers = [
            new headers_interceptor_1.Header('Authorization', props.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        this.interceptors = [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(VectorIndexControlClient.REQUEST_TIMEOUT_MS),
        ];
        this.logger.debug(`Creating control client using endpoint: '${props.credentialProvider.getControlEndpoint()}`);
        this.clientWrapper = new idle_grpc_client_wrapper_1.IdleGrpcClientWrapper({
            clientFactoryFn: () => new grpcControl.ScsControlClient(props.credentialProvider.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl()),
            loggerFactory: props.configuration.getLoggerFactory(),
            maxIdleMillis: props.configuration
                .getTransportStrategy()
                .getMaxIdleMillis(),
        });
    }
    async createIndex(indexName, numDimensions, similarityMetric) {
        try {
            (0, utils_1.validateIndexName)(indexName);
            (0, utils_1.validateNumDimensions)(numDimensions);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.CreateVectorIndex.Error(err));
        }
        this.logger.debug("Issuing 'createIndex' request");
        const request = new grpcControl._CreateIndexRequest();
        request.index_name = indexName;
        request.num_dimensions = numDimensions;
        similarityMetric !== null && similarityMetric !== void 0 ? similarityMetric : (similarityMetric = clients_1.VectorSimilarityMetric.COSINE_SIMILARITY);
        const similarityMetricPb = new grpcControl._SimilarityMetric();
        switch (similarityMetric) {
            case clients_1.VectorSimilarityMetric.INNER_PRODUCT:
                similarityMetricPb.inner_product =
                    new grpcControl._SimilarityMetric._InnerProduct();
                break;
            case clients_1.VectorSimilarityMetric.EUCLIDEAN_SIMILARITY:
                similarityMetricPb.euclidean_similarity =
                    new grpcControl._SimilarityMetric._EuclideanSimilarity();
                break;
            case clients_1.VectorSimilarityMetric.COSINE_SIMILARITY:
                similarityMetricPb.cosine_similarity =
                    new grpcControl._SimilarityMetric._CosineSimilarity();
                break;
            default:
                this.cacheServiceErrorMapper.returnOrThrowError(new __1.InvalidArgumentError(`Invalid similarity metric: ${similarityMetric}`), err => new sdk_core_1.CreateVectorIndex.Error(err));
        }
        request.similarity_metric = similarityMetricPb;
        return await new Promise((resolve, reject) => {
            this.clientWrapper.getClient().CreateIndex(request, { interceptors: this.interceptors }, 
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            (err, resp) => {
                if (err) {
                    if (err.code === constants_1.Status.ALREADY_EXISTS) {
                        resolve(new sdk_core_1.CreateVectorIndex.AlreadyExists());
                    }
                    else {
                        this.cacheServiceErrorMapper.resolveOrRejectError({
                            err: err,
                            errorResponseFactoryFn: e => new sdk_core_1.CreateVectorIndex.Error(e),
                            resolveFn: resolve,
                            rejectFn: reject,
                        });
                    }
                }
                else {
                    resolve(new sdk_core_1.CreateVectorIndex.Success());
                }
            });
        });
    }
    async listIndexes() {
        const request = new grpcControl._ListIndexesRequest();
        this.logger.debug("Issuing 'listIndexes' request");
        return await new Promise((resolve, reject) => {
            this.clientWrapper
                .getClient()
                .ListIndexes(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    // TODO: `Argument of type 'unknown' is not assignable to parameter of type 'Error'.`
                    //  I don't see how this is different from the other methods here. So, yeah, what?
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.ListVectorIndexes.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    const indexes = resp.indexes.map(index => {
                        let similarityMetric = clients_1.VectorSimilarityMetric.COSINE_SIMILARITY;
                        switch (index.similarity_metric.similarity_metric) {
                            case 'inner_product':
                                similarityMetric = clients_1.VectorSimilarityMetric.INNER_PRODUCT;
                                break;
                            case 'euclidean_similarity':
                                similarityMetric =
                                    clients_1.VectorSimilarityMetric.EUCLIDEAN_SIMILARITY;
                                break;
                            case 'cosine_similarity':
                                similarityMetric = clients_1.VectorSimilarityMetric.COSINE_SIMILARITY;
                                break;
                            default:
                                resolve(new sdk_core_1.ListVectorIndexes.Error(new errors_1.UnknownError(`Unknown similarity metric: ${index.similarity_metric.similarity_metric}`)));
                                break;
                        }
                        return new __1.VectorIndexInfo(index.index_name, index.num_dimensions, similarityMetric);
                    });
                    resolve(new sdk_core_1.ListVectorIndexes.Success(indexes));
                }
            });
        });
    }
    async deleteIndex(name) {
        try {
            (0, utils_1.validateIndexName)(name);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.DeleteVectorIndex.Error(err));
        }
        const request = new grpcControl._DeleteIndexRequest({
            index_name: name,
        });
        this.logger.info(`Deleting index: ${name}`);
        return await new Promise((resolve, reject) => {
            this.clientWrapper.getClient().DeleteIndex(request, { interceptors: this.interceptors }, 
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            (err, resp) => {
                if (err) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.DeleteVectorIndex.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.DeleteVectorIndex.Success());
                }
            });
        });
    }
}
exports.VectorIndexControlClient = VectorIndexControlClient;
VectorIndexControlClient.REQUEST_TIMEOUT_MS = 60 * 1000;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVjdG9yLWluZGV4LWNvbnRyb2wtY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ludGVybmFsL3ZlY3Rvci1pbmRleC1jb250cm9sLWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxnRUFBbUQ7QUFDbkQsb0VBQTZFO0FBQzdFLGtGQUEyRTtBQUMzRSxpRUFBeUQ7QUFDekQscUZBQTZFO0FBQzdFLDJDQUE4RDtBQUM5RCwwQkFNWTtBQUNaLHFEQUEyQztBQUMzQyw4RUFBc0U7QUFFdEUsdUVBR3FEO0FBQ3JELGdFQUFpRTtBQUNqRSxrREFJNkI7QUFDN0IsMkVBR3VEO0FBQ3ZELElBQU8sV0FBVyxHQUFHLHlCQUFPLENBQUMsY0FBYyxDQUFDO0FBTzVDLE1BQWEsd0JBQXdCO0lBT25DOztPQUVHO0lBQ0gsWUFBWSxLQUF5QjtRQUNuQyxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksb0RBQXVCLENBQ3hELEtBQUssQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FDdkMsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsSUFBSSw0QkFBTSxDQUFDLGVBQWUsRUFBRSxLQUFLLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEUsSUFBSSw0QkFBTSxDQUFDLE9BQU8sRUFBRSxVQUFVLHNCQUFPLEVBQUUsQ0FBQztTQUN6QyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFlBQVksR0FBRztZQUNsQixJQUFJLCtDQUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDLHdCQUF3QixFQUFFO1lBQ2pFLElBQUEscURBQXdCLEVBQUMsd0JBQXdCLENBQUMsa0JBQWtCLENBQUM7U0FDdEUsQ0FBQztRQUNGLElBQUksQ0FBQyxNQUFNLENB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QyxDQUFDO0lBQ0wsQ0FBQzs7QUF4TUgsNERBeU1DO0FBdE15QiwyQ0FBa0IsR0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtjb250cm9sfSBmcm9tICdAZ29tb21lbnRvL2dlbmVyYXRlZC10eXBlcyc7XG5pbXBvcnQge0hlYWRlciwgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcn0gZnJvbSAnLi9ncnBjL2hlYWRlcnMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9jbGllbnQtdGltZW91dC1pbnRlcmNlcHRvcic7XG5pbXBvcnQge1N0YXR1c30gZnJvbSAnQGdycGMvZ3JwYy1qcy9idWlsZC9zcmMvY29uc3RhbnRzJztcbmltcG9ydCB7Q2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXJ9IGZyb20gJy4uL2Vycm9ycy9jYWNoZS1zZXJ2aWNlLWVycm9yLW1hcHBlcic7XG5pbXBvcnQge0NoYW5uZWxDcmVkZW50aWFscywgSW50ZXJjZXB0b3J9IGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0IHtcbiAgQ3JlZGVudGlhbFByb3ZpZGVyLFxuICBJbnZhbGlkQXJndW1lbnRFcnJvcixcbiAgTW9tZW50b0xvZ2dlcixcbiAgVmVjdG9ySW5kZXhDb25maWd1cmF0aW9uLFxuICBWZWN0b3JJbmRleEluZm8sXG59IGZyb20gJy4uJztcbmltcG9ydCB7dmVyc2lvbn0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7SWRsZUdycGNDbGllbnRXcmFwcGVyfSBmcm9tICcuL2dycGMvaWRsZS1ncnBjLWNsaWVudC13cmFwcGVyJztcbmltcG9ydCB7R3JwY0NsaWVudFdyYXBwZXJ9IGZyb20gJy4vZ3JwYy9ncnBjLWNsaWVudC13cmFwcGVyJztcbmltcG9ydCB7XG4gIHZhbGlkYXRlSW5kZXhOYW1lLFxuICB2YWxpZGF0ZU51bURpbWVuc2lvbnMsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHtVbmtub3duRXJyb3J9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvZXJyb3JzJztcbmltcG9ydCB7XG4gIENyZWF0ZVZlY3RvckluZGV4LFxuICBEZWxldGVWZWN0b3JJbmRleCxcbiAgTGlzdFZlY3RvckluZGV4ZXMsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtcbiAgSVZlY3RvckluZGV4Q29udHJvbENsaWVudCxcbiAgVmVjdG9yU2ltaWxhcml0eU1ldHJpYyxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzJztcbmltcG9ydCBncnBjQ29udHJvbCA9IGNvbnRyb2wuY29udHJvbF9jbGllbnQ7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udHJvbENsaWVudFByb3BzIHtcbiAgY29uZmlndXJhdGlvbjogVmVjdG9ySW5kZXhDb25maWd1cmF0aW9uO1xuICBjcmVkZW50aWFsUHJvdmlkZXI6IENyZWRlbnRpYWxQcm92aWRlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFZlY3RvckluZGV4Q29udHJvbENsaWVudCBpbXBsZW1lbnRzIElWZWN0b3JJbmRleENvbnRyb2xDbGllbnQge1xuICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudFdyYXBwZXI6IEdycGNDbGllbnRXcmFwcGVyPGdycGNDb250cm9sLlNjc0NvbnRyb2xDbGllbnQ+O1xuICBwcml2YXRlIHJlYWRvbmx5IGludGVyY2VwdG9yczogSW50ZXJjZXB0b3JbXTtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgUkVRVUVTVF9USU1FT1VUX01TOiBudW1iZXIgPSA2MCAqIDEwMDA7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiBNb21lbnRvTG9nZ2VyO1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlU2VydmljZUVycm9yTWFwcGVyOiBDYWNoZVNlcnZpY2VFcnJvck1hcHBlcjtcblxuICAvKipcbiAgICogQHBhcmFtIHtDb250cm9sQ2xpZW50UHJvcHN9IHByb3BzXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogQ29udHJvbENsaWVudFByb3BzKSB7XG4gICAgdGhpcy5sb2dnZXIgPSBwcm9wcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIodGhpcyk7XG4gICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlciA9IG5ldyBDYWNoZVNlcnZpY2VFcnJvck1hcHBlcihcbiAgICAgIHByb3BzLmNvbmZpZ3VyYXRpb24uZ2V0VGhyb3dPbkVycm9ycygpXG4gICAgKTtcbiAgICBjb25zdCBoZWFkZXJzID0gW1xuICAgICAgbmV3IEhlYWRlcignQXV0aG9yaXphdGlvbicsIHByb3BzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRBdXRoVG9rZW4oKSksXG4gICAgICBuZXcgSGVhZGVyKCdBZ2VudCcsIGBub2RlanM6JHt2ZXJzaW9ufWApLFxuICAgIF07XG4gICAgdGhpcy5pbnRlcmNlcHRvcnMgPSBbXG4gICAgICBuZXcgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcihoZWFkZXJzKS5jcmVhdGVIZWFkZXJzSW50ZXJjZXB0b3IoKSxcbiAgICAgIENsaWVudFRpbWVvdXRJbnRlcmNlcHRvcihWZWN0b3JJbmRleENvbnRyb2xDbGllbnQuUkVRVUVTVF9USU1FT1VUX01TKSxcbiAgICBdO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIGNvbnRyb2wgY2xpZW50IHVzaW5nIGVuZHBvaW50OiAnJHtwcm9wcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q29udHJvbEVuZHBvaW50KCl9YFxuICAgICk7XG4gICAgdGhpcy5jbGllbnRXcmFwcGVyID0gbmV3IElkbGVHcnBjQ2xpZW50V3JhcHBlcih7XG4gICAgICBjbGllbnRGYWN0b3J5Rm46ICgpID0+XG4gICAgICAgIG5ldyBncnBjQ29udHJvbC5TY3NDb250cm9sQ2xpZW50KFxuICAgICAgICAgIHByb3BzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRDb250cm9sRW5kcG9pbnQoKSxcbiAgICAgICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICAgICAgKSxcbiAgICAgIGxvZ2dlckZhY3Rvcnk6IHByb3BzLmNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLFxuICAgICAgbWF4SWRsZU1pbGxpczogcHJvcHMuY29uZmlndXJhdGlvblxuICAgICAgICAuZ2V0VHJhbnNwb3J0U3RyYXRlZ3koKVxuICAgICAgICAuZ2V0TWF4SWRsZU1pbGxpcygpLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZUluZGV4KFxuICAgIGluZGV4TmFtZTogc3RyaW5nLFxuICAgIG51bURpbWVuc2lvbnM6IG51bWJlcixcbiAgICBzaW1pbGFyaXR5TWV0cmljPzogVmVjdG9yU2ltaWxhcml0eU1ldHJpY1xuICApOiBQcm9taXNlPENyZWF0ZVZlY3RvckluZGV4LlJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlSW5kZXhOYW1lKGluZGV4TmFtZSk7XG4gICAgICB2YWxpZGF0ZU51bURpbWVuc2lvbnMobnVtRGltZW5zaW9ucyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBDcmVhdGVWZWN0b3JJbmRleC5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcIklzc3VpbmcgJ2NyZWF0ZUluZGV4JyByZXF1ZXN0XCIpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0NvbnRyb2wuX0NyZWF0ZUluZGV4UmVxdWVzdCgpO1xuICAgIHJlcXVlc3QuaW5kZXhfbmFtZSA9IGluZGV4TmFtZTtcbiAgICByZXF1ZXN0Lm51bV9kaW1lbnNpb25zID0gbnVtRGltZW5zaW9ucztcblxuICAgIHNpbWlsYXJpdHlNZXRyaWMgPz89IFZlY3RvclNpbWlsYXJpdHlNZXRyaWMuQ09TSU5FX1NJTUlMQVJJVFk7XG5cbiAgICBjb25zdCBzaW1pbGFyaXR5TWV0cmljUGIgPSBuZXcgZ3JwY0NvbnRyb2wuX1NpbWlsYXJpdHlNZXRyaWMoKTtcbiAgICBzd2l0Y2ggKHNpbWlsYXJpdHlNZXRyaWMpIHtcbiAgICAgIGNhc2UgVmVjdG9yU2ltaWxhcml0eU1ldHJpYy5JTk5FUl9QUk9EVUNUOlxuICAgICAgICBzaW1pbGFyaXR5TWV0cmljUGIuaW5uZXJfcHJvZHVjdCA9XG4gICAgICAgICAgbmV3IGdycGNDb250cm9sLl9TaW1pbGFyaXR5TWV0cmljLl9Jbm5lclByb2R1Y3QoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFZlY3RvclNpbWlsYXJpdHlNZXRyaWMuRVVDTElERUFOX1NJTUlMQVJJVFk6XG4gICAgICAgIHNpbWlsYXJpdHlNZXRyaWNQYi5ldWNsaWRlYW5fc2ltaWxhcml0eSA9XG4gICAgICAgICAgbmV3IGdycGNDb250cm9sLl9TaW1pbGFyaXR5TWV0cmljLl9FdWNsaWRlYW5TaW1pbGFyaXR5KCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBWZWN0b3JTaW1pbGFyaXR5TWV0cmljLkNPU0lORV9TSU1JTEFSSVRZOlxuICAgICAgICBzaW1pbGFyaXR5TWV0cmljUGIuY29zaW5lX3NpbWlsYXJpdHkgPVxuICAgICAgICAgIG5ldyBncnBjQ29udHJvbC5fU2ltaWxhcml0eU1ldHJpYy5fQ29zaW5lU2ltaWxhcml0eSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICAgIG5ldyBJbnZhbGlkQXJndW1lbnRFcnJvcihcbiAgICAgICAgICAgIGBJbnZhbGlkIHNpbWlsYXJpdHkgbWV0cmljOiAke1xuICAgICAgICAgICAgICBzaW1pbGFyaXR5TWV0cmljIGFzIHVua25vd24gYXMgc3RyaW5nXG4gICAgICAgICAgICB9YFxuICAgICAgICAgICksXG4gICAgICAgICAgZXJyID0+IG5ldyBDcmVhdGVWZWN0b3JJbmRleC5FcnJvcihlcnIpXG4gICAgICAgICk7XG4gICAgfVxuICAgIHJlcXVlc3Quc2ltaWxhcml0eV9tZXRyaWMgPSBzaW1pbGFyaXR5TWV0cmljUGI7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8Q3JlYXRlVmVjdG9ySW5kZXguUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50V3JhcHBlci5nZXRDbGllbnQoKS5DcmVhdGVJbmRleChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzXG4gICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09IFN0YXR1cy5BTFJFQURZX0VYSVNUUykge1xuICAgICAgICAgICAgICByZXNvbHZlKG5ldyBDcmVhdGVWZWN0b3JJbmRleC5BbHJlYWR5RXhpc3RzKCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXNvbHZlT3JSZWplY3RFcnJvcih7XG4gICAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgQ3JlYXRlVmVjdG9ySW5kZXguRXJyb3IoZSksXG4gICAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBDcmVhdGVWZWN0b3JJbmRleC5TdWNjZXNzKCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0SW5kZXhlcygpOiBQcm9taXNlPExpc3RWZWN0b3JJbmRleGVzLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQ29udHJvbC5fTGlzdEluZGV4ZXNSZXF1ZXN0KCk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXCJJc3N1aW5nICdsaXN0SW5kZXhlcycgcmVxdWVzdFwiKTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8TGlzdFZlY3RvckluZGV4ZXMuUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50V3JhcHBlclxuICAgICAgICAuZ2V0Q2xpZW50KClcbiAgICAgICAgLkxpc3RJbmRleGVzKFxuICAgICAgICAgIHJlcXVlc3QsXG4gICAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgICAgLy8gVE9ETzogYEFyZ3VtZW50IG9mIHR5cGUgJ3Vua25vd24nIGlzIG5vdCBhc3NpZ25hYmxlIHRvIHBhcmFtZXRlciBvZiB0eXBlICdFcnJvcicuYFxuICAgICAgICAgICAgICAvLyAgSSBkb24ndCBzZWUgaG93IHRoaXMgaXMgZGlmZmVyZW50IGZyb20gdGhlIG90aGVyIG1ldGhvZHMgaGVyZS4gU28sIHllYWgsIHdoYXQ/XG4gICAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IExpc3RWZWN0b3JJbmRleGVzLkVycm9yKGUpLFxuICAgICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IGluZGV4ZXMgPSByZXNwLmluZGV4ZXMubWFwKGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgc2ltaWxhcml0eU1ldHJpYzogVmVjdG9yU2ltaWxhcml0eU1ldHJpYyA9XG4gICAgICAgICAgICAgICAgICBWZWN0b3JTaW1pbGFyaXR5TWV0cmljLkNPU0lORV9TSU1JTEFSSVRZO1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoaW5kZXguc2ltaWxhcml0eV9tZXRyaWMuc2ltaWxhcml0eV9tZXRyaWMpIHtcbiAgICAgICAgICAgICAgICAgIGNhc2UgJ2lubmVyX3Byb2R1Y3QnOlxuICAgICAgICAgICAgICAgICAgICBzaW1pbGFyaXR5TWV0cmljID0gVmVjdG9yU2ltaWxhcml0eU1ldHJpYy5JTk5FUl9QUk9EVUNUO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgIGNhc2UgJ2V1Y2xpZGVhbl9zaW1pbGFyaXR5JzpcbiAgICAgICAgICAgICAgICAgICAgc2ltaWxhcml0eU1ldHJpYyA9XG4gICAgICAgICAgICAgICAgICAgICAgVmVjdG9yU2ltaWxhcml0eU1ldHJpYy5FVUNMSURFQU5fU0lNSUxBUklUWTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICBjYXNlICdjb3NpbmVfc2ltaWxhcml0eSc6XG4gICAgICAgICAgICAgICAgICAgIHNpbWlsYXJpdHlNZXRyaWMgPSBWZWN0b3JTaW1pbGFyaXR5TWV0cmljLkNPU0lORV9TSU1JTEFSSVRZO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgbmV3IExpc3RWZWN0b3JJbmRleGVzLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFVua25vd25FcnJvcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYFVua25vd24gc2ltaWxhcml0eSBtZXRyaWM6ICR7aW5kZXguc2ltaWxhcml0eV9tZXRyaWMuc2ltaWxhcml0eV9tZXRyaWN9YFxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVmVjdG9ySW5kZXhJbmZvKFxuICAgICAgICAgICAgICAgICAgaW5kZXguaW5kZXhfbmFtZSxcbiAgICAgICAgICAgICAgICAgIGluZGV4Lm51bV9kaW1lbnNpb25zLFxuICAgICAgICAgICAgICAgICAgc2ltaWxhcml0eU1ldHJpY1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICByZXNvbHZlKG5ldyBMaXN0VmVjdG9ySW5kZXhlcy5TdWNjZXNzKGluZGV4ZXMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlSW5kZXgobmFtZTogc3RyaW5nKTogUHJvbWlzZTxEZWxldGVWZWN0b3JJbmRleC5SZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUluZGV4TmFtZShuYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IERlbGV0ZVZlY3RvckluZGV4LkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0NvbnRyb2wuX0RlbGV0ZUluZGV4UmVxdWVzdCh7XG4gICAgICBpbmRleF9uYW1lOiBuYW1lLFxuICAgIH0pO1xuICAgIHRoaXMubG9nZ2VyLmluZm8oYERlbGV0aW5nIGluZGV4OiAke25hbWV9YCk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPERlbGV0ZVZlY3RvckluZGV4LlJlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudFdyYXBwZXIuZ2V0Q2xpZW50KCkuRGVsZXRlSW5kZXgoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFyc1xuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXNvbHZlT3JSZWplY3RFcnJvcih7XG4gICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICBlcnJvclJlc3BvbnNlRmFjdG9yeUZuOiBlID0+IG5ldyBEZWxldGVWZWN0b3JJbmRleC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IERlbGV0ZVZlY3RvckluZGV4LlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG4iXX0=