"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RetryInterceptor = exports.createRetryInterceptorIfEnabled = void 0;
// This is temporary work around defining our own interceptor to power re-try's
// Longer term with this proposal re-try's should be added to grpc core, and we
// can leverage by defining a retry policy.
// https://github.com/grpc/proposal/blob/master/A6-client-retries.md#grpc-retry-design
// For now we use re-try interceptor inspired by example here in interceptor proposal for nodejs grpc core
// https://github.com/grpc/proposal/blob/master/L5-node-client-interceptors.md#advanced-examples
// Main difference is that we maintain a allow list of retryable status codes vs trying all.
const grpc_js_1 = require("@grpc/grpc-js");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
function createRetryInterceptorIfEnabled(loggerFactory, retryStrategy) {
    return [
        new RetryInterceptor(loggerFactory, retryStrategy).createRetryInterceptor(),
    ];
}
exports.createRetryInterceptorIfEnabled = createRetryInterceptorIfEnabled;
class RetryInterceptor {
    constructor(loggerFactory, retryStrategy) {
        this.logger = loggerFactory.getLogger(this);
        this.retryStrategy = retryStrategy;
    }
    // TODO: We need to send retry count information to the server so that we
    // will have some visibility into how often this is happening to customers:
    // https://github.com/momentohq/client-sdk-nodejs/issues/80
    // TODO: we need to add backoff/jitter for the retries:
    // https://github.com/momentohq/client-sdk-nodejs/issues/81
    createRetryInterceptor() {
        const logger = this.logger;
        const retryStrategy = this.retryStrategy;
        return (options, nextCall) => {
            let savedMetadata;
            let savedSendMessage;
            let savedReceiveMessage;
            let savedMessageNext;
            return new grpc_js_1.InterceptingCall(nextCall(options), {
                start: function (metadata, listener, next) {
                    savedMetadata = metadata;
                    const newListener = {
                        onReceiveMessage: function (message, next) {
                            savedReceiveMessage = message;
                            savedMessageNext = next;
                        },
                        onReceiveStatus: function (status, 
                        // NOTE: we have to use `any` here because that is what is used in the grpc-js type definitions
                        // eslint-disable-next-line @typescript-eslint/no-explicit-any
                        next) {
                            let attempts = 1;
                            const retry = function (message, metadata) {
                                attempts++;
                                const newCall = nextCall(options);
                                newCall.start(metadata, {
                                    onReceiveMessage: function (message) {
                                        savedReceiveMessage = message;
                                    },
                                    onReceiveStatus: function (status) {
                                        const whenToRetry = retryStrategy.determineWhenToRetryRequest({
                                            grpcStatus: status,
                                            grpcRequest: options.method_definition,
                                            attemptNumber: attempts,
                                        });
                                        if (whenToRetry === null) {
                                            logger.debug(`Request not eligible for retry: path: ${options.method_definition.path}; retryable status code: ${status.code}; number of attempts (${attempts}).`);
                                            savedMessageNext(savedReceiveMessage);
                                            next(status);
                                        }
                                        else {
                                            logger.debug(`Request eligible for retry: path: ${options.method_definition.path}; response status code: ${status.code}; number of attempts (${attempts}); will retry in ${whenToRetry}ms`);
                                            setTimeout(() => retry(message, metadata), whenToRetry);
                                        }
                                    },
                                });
                                newCall.sendMessage(savedSendMessage);
                                newCall.halfClose();
                            };
                            if (status.code === constants_1.Status.OK) {
                                savedMessageNext(savedReceiveMessage);
                                next(status);
                            }
                            else {
                                const whenToRetry = retryStrategy.determineWhenToRetryRequest({
                                    grpcStatus: status,
                                    grpcRequest: options.method_definition,
                                    attemptNumber: attempts,
                                });
                                if (whenToRetry === null) {
                                    logger.debug(`Request not eligible for retry: path: ${options.method_definition.path}; response status code: ${status.code}.`);
                                    savedMessageNext(savedReceiveMessage);
                                    next(status);
                                }
                                else {
                                    logger.debug(`Request eligible for retry: path: ${options.method_definition.path}; response status code: ${status.code}; number of attempts (${attempts}); will retry in ${whenToRetry}ms`);
                                    setTimeout(() => retry(savedSendMessage, savedMetadata), whenToRetry);
                                }
                            }
                        },
                    };
                    next(metadata, newListener);
                },
                sendMessage: function (message, next) {
                    savedSendMessage = message;
                    next(message);
                },
            });
        };
    }
}
exports.RetryInterceptor = RetryInterceptor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV0cnktaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvaW50ZXJuYWwvZ3JwYy9yZXRyeS1pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrRUFBK0U7QUFDL0UsK0VBQStFO0FBQy9FLDJDQUEyQztBQUMzQyxzRkFBc0Y7QUFDdEYsMEdBQTBHO0FBQzFHLGdHQUFnRztBQUNoRyw0RkFBNEY7QUFDNUYsMkNBTXVCO0FBRXZCLGlFQUF5RDtBQUd6RCxTQUFnQiwrQkFBK0IsQ0FDN0MsYUFBbUMsRUFDbkMsYUFBNEI7SUFFNUIsT0FBTztRQUNMLElBQUksZ0JBQWdCLENBQUMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxDQUFDLHNCQUFzQixFQUFFO0tBQzVFLENBQUM7QUFDSixDQUFDO0FBUEQsMEVBT0M7QUFFRCxNQUFhLGdCQUFnQjtJQUkzQixZQUNFLGFBQW1DLEVBQ25DLGFBQTRCO1FBRTVCLElBQUksQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztJQUNyQyxDQUFDO0lBRUQseUVBQXlFO0lBQ3pFLDJFQUEyRTtJQUMzRSwyREFBMkQ7SUFDM0QsdURBQXVEO0lBQ3ZELDJEQUEyRDtJQUNwRCxzQkFBc0I7UUFDM0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUMzQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBRXpDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLEVBQUU7WUFDM0IsSUFBSSxhQUF1QixDQUFDO1lBQzVCLElBQUksZ0JBQXlCLENBQUM7WUFDOUIsSUFBSSxtQkFBNEIsQ0FBQztZQUNqQyxJQUFJLGdCQUF5QyxDQUFDO1lBQzlDLE9BQU8sSUFBSSwwQkFBZ0IsQ0FBQyxRQUFRLENBQUMsT0FBTyxD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QU0sQ0FBQyxJQUFJLHlCQUF5QixRQUFRLG9CQUFvQixXQUFXLElBQUksQ0FDOUssQ0FBQztvQ0FDRixVQUFVLENBQ1IsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLGFBQWEsQ0FBQyxFQUM1QyxXQUFXLENBQ1osQ0FBQztpQ0FDSDs2QkFDRjt3QkFDSCxDQUFDO3FCQUNGLENBQUM7b0JBQ0YsSUFBSSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDOUIsQ0FBQztnQkFDRCxXQUFXLEVBQUUsVUFBVSxPQUFPLEVBQUUsSUFBSTtvQkFDbEMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO29CQUMzQixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ2hCLENBQUM7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFqSEQsNENBaUhDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhpcyBpcyB0ZW1wb3Jhcnkgd29yayBhcm91bmQgZGVmaW5pbmcgb3VyIG93biBpbnRlcmNlcHRvciB0byBwb3dlciByZS10cnknc1xuLy8gTG9uZ2VyIHRlcm0gd2l0aCB0aGlzIHByb3Bvc2FsIHJlLXRyeSdzIHNob3VsZCBiZSBhZGRlZCB0byBncnBjIGNvcmUsIGFuZCB3ZVxuLy8gY2FuIGxldmVyYWdlIGJ5IGRlZmluaW5nIGEgcmV0cnkgcG9saWN5LlxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2dycGMvcHJvcG9zYWwvYmxvYi9tYXN0ZXIvQTYtY2xpZW50LXJldHJpZXMubWQjZ3JwYy1yZXRyeS1kZXNpZ25cbi8vIEZvciBub3cgd2UgdXNlIHJlLXRyeSBpbnRlcmNlcHRvciBpbnNwaXJlZCBieSBleGFtcGxlIGhlcmUgaW4gaW50ZXJjZXB0b3IgcHJvcG9zYWwgZm9yIG5vZGVqcyBncnBjIGNvcmVcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ncnBjL3Byb3Bvc2FsL2Jsb2IvbWFzdGVyL0w1LW5vZGUtY2xpZW50LWludGVyY2VwdG9ycy5tZCNhZHZhbmNlZC1leGFtcGxlc1xuLy8gTWFpbiBkaWZmZXJlbmNlIGlzIHRoYXQgd2UgbWFpbnRhaW4gYSBhbGxvdyBsaXN0IG9mIHJldHJ5YWJsZSBzdGF0dXMgY29kZXMgdnMgdHJ5aW5nIGFsbC5cbmltcG9ydCB7XG4gIEludGVyY2VwdGluZ0NhbGwsXG4gIEludGVyY2VwdG9yLFxuICBMaXN0ZW5lcixcbiAgTWV0YWRhdGEsXG4gIFN0YXR1c09iamVjdCxcbn0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge1JldHJ5U3RyYXRlZ3l9IGZyb20gJy4uLy4uL2NvbmZpZy9yZXRyeS9yZXRyeS1zdHJhdGVneSc7XG5pbXBvcnQge1N0YXR1c30gZnJvbSAnQGdycGMvZ3JwYy1qcy9idWlsZC9zcmMvY29uc3RhbnRzJztcbmltcG9ydCB7TW9tZW50b0xvZ2dlckZhY3RvcnksIE1vbWVudG9Mb2dnZXJ9IGZyb20gJy4uLy4uLyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZXRyeUludGVyY2VwdG9ySWZFbmFibGVkKFxuICBsb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgcmV0cnlTdHJhdGVneTogUmV0cnlTdHJhdGVneVxuKTogQXJyYXk8SW50ZXJjZXB0b3I+IHtcbiAgcmV0dXJuIFtcbiAgICBuZXcgUmV0cnlJbnRlcmNlcHRvcihsb2dnZXJGYWN0b3J5LCByZXRyeVN0cmF0ZWd5KS5jcmVhdGVSZXRyeUludGVyY2VwdG9yKCksXG4gIF07XG59XG5cbmV4cG9ydCBjbGFzcyBSZXRyeUludGVyY2VwdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmV0cnlTdHJhdGVneTogUmV0cnlTdHJhdGVneTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBsb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgICByZXRyeVN0cmF0ZWd5OiBSZXRyeVN0cmF0ZWd5XG4gICkge1xuICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyRmFjdG9yeS5nZXRMb2dnZXIodGhpcyk7XG4gICAgdGhpcy5yZXRyeVN0cmF0ZWd5ID0gcmV0cnlTdHJhdGVneTtcbiAgfVxuXG4gIC8vIFRPRE86IFdlIG5lZWQgdG8gc2VuZCByZXRyeSBjb3VudCBpbmZvcm1hdGlvbiB0byB0aGUgc2VydmVyIHNvIHRoYXQgd2VcbiAgLy8gd2lsbCBoYXZlIHNvbWUgdmlzaWJpbGl0eSBpbnRvIGhvdyBvZnRlbiB0aGlzIGlzIGhhcHBlbmluZyB0byBjdXN0b21lcnM6XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnRvaHEvY2xpZW50LXNkay1ub2RlanMvaXNzdWVzLzgwXG4gIC8vIFRPRE86IHdlIG5lZWQgdG8gYWRkIGJhY2tvZmYvaml0dGVyIGZvciB0aGUgcmV0cmllczpcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudG9ocS9jbGllbnQtc2RrLW5vZGVqcy9pc3N1ZXMvODFcbiAgcHVibGljIGNyZWF0ZVJldHJ5SW50ZXJjZXB0b3IoKTogSW50ZXJjZXB0b3Ige1xuICAgIGNvbnN0IGxvZ2dlciA9IHRoaXMubG9nZ2VyO1xuICAgIGNvbnN0IHJldHJ5U3RyYXRlZ3kgPSB0aGlzLnJldHJ5U3RyYXRlZ3k7XG5cbiAgICByZXR1cm4gKG9wdGlvbnMsIG5leHRDYWxsKSA9PiB7XG4gICAgICBsZXQgc2F2ZWRNZXRhZGF0YTogTWV0YWRhdGE7XG4gICAgICBsZXQgc2F2ZWRTZW5kTWVzc2FnZTogdW5rbm93bjtcbiAgICAgIGxldCBzYXZlZFJlY2VpdmVNZXNzYWdlOiB1bmtub3duO1xuICAgICAgbGV0IHNhdmVkTWVzc2FnZU5leHQ6IChhcmcwOiB1bmtub3duKSA9PiB2b2lkO1xuICAgICAgcmV0dXJuIG5ldyBJbnRlcmNlcHRpbmdDYWxsKG5leHRDYWxsKG9wdGlvbnMpLCB7XG4gICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAobWV0YWRhdGEsIGxpc3RlbmVyLCBuZXh0KSB7XG4gICAgICAgICAgc2F2ZWRNZXRhZGF0YSA9IG1ldGFkYXRhO1xuICAgICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyOiBMaXN0ZW5lciA9IHtcbiAgICAgICAgICAgIG9uUmVjZWl2ZU1lc3NhZ2U6IGZ1bmN0aW9uIChcbiAgICAgICAgICAgICAgbWVzc2FnZTogdW5rbm93bixcbiAgICAgICAgICAgICAgbmV4dDogKGFyZzA6IHVua25vd24pID0+IHZvaWRcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBzYXZlZFJlY2VpdmVNZXNzYWdlID0gbWVzc2FnZTtcbiAgICAgICAgICAgICAgc2F2ZWRNZXNzYWdlTmV4dCA9IG5leHQ7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25SZWNlaXZlU3RhdHVzOiBmdW5jdGlvbiAoXG4gICAgICAgICAgICAgIHN0YXR1czogU3RhdHVzT2JqZWN0LFxuICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBoYXZlIHRvIHVzZSBgYW55YCBoZXJlIGJlY2F1c2UgdGhhdCBpcyB3aGF0IGlzIHVzZWQgaW4gdGhlIGdycGMtanMgdHlwZSBkZWZpbml0aW9uc1xuICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICAgICAgICBuZXh0OiAoYXJnMDogYW55KSA9PiB2b2lkXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgbGV0IGF0dGVtcHRzID0gMTtcbiAgICAgICAgICAgICAgY29uc3QgcmV0cnkgPSBmdW5jdGlvbiAobWVzc2FnZTogdW5rbm93biwgbWV0YWRhdGE6IE1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgYXR0ZW1wdHMrKztcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdDYWxsID0gbmV4dENhbGwob3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgbmV3Q2FsbC5zdGFydChtZXRhZGF0YSwge1xuICAgICAgICAgICAgICAgICAgb25SZWNlaXZlTWVzc2FnZTogZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgc2F2ZWRSZWNlaXZlTWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgb25SZWNlaXZlU3RhdHVzOiBmdW5jdGlvbiAoc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHdoZW5Ub1JldHJ5ID1cbiAgICAgICAgICAgICAgICAgICAgICByZXRyeVN0cmF0ZWd5LmRldGVybWluZVdoZW5Ub1JldHJ5UmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBncnBjU3RhdHVzOiBzdGF0dXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBncnBjUmVxdWVzdDogb3B0aW9ucy5tZXRob2RfZGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIGF0dGVtcHROdW1iZXI6IGF0dGVtcHRzLFxuICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh3aGVuVG9SZXRyeSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgICAgICAgICAgICAgIGBSZXF1ZXN0IG5vdCBlbGlnaWJsZSBmb3IgcmV0cnk6IHBhdGg6ICR7b3B0aW9ucy5tZXRob2RfZGVmaW5pdGlvbi5wYXRofTsgcmV0cnlhYmxlIHN0YXR1cyBjb2RlOiAke3N0YXR1cy5jb2RlfTsgbnVtYmVyIG9mIGF0dGVtcHRzICgke2F0dGVtcHRzfSkuYFxuICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgc2F2ZWRNZXNzYWdlTmV4dChzYXZlZFJlY2VpdmVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICBuZXh0KHN0YXR1cyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgICAgICAgICAgICAgYFJlcXVlc3QgZWxpZ2libGUgZm9yIHJldHJ5OiBwYXRoOiAke29wdGlvbnMubWV0aG9kX2RlZmluaXRpb24ucGF0aH07IHJlc3BvbnNlIHN0YXR1cyBjb2RlOiAke3N0YXR1cy5jb2RlfTsgbnVtYmVyIG9mIGF0dGVtcHRzICgke2F0dGVtcHRzfSk7IHdpbGwgcmV0cnkgaW4gJHt3aGVuVG9SZXRyeX1tc2BcbiAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmV0cnkobWVzc2FnZSwgbWV0YWRhdGEpLCB3aGVuVG9SZXRyeSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbmV3Q2FsbC5zZW5kTWVzc2FnZShzYXZlZFNlbmRNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBuZXdDYWxsLmhhbGZDbG9zZSgpO1xuICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgIGlmIChzdGF0dXMuY29kZSA9PT0gU3RhdHVzLk9LKSB7XG4gICAgICAgICAgICAgICAgc2F2ZWRNZXNzYWdlTmV4dChzYXZlZFJlY2VpdmVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBuZXh0KHN0YXR1cyk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgd2hlblRvUmV0cnkgPSByZXRyeVN0cmF0ZWd5LmRldGVybWluZVdoZW5Ub1JldHJ5UmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICBncnBjU3RhdHVzOiBzdGF0dXMsXG4gICAgICAgICAgICAgICAgICBncnBjUmVxdWVzdDogb3B0aW9ucy5tZXRob2RfZGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgIGF0dGVtcHROdW1iZXI6IGF0dGVtcHRzLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmICh3aGVuVG9SZXRyeSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgICAgICAgICBgUmVxdWVzdCBub3QgZWxpZ2libGUgZm9yIHJldHJ5OiBwYXRoOiAke29wdGlvbnMubWV0aG9kX2RlZmluaXRpb24ucGF0aH07IHJlc3BvbnNlIHN0YXR1cyBjb2RlOiAke3N0YXR1cy5jb2RlfS5gXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgc2F2ZWRNZXNzYWdlTmV4dChzYXZlZFJlY2VpdmVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgIG5leHQoc3RhdHVzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgICAgICAgICBgUmVxdWVzdCBlbGlnaWJsZSBmb3IgcmV0cnk6IHBhdGg6ICR7b3B0aW9ucy5tZXRob2RfZGVmaW5pdGlvbi5wYXRofTsgcmVzcG9uc2Ugc3RhdHVzIGNvZGU6ICR7c3RhdHVzLmNvZGV9OyBudW1iZXIgb2YgYXR0ZW1wdHMgKCR7YXR0ZW1wdHN9KTsgd2lsbCByZXRyeSBpbiAke3doZW5Ub1JldHJ5fW1zYFxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHJldHJ5KHNhdmVkU2VuZE1lc3NhZ2UsIHNhdmVkTWV0YWRhdGEpLFxuICAgICAgICAgICAgICAgICAgICB3aGVuVG9SZXRyeVxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgICBuZXh0KG1ldGFkYXRhLCBuZXdMaXN0ZW5lcik7XG4gICAgICAgIH0sXG4gICAgICAgIHNlbmRNZXNzYWdlOiBmdW5jdGlvbiAobWVzc2FnZSwgbmV4dCkge1xuICAgICAgICAgIHNhdmVkU2VuZE1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgICAgIG5leHQobWVzc2FnZSk7XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9O1xuICB9XG59XG4iXX0=