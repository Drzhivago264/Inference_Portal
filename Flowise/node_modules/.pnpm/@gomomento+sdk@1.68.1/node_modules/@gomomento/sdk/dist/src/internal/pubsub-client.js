"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PubsubClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcPubsub = generated_types_1.pubsub.cache_client.pubsub;
// older versions of node don't have the global util variables https://github.com/nodejs/node/issues/20365
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
const package_json_1 = require("../../package.json");
const middlewares_interceptor_1 = require("./grpc/middlewares-interceptor");
const __1 = require("../");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractPubsubClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/pubsub/AbstractPubsubClient");
const grpc_channel_options_1 = require("./grpc/grpc-channel-options");
class PubsubClient extends AbstractPubsubClient_1.AbstractPubsubClient {
    /**
     * @param {TopicClientProps} props
     */
    constructor(props) {
        super();
        this.configuration = props.configuration;
        this.credentialProvider = props.credentialProvider;
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(this.configuration.getThrowOnErrors());
        this.unaryRequestTimeoutMs = PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS;
        this.logger.debug(`Creating topic client using endpoint: '${this.credentialProvider.getCacheEndpoint()}'`);
        // NOTE: This is hard-coded for now but we may want to expose it via TopicConfiguration in the
        // future, as we do with some of the other clients.
        const grpcConfig = new __1.StaticGrpcConfiguration({
            deadlineMillis: this.unaryRequestTimeoutMs,
            maxSessionMemoryMb: PubsubClient.DEFAULT_MAX_SESSION_MEMORY_MB,
        });
        const channelOptions = (0, grpc_channel_options_1.grpcChannelOptionsFromGrpcConfig)(grpcConfig);
        this.client = new grpcPubsub.PubsubClient(this.credentialProvider.getCacheEndpoint(), grpc_js_1.ChannelCredentials.createSsl(), channelOptions);
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        this.unaryInterceptors = PubsubClient.initializeUnaryInterceptors(headers, props.configuration, this.unaryRequestTimeoutMs);
        this.streamingInterceptors =
            PubsubClient.initializeStreamingInterceptors(headers);
    }
    getEndpoint() {
        const endpoint = this.credentialProvider.getCacheEndpoint();
        this.logger.debug(`Using cache endpoint: ${endpoint}`);
        return endpoint;
    }
    async sendPublish(cacheName, topicName, value) {
        const topicValue = new grpcPubsub._TopicValue();
        if (typeof value === 'string') {
            topicValue.text = value;
        }
        else {
            topicValue.binary = value;
        }
        const request = new grpcPubsub._PublishRequest({
            cache_name: cacheName,
            topic: topicName,
            value: topicValue,
        });
        return await new Promise((resolve, reject) => {
            this.client.Publish(request, {
                interceptors: this.unaryInterceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new __1.TopicPublish.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new __1.TopicPublish.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    /**
     * @remark This method is responsible for restarting the stream if it ends unexpectedly.
     * Since we return a single subscription object to the user, we need to update it with the
     * unsubscribe function should we restart the stream. This is why we pass the subscription
     * state and subscription object to this method.
     *
     * Handling a cache not exists requires special care as well. In the most likely case,
     * when the subscription starts and the cache does not exist, we receive an error immediately.
     * We return an error from the subscribe method and do immediately unsubscribe. In a distinct,
     * unlikely but possible case, the user deletes the cache while the stream is running. In this
     * case we already returned a subscription object to the user, so we instead cancel the stream and
     * propagate an error to the user via the error handler.
     */
    sendSubscribe(options) {
        const request = new grpcPubsub._SubscriptionRequest({
            cache_name: options.cacheName,
            topic: options.topicName,
            resume_at_topic_sequence_number: options.subscriptionState.resumeAtTopicSequenceNumber,
        });
        const call = this.client.Subscribe(request, {
            interceptors: this.streamingInterceptors,
        });
        options.subscriptionState.setSubscribed();
        // Allow the caller to cancel the stream.
        // Note that because we restart the stream on error or stream end,
        // we need to ensure we keep the same subscription object. That way
        // stream restarts are transparent to the caller.
        options.subscriptionState.unsubscribeFn = () => {
            call.cancel();
        };
        return new Promise((resolve, reject) => {
            const prepareCallbackOptions = {
                ...options,
                restartedDueToError: false,
                firstMessage: true,
                resolve,
            };
            call.on('data', this.prepareDataCallback(prepareCallbackOptions));
            call.on('error', this.prepareErrorCallback(prepareCallbackOptions));
            call.on('end', this.prepareEndCallback(prepareCallbackOptions));
        });
    }
    prepareDataCallback(options) {
        return (resp) => {
            if (options.firstMessage) {
                options.resolve(options.subscription);
            }
            options.firstMessage = false;
            if (resp === null || resp === void 0 ? void 0 : resp.item) {
                options.subscriptionState.lastTopicSequenceNumber =
                    resp.item.topic_sequence_number;
                if (resp.item.value.text) {
                    options.onItem(new __1.TopicItem(resp.item.value.text, {
                        tokenId: resp.item.publisher_id,
                    }));
                }
                else if (resp.item.value.binary) {
                    options.onItem(new __1.TopicItem(resp.item.value.binary, {
                        tokenId: resp.item.publisher_id,
                    }));
                }
                else {
                    this.logger.error('Received subscription item with unknown type; topic: %s', (0, utils_1.truncateString)(options.topicName));
                    options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item value type')), options.subscription);
                }
            }
            else if (resp === null || resp === void 0 ? void 0 : resp.heartbeat) {
                this.logger.trace('Received heartbeat from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
            }
            else if (resp === null || resp === void 0 ? void 0 : resp.discontinuity) {
                this.logger.trace('Received discontinuity from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
            }
            else {
                this.logger.error('Received unknown subscription item; topic: %s', (0, utils_1.truncateString)(options.topicName));
                options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item type')), options.subscription);
            }
        };
    }
    prepareErrorCallback(options) {
        return (err) => {
            // When the caller unsubscribes, we may get a follow on error, which we ignore.
            if (!options.subscriptionState.isSubscribed) {
                return;
            }
            const serviceError = err;
            const isRstStreamNoError = serviceError.code === constants_1.Status.INTERNAL &&
                serviceError.details === PubsubClient.RST_STREAM_NO_ERROR_MESSAGE;
            const momentoError = new __1.TopicSubscribe.Error(this.cacheServiceErrorMapper.convertError(serviceError));
            this.handleSubscribeError(options, momentoError, isRstStreamNoError);
        };
    }
    static initializeUnaryInterceptors(headers, configuration, requestTimeoutMs) {
        return [
            (0, middlewares_interceptor_1.middlewaresInterceptor)(configuration.getLoggerFactory(), [], {}),
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(requestTimeoutMs),
        ];
    }
    // TODO https://github.com/momentohq/client-sdk-nodejs/issues/349
    // decide on streaming interceptors and middlewares
    static initializeStreamingInterceptors(headers) {
        return [new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor()];
    }
}
exports.PubsubClient = PubsubClient;
PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS = 5 * 1000;
PubsubClient.DEFAULT_MAX_SESSION_MEMORY_MB = 256;
PubsubClient.RST_STREAM_NO_ERROR_MESSAGE = 'Received RST_STREAM with code 0';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVic3ViLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcm5hbC9wdWJzdWItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGdFQUFrRDtBQUNsRCxJQUFPLFVBQVUsR0FBRyx3QkFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7QUFDL0MsMEdBQTBHO0FBQzFHLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UscUZBQTZFO0FBQzdFLDJDQUE0RTtBQUM1RSxpRUFBeUQ7QUFDekQscURBQTJDO0FBQzNDLDRFQUFzRTtBQUN0RSwyQkFRYTtBQUNiLHVFQUEyRTtBQUMzRSxvSEFJbUY7QUFHbkYsc0VBQTZFO0FBRTdFLE1BQWEsWUFBYSxTQUFRLDJDQUFrQztJQWVsRTs7T0FFRztJQUNILFlBQVksS0FBd0M7UUFDbEQsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7UUFDekMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUNuRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksb0RBQXVCLENBQ3hELElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FDdEMsQ0FBQztRQUNGLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxZQUFZLENBQUMsMEJBQTBCLENBQUM7UUFDckUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsMENBQTBDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQ3hGLENBQUM7UUFFRiw4RkFBOEY7UUFDOUYsbURBQW1EO1FBQ25ELE1BQU0sVUFBVSxHQUFHLElBQUksMkJBQXVC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Q0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDdkUsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVPLE1BQU0sQ0FBQywyQkFBMkIsQ0FDeEMsT0FBaUIsRUFDakIsYUFBaUMsRUFDakMsZ0JBQXdCO1FBRXhCLE9BQU87WUFDTCxJQUFBLGdEQUFzQixFQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUM7WUFDaEUsSUFBSSwrQ0FBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyx3QkFBd0IsRUFBRTtZQUNqRSxJQUFBLHFEQUF3QixFQUFDLGdCQUFnQixDQUFDO1NBQzNDLENBQUM7SUFDSixDQUFDO0lBRUQsaUVBQWlFO0lBQ2pFLG1EQUFtRDtJQUMzQyxNQUFNLENBQUMsK0JBQStCLENBQzVDLE9BQWlCO1FBRWpCLE9BQU8sQ0FBQyxJQUFJLCtDQUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDLHdCQUF3QixFQUFFLENBQUMsQ0FBQztJQUM3RSxDQUFDOztBQTNQSCxvQ0E0UEM7QUF2UHlCLHVDQUEwQixHQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7QUFDOUMsMENBQTZCLEdBQVcsR0FBRyxDQUFDO0FBTTVDLHdDQUEyQixHQUNqRCxpQ0FBaUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7cHVic3VifSBmcm9tICdAZ29tb21lbnRvL2dlbmVyYXRlZC10eXBlcyc7XG5pbXBvcnQgZ3JwY1B1YnN1YiA9IHB1YnN1Yi5jYWNoZV9jbGllbnQucHVic3ViO1xuLy8gb2xkZXIgdmVyc2lvbnMgb2Ygbm9kZSBkb24ndCBoYXZlIHRoZSBnbG9iYWwgdXRpbCB2YXJpYWJsZXMgaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2lzc3Vlcy8yMDM2NVxuaW1wb3J0IHtIZWFkZXIsIEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXJ9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2xpZW50VGltZW91dEludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvY2xpZW50LXRpbWVvdXQtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDYWNoZVNlcnZpY2VFcnJvck1hcHBlcn0gZnJvbSAnLi4vZXJyb3JzL2NhY2hlLXNlcnZpY2UtZXJyb3ItbWFwcGVyJztcbmltcG9ydCB7Q2hhbm5lbENyZWRlbnRpYWxzLCBJbnRlcmNlcHRvciwgU2VydmljZUVycm9yfSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7U3RhdHVzfSBmcm9tICdAZ3JwYy9ncnBjLWpzL2J1aWxkL3NyYy9jb25zdGFudHMnO1xuaW1wb3J0IHt2ZXJzaW9ufSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHttaWRkbGV3YXJlc0ludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvbWlkZGxld2FyZXMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtcbiAgQ3JlZGVudGlhbFByb3ZpZGVyLFxuICBNb21lbnRvTG9nZ2VyLFxuICBTdGF0aWNHcnBjQ29uZmlndXJhdGlvbixcbiAgVG9waWNJdGVtLFxuICBUb3BpY1B1Ymxpc2gsXG4gIFRvcGljU3Vic2NyaWJlLFxuICBVbmtub3duRXJyb3IsXG59IGZyb20gJy4uLyc7XG5pbXBvcnQge3RydW5jYXRlU3RyaW5nfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7XG4gIEFic3RyYWN0UHVic3ViQ2xpZW50LFxuICBTZW5kU3Vic2NyaWJlT3B0aW9ucyxcbiAgUHJlcGFyZVN1YnNjcmliZUNhbGxiYWNrT3B0aW9ucyxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzL3B1YnN1Yi9BYnN0cmFjdFB1YnN1YkNsaWVudCc7XG5pbXBvcnQge1RvcGljQ29uZmlndXJhdGlvbn0gZnJvbSAnLi4vY29uZmlnL3RvcGljLWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHtUb3BpY0NsaWVudFByb3BzV2l0aENvbmZpZ3VyYXRpb259IGZyb20gJy4vdG9waWMtY2xpZW50LXByb3BzLXdpdGgtY29uZmlnJztcbmltcG9ydCB7Z3JwY0NoYW5uZWxPcHRpb25zRnJvbUdycGNDb25maWd9IGZyb20gJy4vZ3JwYy9ncnBjLWNoYW5uZWwtb3B0aW9ucyc7XG5cbmV4cG9ydCBjbGFzcyBQdWJzdWJDbGllbnQgZXh0ZW5kcyBBYnN0cmFjdFB1YnN1YkNsaWVudDxTZXJ2aWNlRXJyb3I+IHtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnQ6IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IFRvcGljQ29uZmlndXJhdGlvbjtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGNyZWRlbnRpYWxQcm92aWRlcjogQ3JlZGVudGlhbFByb3ZpZGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHVuYXJ5UmVxdWVzdFRpbWVvdXRNczogbnVtYmVyO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBERUZBVUxUX1JFUVVFU1RfVElNRU9VVF9NUzogbnVtYmVyID0gNSAqIDEwMDA7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfTUFYX1NFU1NJT05fTUVNT1JZX01COiBudW1iZXIgPSAyNTY7XG4gIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByb3RlY3RlZCByZWFkb25seSBjYWNoZVNlcnZpY2VFcnJvck1hcHBlcjogQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgdW5hcnlJbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RyZWFtaW5nSW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFJTVF9TVFJFQU1fTk9fRVJST1JfTUVTU0FHRSA9XG4gICAgJ1JlY2VpdmVkIFJTVF9TVFJFQU0gd2l0aCBjb2RlIDAnO1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1RvcGljQ2xpZW50UHJvcHN9IHByb3BzXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogVG9waWNDbGllbnRQcm9wc1dpdGhDb25maWd1cmF0aW9uKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb24gPSBwcm9wcy5jb25maWd1cmF0aW9uO1xuICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIHRoaXMubG9nZ2VyID0gdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIodGhpcyk7XG4gICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlciA9IG5ldyBDYWNoZVNlcnZpY2VFcnJvck1hcHBlcihcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5nZXRUaHJvd09uRXJyb3JzKClcbiAgICApO1xuICAgIHRoaXMudW5hcnlSZXF1ZXN0VGltZW91dE1zID0gUHVic3ViQ2xpZW50LkRFRkFVTFRfUkVRVUVTVF9USU1FT1VUX01TO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIHRvcGljIGNsaWVudCB1c2luZyBlbmRwb2ludDogJyR7dGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpfSdgXG4gICAgKTtcblxuICAgIC8vIE5PVEU6IFRoaXMgaXMgaGFyZC1jb2RlZCBmb3Igbm93IGJ1dCB3ZSBtYXkgd2FudCB0byBleHBvc2UgaXQgdmlhIFRvcGljQ29uZmlndXJhdGlvbiBpbiB0aGVcbiAgICAvLyBmdXR1cmUsIGFzIHdlIGRvIHdpdGggc29tZSBvZiB0aGUgb3RoZXIgY2xpZW50cy5cbiAgICBjb25zdCBncnBjQ29uZmlnID0gbmV3IFN0YXRpY0dycGNDb25maWd1cmF0aW9uKHtcbiAgICAgIGRlYWRsaW5lTWlsbGlzOiB0aGlzLnVuYXJ5UmVxdWVzdFRpbWVvdXRNcyxcbiAgICAgIG1heFNlc3Npb25NZW1vcnlNYjogUHVic3ViQ2xpZW50LkRFRkFVTFRfTUFYX1NFU1NJT05fTUVNT1JZX01CLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2hhbm5lbE9wdGlvbnMgPSBncnBjQ2hhbm5lbE9wdGlvbnNGcm9tR3JwY0NvbmZpZyhncnBjQ29uZmlnKTtcblxuICAgIHRoaXMuY2xpZW50ID0gbmV3IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50KFxuICAgICAgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpLFxuICAgICAgQ2hhbm5lbENyZWRlbnRpYWxzLmNyZWF0ZVNzbCgpLFxuICAgICAgY2hhbm5lbE9wdGlvbnNcbiAgICApO1xuXG4gICAgY29uc3QgaGVhZGVyczogSGVhZGVyW10gPSBbXG4gICAgICBuZXcgSGVhZGVyKCdBdXRob3JpemF0aW9uJywgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0QXV0aFRva2VuKCkpLFxuICAgICAgbmV3IEhlYWRlcignQWdlbnQnLCBgbm9kZWpzOiR7dmVyc2lvbn1gKSxcbiAgICBdO1xuICAgIHRoaXMudW5hcnlJbnRlcmNlcHRvcnMgPSBQdWJzdWJDbGllbnQuaW5pdGlhbGl6ZVVuYXJ5SW50ZXJjZXB0b3JzKFxuICAgICAgaGVhZGVycyxcbiAgICAgIHByb3BzLmNvbmZpZ3VyYXRpb24sXG4gICAgICB0aGlzLnVuYXJ5UmVxdWVzdFRpbWVvdXRNc1xuICAgICk7XG4gICAgdGhpcy5zdHJlYW1pbmdJbnRlcmNlcHRvcnMgPVxuICAgICAgUHVic3ViQ2xpZW50LmluaXRpYWxpemVTdHJlYW1pbmdJbnRlcmNlcHRvcnMoaGVhZGVycyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RW5kcG9pbnQoKTogc3RyaW5nIHtcbiAgICBjb25zdCBlbmRwb2ludCA9IHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldENhY2hlRW5kcG9pbnQoKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVXNpbmcgY2FjaGUgZW5kcG9pbnQ6ICR7ZW5kcG9pbnR9YCk7XG4gICAgcmV0dXJuIGVuZHBvaW50O1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHNlbmRQdWJsaXNoKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIHRvcGljTmFtZTogc3RyaW5nLFxuICAgIHZhbHVlOiBzdHJpbmcgfCBVaW50OEFycmF5XG4gICk6IFByb21pc2U8VG9waWNQdWJsaXNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgdG9waWNWYWx1ZSA9IG5ldyBncnBjUHVic3ViLl9Ub3BpY1ZhbHVlKCk7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRvcGljVmFsdWUudGV4dCA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0b3BpY1ZhbHVlLmJpbmFyeSA9IHZhbHVlO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1B1YnN1Yi5fUHVibGlzaFJlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgdG9waWM6IHRvcGljTmFtZSxcbiAgICAgIHZhbHVlOiB0b3BpY1ZhbHVlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LlB1Ymxpc2goXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMudW5hcnlJbnRlcmNlcHRvcnMsXG4gICAgICAgIH0sXG4gICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgVG9waWNQdWJsaXNoLlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgVG9waWNQdWJsaXNoLkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHJlbWFyayBUaGlzIG1ldGhvZCBpcyByZXNwb25zaWJsZSBmb3IgcmVzdGFydGluZyB0aGUgc3RyZWFtIGlmIGl0IGVuZHMgdW5leHBlY3RlZGx5LlxuICAgKiBTaW5jZSB3ZSByZXR1cm4gYSBzaW5nbGUgc3Vic2NyaXB0aW9uIG9iamVjdCB0byB0aGUgdXNlciwgd2UgbmVlZCB0byB1cGRhdGUgaXQgd2l0aCB0aGVcbiAgICogdW5zdWJzY3JpYmUgZnVuY3Rpb24gc2hvdWxkIHdlIHJlc3RhcnQgdGhlIHN0cmVhbS4gVGhpcyBpcyB3aHkgd2UgcGFzcyB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIHN0YXRlIGFuZCBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoaXMgbWV0aG9kLlxuICAgKlxuICAgKiBIYW5kbGluZyBhIGNhY2hlIG5vdCBleGlzdHMgcmVxdWlyZXMgc3BlY2lhbCBjYXJlIGFzIHdlbGwuIEluIHRoZSBtb3N0IGxpa2VseSBjYXNlLFxuICAgKiB3aGVuIHRoZSBzdWJzY3JpcHRpb24gc3RhcnRzIGFuZCB0aGUgY2FjaGUgZG9lcyBub3QgZXhpc3QsIHdlIHJlY2VpdmUgYW4gZXJyb3IgaW1tZWRpYXRlbHkuXG4gICAqIFdlIHJldHVybiBhbiBlcnJvciBmcm9tIHRoZSBzdWJzY3JpYmUgbWV0aG9kIGFuZCBkbyBpbW1lZGlhdGVseSB1bnN1YnNjcmliZS4gSW4gYSBkaXN0aW5jdCxcbiAgICogdW5saWtlbHkgYnV0IHBvc3NpYmxlIGNhc2UsIHRoZSB1c2VyIGRlbGV0ZXMgdGhlIGNhY2hlIHdoaWxlIHRoZSBzdHJlYW0gaXMgcnVubmluZy4gSW4gdGhpc1xuICAgKiBjYXNlIHdlIGFscmVhZHkgcmV0dXJuZWQgYSBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoZSB1c2VyLCBzbyB3ZSBpbnN0ZWFkIGNhbmNlbCB0aGUgc3RyZWFtIGFuZFxuICAgKiBwcm9wYWdhdGUgYW4gZXJyb3IgdG8gdGhlIHVzZXIgdmlhIHRoZSBlcnJvciBoYW5kbGVyLlxuICAgKi9cbiAgcHJvdGVjdGVkIHNlbmRTdWJzY3JpYmUoXG4gICAgb3B0aW9uczogU2VuZFN1YnNjcmliZU9wdGlvbnNcbiAgKTogUHJvbWlzZTxUb3BpY1N1YnNjcmliZS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBvcHRpb25zLmNhY2hlTmFtZSxcbiAgICAgIHRvcGljOiBvcHRpb25zLnRvcGljTmFtZSxcbiAgICAgIHJlc3VtZV9hdF90b3BpY19zZXF1ZW5jZV9udW1iZXI6XG4gICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUucmVzdW1lQXRUb3BpY1NlcXVlbmNlTnVtYmVyLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2FsbCA9IHRoaXMuY2xpZW50LlN1YnNjcmliZShyZXF1ZXN0LCB7XG4gICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuc3RyZWFtaW5nSW50ZXJjZXB0b3JzLFxuICAgIH0pO1xuICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUuc2V0U3Vic2NyaWJlZCgpO1xuXG4gICAgLy8gQWxsb3cgdGhlIGNhbGxlciB0byBjYW5jZWwgdGhlIHN0cmVhbS5cbiAgICAvLyBOb3RlIHRoYXQgYmVjYXVzZSB3ZSByZXN0YXJ0IHRoZSBzdHJlYW0gb24gZXJyb3Igb3Igc3RyZWFtIGVuZCxcbiAgICAvLyB3ZSBuZWVkIHRvIGVuc3VyZSB3ZSBrZWVwIHRoZSBzYW1lIHN1YnNjcmlwdGlvbiBvYmplY3QuIFRoYXQgd2F5XG4gICAgLy8gc3RyZWFtIHJlc3RhcnRzIGFyZSB0cmFuc3BhcmVudCB0byB0aGUgY2FsbGVyLlxuICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUudW5zdWJzY3JpYmVGbiA9ICgpID0+IHtcbiAgICAgIGNhbGwuY2FuY2VsKCk7XG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBwcmVwYXJlQ2FsbGJhY2tPcHRpb25zOiBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zID0ge1xuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICByZXN0YXJ0ZWREdWVUb0Vycm9yOiBmYWxzZSxcbiAgICAgICAgZmlyc3RNZXNzYWdlOiB0cnVlLFxuICAgICAgICByZXNvbHZlLFxuICAgICAgfTtcbiAgICAgIGNhbGwub24oJ2RhdGEnLCB0aGlzLnByZXBhcmVEYXRhQ2FsbGJhY2socHJlcGFyZUNhbGxiYWNrT3B0aW9ucykpO1xuICAgICAgY2FsbC5vbignZXJyb3InLCB0aGlzLnByZXBhcmVFcnJvckNhbGxiYWNrKHByZXBhcmVDYWxsYmFja09wdGlvbnMpKTtcbiAgICAgIGNhbGwub24oJ2VuZCcsIHRoaXMucHJlcGFyZUVuZENhbGxiYWNrKHByZXBhcmVDYWxsYmFja09wdGlvbnMpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZURhdGFDYWxsYmFjayhcbiAgICBvcHRpb25zOiBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zXG4gICk6IChyZXNwOiBncnBjUHVic3ViLl9TdWJzY3JpcHRpb25JdGVtKSA9PiB2b2lkIHtcbiAgICByZXR1cm4gKHJlc3A6IGdycGNQdWJzdWIuX1N1YnNjcmlwdGlvbkl0ZW0pID0+IHtcbiAgICAgIGlmIChvcHRpb25zLmZpcnN0TWVzc2FnZSkge1xuICAgICAgICBvcHRpb25zLnJlc29sdmUob3B0aW9ucy5zdWJzY3JpcHRpb24pO1xuICAgICAgfVxuICAgICAgb3B0aW9ucy5maXJzdE1lc3NhZ2UgPSBmYWxzZTtcblxuICAgICAgaWYgKHJlc3A/Lml0ZW0pIHtcbiAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5sYXN0VG9waWNTZXF1ZW5jZU51bWJlciA9XG4gICAgICAgICAgcmVzcC5pdGVtLnRvcGljX3NlcXVlbmNlX251bWJlcjtcbiAgICAgICAgaWYgKHJlc3AuaXRlbS52YWx1ZS50ZXh0KSB7XG4gICAgICAgICAgb3B0aW9ucy5vbkl0ZW0oXG4gICAgICAgICAgICBuZXcgVG9waWNJdGVtKHJlc3AuaXRlbS52YWx1ZS50ZXh0LCB7XG4gICAgICAgICAgICAgIHRva2VuSWQ6IHJlc3AuaXRlbS5wdWJsaXNoZXJfaWQsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcC5pdGVtLnZhbHVlLmJpbmFyeSkge1xuICAgICAgICAgIG9wdGlvbnMub25JdGVtKFxuICAgICAgICAgICAgbmV3IFRvcGljSXRlbShyZXNwLml0ZW0udmFsdWUuYmluYXJ5LCB7XG4gICAgICAgICAgICAgIHRva2VuSWQ6IHJlc3AuaXRlbS5wdWJsaXNoZXJfaWQsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAnUmVjZWl2ZWQgc3Vic2NyaXB0aW9uIGl0ZW0gd2l0aCB1bmtub3duIHR5cGU7IHRvcGljOiAlcycsXG4gICAgICAgICAgICB0cnVuY2F0ZVN0cmluZyhvcHRpb25zLnRvcGljTmFtZSlcbiAgICAgICAgICApO1xuICAgICAgICAgIG9wdGlvbnMub25FcnJvcihcbiAgICAgICAgICAgIG5ldyBUb3BpY1N1YnNjcmliZS5FcnJvcihcbiAgICAgICAgICAgICAgbmV3IFVua25vd25FcnJvcignVW5rbm93biBpdGVtIHZhbHVlIHR5cGUnKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChyZXNwPy5oZWFydGJlYXQpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICAgICAgJ1JlY2VpdmVkIGhlYXJ0YmVhdCBmcm9tIHN1YnNjcmlwdGlvbiBzdHJlYW07IHRvcGljOiAlcycsXG4gICAgICAgICAgdHJ1bmNhdGVTdHJpbmcob3B0aW9ucy50b3BpY05hbWUpXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKHJlc3A/LmRpc2NvbnRpbnVpdHkpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICAgICAgJ1JlY2VpdmVkIGRpc2NvbnRpbnVpdHkgZnJvbSBzdWJzY3JpcHRpb24gc3RyZWFtOyB0b3BpYzogJXMnLFxuICAgICAgICAgIHRydW5jYXRlU3RyaW5nKG9wdGlvbnMudG9waWNOYW1lKVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ1JlY2VpdmVkIHVua25vd24gc3Vic2NyaXB0aW9uIGl0ZW07IHRvcGljOiAlcycsXG4gICAgICAgICAgdHJ1bmNhdGVTdHJpbmcob3B0aW9ucy50b3BpY05hbWUpXG4gICAgICAgICk7XG4gICAgICAgIG9wdGlvbnMub25FcnJvcihcbiAgICAgICAgICBuZXcgVG9waWNTdWJzY3JpYmUuRXJyb3IobmV3IFVua25vd25FcnJvcignVW5rbm93biBpdGVtIHR5cGUnKSksXG4gICAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlRXJyb3JDYWxsYmFjayhcbiAgICBvcHRpb25zOiBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zXG4gICk6IChlcnI6IEVycm9yKSA9PiB2b2lkIHtcbiAgICByZXR1cm4gKGVycjogRXJyb3IpID0+IHtcbiAgICAgIC8vIFdoZW4gdGhlIGNhbGxlciB1bnN1YnNjcmliZXMsIHdlIG1heSBnZXQgYSBmb2xsb3cgb24gZXJyb3IsIHdoaWNoIHdlIGlnbm9yZS5cbiAgICAgIGlmICghb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5pc1N1YnNjcmliZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZXJ2aWNlRXJyb3IgPSBlcnIgYXMgdW5rbm93biBhcyBTZXJ2aWNlRXJyb3I7XG4gICAgICBjb25zdCBpc1JzdFN0cmVhbU5vRXJyb3IgPVxuICAgICAgICBzZXJ2aWNlRXJyb3IuY29kZSA9PT0gU3RhdHVzLklOVEVSTkFMICYmXG4gICAgICAgIHNlcnZpY2VFcnJvci5kZXRhaWxzID09PSBQdWJzdWJDbGllbnQuUlNUX1NUUkVBTV9OT19FUlJPUl9NRVNTQUdFO1xuICAgICAgY29uc3QgbW9tZW50b0Vycm9yID0gbmV3IFRvcGljU3Vic2NyaWJlLkVycm9yKFxuICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLmNvbnZlcnRFcnJvcihzZXJ2aWNlRXJyb3IpXG4gICAgICApO1xuICAgICAgdGhpcy5oYW5kbGVTdWJzY3JpYmVFcnJvcihvcHRpb25zLCBtb21lbnRvRXJyb3IsIGlzUnN0U3RyZWFtTm9FcnJvcik7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVVbmFyeUludGVyY2VwdG9ycyhcbiAgICBoZWFkZXJzOiBIZWFkZXJbXSxcbiAgICBjb25maWd1cmF0aW9uOiBUb3BpY0NvbmZpZ3VyYXRpb24sXG4gICAgcmVxdWVzdFRpbWVvdXRNczogbnVtYmVyXG4gICk6IEludGVyY2VwdG9yW10ge1xuICAgIHJldHVybiBbXG4gICAgICBtaWRkbGV3YXJlc0ludGVyY2VwdG9yKGNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLCBbXSwge30pLFxuICAgICAgbmV3IEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXIoaGVhZGVycykuY3JlYXRlSGVhZGVyc0ludGVyY2VwdG9yKCksXG4gICAgICBDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3IocmVxdWVzdFRpbWVvdXRNcyksXG4gICAgXTtcbiAgfVxuXG4gIC8vIFRPRE8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudG9ocS9jbGllbnQtc2RrLW5vZGVqcy9pc3N1ZXMvMzQ5XG4gIC8vIGRlY2lkZSBvbiBzdHJlYW1pbmcgaW50ZXJjZXB0b3JzIGFuZCBtaWRkbGV3YXJlc1xuICBwcml2YXRlIHN0YXRpYyBpbml0aWFsaXplU3RyZWFtaW5nSW50ZXJjZXB0b3JzKFxuICAgIGhlYWRlcnM6IEhlYWRlcltdXG4gICk6IEludGVyY2VwdG9yW10ge1xuICAgIHJldHVybiBbbmV3IEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXIoaGVhZGVycykuY3JlYXRlSGVhZGVyc0ludGVyY2VwdG9yKCldO1xuICB9XG59XG4iXX0=