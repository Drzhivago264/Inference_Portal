"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.batchDelete = exports.batchSet = exports.batchGet = exports.defaultTtlSeconds = exports.defaultMaxConcurrentRequests = void 0;
const batch_props_1 = require("./batch-props");
Object.defineProperty(exports, "defaultMaxConcurrentRequests", { enumerable: true, get: function () { return batch_props_1.defaultMaxConcurrentRequests; } });
Object.defineProperty(exports, "defaultTtlSeconds", { enumerable: true, get: function () { return batch_props_1.defaultTtlSeconds; } });
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
// Note: all promises in batch request workers have a client-side timeout deadline
// because grpc request timeouts are baked into the cache client. The timeout can be
// overridden using the `withClientTimeoutMillis` function.
async function batchGet(cacheClient, cacheName, keys, options) {
    const maxConcurrentGets = (options === null || options === void 0 ? void 0 : options.maxConcurrentRequests)
        ? options.maxConcurrentRequests
        : Math.min(batch_props_1.defaultMaxConcurrentRequests, keys.length);
    const batchGetResults = (0, utils_1.range)(maxConcurrentGets).map((workerId) => getWorker(workerId, cacheClient, cacheName, keys));
    const awaitAll = await Promise.all(batchGetResults);
    const batchGetResponse = {};
    awaitAll.forEach(responses => {
        Object.assign(batchGetResponse, responses);
    });
    return batchGetResponse;
}
exports.batchGet = batchGet;
async function getWorker(workerId, cacheClient, cacheName, keys) {
    const responses = {};
    while (keys.length) {
        const cacheKey = keys.pop();
        if (cacheKey !== undefined) {
            responses[String(cacheKey)] = await cacheClient.get(cacheName, cacheKey);
        }
    }
    return Promise.resolve(responses);
}
async function batchSet(cacheClient, cacheName, items, options) {
    const maxConcurrentSets = (options === null || options === void 0 ? void 0 : options.maxConcurrentRequests)
        ? options.maxConcurrentRequests
        : Math.min(batch_props_1.defaultMaxConcurrentRequests, items.length);
    const batchSetResults = (0, utils_1.range)(maxConcurrentSets).map((workerId) => setWorker(workerId, cacheClient, cacheName, items));
    const awaitAll = await Promise.all(batchSetResults);
    const batchSetResponse = {};
    awaitAll.forEach(responses => {
        Object.assign(batchSetResponse, responses);
    });
    return batchSetResponse;
}
exports.batchSet = batchSet;
async function setWorker(workerId, cacheClient, cacheName, items) {
    const responses = {};
    while (items.length) {
        const item = items.pop();
        if (item !== undefined) {
            responses[String(item.key)] = await cacheClient.set(cacheName, item.key, item.value, { ttl: item.ttl ? item.ttl : batch_props_1.defaultTtlSeconds });
        }
    }
    return Promise.resolve(responses);
}
async function batchDelete(cacheClient, cacheName, keys, options) {
    const maxConcurrentDeletes = (options === null || options === void 0 ? void 0 : options.maxConcurrentRequests)
        ? options.maxConcurrentRequests
        : Math.min(batch_props_1.defaultMaxConcurrentRequests, keys.length);
    const batchDeleteResults = (0, utils_1.range)(maxConcurrentDeletes).map((workerId) => deleteWorker(workerId, cacheClient, cacheName, keys));
    const awaitAll = await Promise.all(batchDeleteResults);
    const batchDeleteResponse = {};
    awaitAll.forEach(responses => {
        Object.assign(batchDeleteResponse, responses);
    });
    return batchDeleteResponse;
}
exports.batchDelete = batchDelete;
async function deleteWorker(workerId, cacheClient, cacheName, keys) {
    const responses = {};
    while (keys.length) {
        const cacheKey = keys.pop();
        if (cacheKey !== undefined) {
            responses[String(cacheKey)] = await cacheClient.delete(cacheName, cacheKey);
        }
    }
    return Promise.resolve(responses);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0Y2gtZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2JhdGNodXRpbHMvYmF0Y2gtZnVuY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQU1BLCtDQVV1QjtBQVdyQiw2R0FiQSwwQ0FBNEIsT0FhQTtBQUM1QixrR0FiQSwrQkFBaUIsT0FhQTtBQVhuQix1RUFBa0U7QUFjbEUsa0ZBQWtGO0FBQ2xGLG9GQUFvRjtBQUNwRiwyREFBMkQ7QUFFcEQsS0FBSyxVQUFVLFFBQVEsQ0FDNUIsV0FBeUIsRUFDekIsU0FBaUIsRUFDakIsSUFBZ0MsRUFDaEMsT0FBeUI7SUFFekIsTUFBTSxpQkFBaUIsR0FBRyxDQUFBLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxxQkFBcUI7UUFDdEQsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUI7UUFDL0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsMENBQTRCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXhELE1BQU0sZUFBZSxHQUFHLElBQUEsYUFBSyxFQUFDLGlCQUFpQixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQ3hFLFNBQVMsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FDbEQsQ0FBQztJQUNGLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUVwRCxNQUFNLGdCQUFnQixHQUFxQixFQUFFLENBQUM7SUFDOUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUMzQixNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxnQkFBZ0IsQ0FBQztBQUMxQixDQUFDO0FBcEJELDRCQW9CQztB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QUFvQixDQUFDLENBQUMsR0FBRyxDQUN4RCxDQUFDLFFBQWdCLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FDM0UsQ0FBQztJQUNGLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBRXZELE1BQU0sbUJBQW1CLEdBQXdCLEVBQUUsQ0FBQztJQUNwRCxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQzNCLE1BQU0sQ0FBQyxNQUFNLENBQUMsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLG1CQUFtQixDQUFDO0FBQzdCLENBQUM7QUFwQkQsa0NBb0JDO0FBRUQsS0FBSyxVQUFVLFlBQVksQ0FDekIsUUFBZ0IsRUFDaEIsV0FBeUIsRUFDekIsU0FBaUIsRUFDakIsSUFBZ0M7SUFFaEMsTUFBTSxTQUFTLEdBQXlDLEVBQUUsQ0FBQztJQUMzRCxPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDbEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksUUFBUSxLQUFLLFNBQVMsRUFBRTtZQUMxQixTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsTUFBTSxXQUFXLENBQUMsTUFBTSxDQUNwRCxTQUFTLEVBQ1QsUUFBUSxDQUNULENBQUM7U0FDSDtLQUNGO0lBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3BDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDYWNoZURlbGV0ZSxcbiAgQ2FjaGVHZXQsXG4gIENhY2hlU2V0LFxuICBJQ2FjaGVDbGllbnQsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtcbiAgQmF0Y2hEZWxldGVPcHRpb25zLFxuICBCYXRjaERlbGV0ZVJlc3BvbnNlLFxuICBCYXRjaEdldE9wdGlvbnMsXG4gIEJhdGNoR2V0UmVzcG9uc2UsXG4gIEJhdGNoU2V0T3B0aW9ucyxcbiAgQmF0Y2hTZXRSZXNwb25zZSxcbiAgQmF0Y2hTZXRJdGVtLFxuICBkZWZhdWx0TWF4Q29uY3VycmVudFJlcXVlc3RzLFxuICBkZWZhdWx0VHRsU2Vjb25kcyxcbn0gZnJvbSAnLi9iYXRjaC1wcm9wcyc7XG5pbXBvcnQge3JhbmdlfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL3V0aWxzJztcblxuZXhwb3J0IHtcbiAgQmF0Y2hEZWxldGVPcHRpb25zLFxuICBCYXRjaERlbGV0ZVJlc3BvbnNlLFxuICBCYXRjaEdldE9wdGlvbnMsXG4gIEJhdGNoR2V0UmVzcG9uc2UsXG4gIEJhdGNoU2V0T3B0aW9ucyxcbiAgQmF0Y2hTZXRSZXNwb25zZSxcbiAgQmF0Y2hTZXRJdGVtLFxuICBkZWZhdWx0TWF4Q29uY3VycmVudFJlcXVlc3RzLFxuICBkZWZhdWx0VHRsU2Vjb25kcyxcbn07XG5cbi8vIE5vdGU6IGFsbCBwcm9taXNlcyBpbiBiYXRjaCByZXF1ZXN0IHdvcmtlcnMgaGF2ZSBhIGNsaWVudC1zaWRlIHRpbWVvdXQgZGVhZGxpbmVcbi8vIGJlY2F1c2UgZ3JwYyByZXF1ZXN0IHRpbWVvdXRzIGFyZSBiYWtlZCBpbnRvIHRoZSBjYWNoZSBjbGllbnQuIFRoZSB0aW1lb3V0IGNhbiBiZVxuLy8gb3ZlcnJpZGRlbiB1c2luZyB0aGUgYHdpdGhDbGllbnRUaW1lb3V0TWlsbGlzYCBmdW5jdGlvbi5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJhdGNoR2V0KFxuICBjYWNoZUNsaWVudDogSUNhY2hlQ2xpZW50LFxuICBjYWNoZU5hbWU6IHN0cmluZyxcbiAga2V5czogQXJyYXk8c3RyaW5nIHwgVWludDhBcnJheT4sXG4gIG9wdGlvbnM/OiBCYXRjaEdldE9wdGlvbnNcbik6IFByb21pc2U8QmF0Y2hHZXRSZXNwb25zZT4ge1xuICBjb25zdCBtYXhDb25jdXJyZW50R2V0cyA9IG9wdGlvbnM/Lm1heENvbmN1cnJlbnRSZXF1ZXN0c1xuICAgID8gb3B0aW9ucy5tYXhDb25jdXJyZW50UmVxdWVzdHNcbiAgICA6IE1hdGgubWluKGRlZmF1bHRNYXhDb25jdXJyZW50UmVxdWVzdHMsIGtleXMubGVuZ3RoKTtcblxuICBjb25zdCBiYXRjaEdldFJlc3VsdHMgPSByYW5nZShtYXhDb25jdXJyZW50R2V0cykubWFwKCh3b3JrZXJJZDogbnVtYmVyKSA9PlxuICAgIGdldFdvcmtlcih3b3JrZXJJZCwgY2FjaGVDbGllbnQsIGNhY2hlTmFtZSwga2V5cylcbiAgKTtcbiAgY29uc3QgYXdhaXRBbGwgPSBhd2FpdCBQcm9taXNlLmFsbChiYXRjaEdldFJlc3VsdHMpO1xuXG4gIGNvbnN0IGJhdGNoR2V0UmVzcG9uc2U6IEJhdGNoR2V0UmVzcG9uc2UgPSB7fTtcbiAgYXdhaXRBbGwuZm9yRWFjaChyZXNwb25zZXMgPT4ge1xuICAgIE9iamVjdC5hc3NpZ24oYmF0Y2hHZXRSZXNwb25zZSwgcmVzcG9uc2VzKTtcbiAgfSk7XG4gIHJldHVybiBiYXRjaEdldFJlc3BvbnNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRXb3JrZXIoXG4gIHdvcmtlcklkOiBudW1iZXIsXG4gIGNhY2hlQ2xpZW50OiBJQ2FjaGVDbGllbnQsXG4gIGNhY2hlTmFtZTogc3RyaW5nLFxuICBrZXlzOiBBcnJheTxzdHJpbmcgfCBVaW50OEFycmF5PlxuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBDYWNoZUdldC5SZXNwb25zZT4+IHtcbiAgY29uc3QgcmVzcG9uc2VzOiBSZWNvcmQ8c3RyaW5nLCBDYWNoZUdldC5SZXNwb25zZT4gPSB7fTtcbiAgd2hpbGUgKGtleXMubGVuZ3RoKSB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSBrZXlzLnBvcCgpO1xuICAgIGlmIChjYWNoZUtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXNwb25zZXNbU3RyaW5nKGNhY2hlS2V5KV0gPSBhd2FpdCBjYWNoZUNsaWVudC5nZXQoY2FjaGVOYW1lLCBjYWNoZUtleSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2VzKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJhdGNoU2V0KFxuICBjYWNoZUNsaWVudDogSUNhY2hlQ2xpZW50LFxuICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgaXRlbXM6IEFycmF5PEJhdGNoU2V0SXRlbT4sXG4gIG9wdGlvbnM/OiBCYXRjaFNldE9wdGlvbnNcbik6IFByb21pc2U8QmF0Y2hTZXRSZXNwb25zZT4ge1xuICBjb25zdCBtYXhDb25jdXJyZW50U2V0cyA9IG9wdGlvbnM/Lm1heENvbmN1cnJlbnRSZXF1ZXN0c1xuICAgID8gb3B0aW9ucy5tYXhDb25jdXJyZW50UmVxdWVzdHNcbiAgICA6IE1hdGgubWluKGRlZmF1bHRNYXhDb25jdXJyZW50UmVxdWVzdHMsIGl0ZW1zLmxlbmd0aCk7XG5cbiAgY29uc3QgYmF0Y2hTZXRSZXN1bHRzID0gcmFuZ2UobWF4Q29uY3VycmVudFNldHMpLm1hcCgod29ya2VySWQ6IG51bWJlcikgPT5cbiAgICBzZXRXb3JrZXIod29ya2VySWQsIGNhY2hlQ2xpZW50LCBjYWNoZU5hbWUsIGl0ZW1zKVxuICApO1xuICBjb25zdCBhd2FpdEFsbCA9IGF3YWl0IFByb21pc2UuYWxsKGJhdGNoU2V0UmVzdWx0cyk7XG5cbiAgY29uc3QgYmF0Y2hTZXRSZXNwb25zZTogQmF0Y2hTZXRSZXNwb25zZSA9IHt9O1xuICBhd2FpdEFsbC5mb3JFYWNoKHJlc3BvbnNlcyA9PiB7XG4gICAgT2JqZWN0LmFzc2lnbihiYXRjaFNldFJlc3BvbnNlLCByZXNwb25zZXMpO1xuICB9KTtcbiAgcmV0dXJuIGJhdGNoU2V0UmVzcG9uc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFdvcmtlcihcbiAgd29ya2VySWQ6IG51bWJlcixcbiAgY2FjaGVDbGllbnQ6IElDYWNoZUNsaWVudCxcbiAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gIGl0ZW1zOiBBcnJheTxCYXRjaFNldEl0ZW0+XG4pOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIENhY2hlU2V0LlJlc3BvbnNlPj4ge1xuICBjb25zdCByZXNwb25zZXM6IFJlY29yZDxzdHJpbmcsIENhY2hlU2V0LlJlc3BvbnNlPiA9IHt9O1xuICB3aGlsZSAoaXRlbXMubGVuZ3RoKSB7XG4gICAgY29uc3QgaXRlbSA9IGl0ZW1zLnBvcCgpO1xuICAgIGlmIChpdGVtICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlc3BvbnNlc1tTdHJpbmcoaXRlbS5rZXkpXSA9IGF3YWl0IGNhY2hlQ2xpZW50LnNldChcbiAgICAgICAgY2FjaGVOYW1lLFxuICAgICAgICBpdGVtLmtleSxcbiAgICAgICAgaXRlbS52YWx1ZSxcbiAgICAgICAge3R0bDogaXRlbS50dGwgPyBpdGVtLnR0bCA6IGRlZmF1bHRUdGxTZWNvbmRzfVxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNwb25zZXMpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYmF0Y2hEZWxldGUoXG4gIGNhY2hlQ2xpZW50OiBJQ2FjaGVDbGllbnQsXG4gIGNhY2hlTmFtZTogc3RyaW5nLFxuICBrZXlzOiBBcnJheTxzdHJpbmcgfCBVaW50OEFycmF5PixcbiAgb3B0aW9ucz86IEJhdGNoRGVsZXRlT3B0aW9uc1xuKTogUHJvbWlzZTxCYXRjaERlbGV0ZVJlc3BvbnNlPiB7XG4gIGNvbnN0IG1heENvbmN1cnJlbnREZWxldGVzID0gb3B0aW9ucz8ubWF4Q29uY3VycmVudFJlcXVlc3RzXG4gICAgPyBvcHRpb25zLm1heENvbmN1cnJlbnRSZXF1ZXN0c1xuICAgIDogTWF0aC5taW4oZGVmYXVsdE1heENvbmN1cnJlbnRSZXF1ZXN0cywga2V5cy5sZW5ndGgpO1xuXG4gIGNvbnN0IGJhdGNoRGVsZXRlUmVzdWx0cyA9IHJhbmdlKG1heENvbmN1cnJlbnREZWxldGVzKS5tYXAoXG4gICAgKHdvcmtlcklkOiBudW1iZXIpID0+IGRlbGV0ZVdvcmtlcih3b3JrZXJJZCwgY2FjaGVDbGllbnQsIGNhY2hlTmFtZSwga2V5cylcbiAgKTtcbiAgY29uc3QgYXdhaXRBbGwgPSBhd2FpdCBQcm9taXNlLmFsbChiYXRjaERlbGV0ZVJlc3VsdHMpO1xuXG4gIGNvbnN0IGJhdGNoRGVsZXRlUmVzcG9uc2U6IEJhdGNoRGVsZXRlUmVzcG9uc2UgPSB7fTtcbiAgYXdhaXRBbGwuZm9yRWFjaChyZXNwb25zZXMgPT4ge1xuICAgIE9iamVjdC5hc3NpZ24oYmF0Y2hEZWxldGVSZXNwb25zZSwgcmVzcG9uc2VzKTtcbiAgfSk7XG4gIHJldHVybiBiYXRjaERlbGV0ZVJlc3BvbnNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVXb3JrZXIoXG4gIHdvcmtlcklkOiBudW1iZXIsXG4gIGNhY2hlQ2xpZW50OiBJQ2FjaGVDbGllbnQsXG4gIGNhY2hlTmFtZTogc3RyaW5nLFxuICBrZXlzOiBBcnJheTxzdHJpbmcgfCBVaW50OEFycmF5PlxuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBDYWNoZURlbGV0ZS5SZXNwb25zZT4+IHtcbiAgY29uc3QgcmVzcG9uc2VzOiBSZWNvcmQ8c3RyaW5nLCBDYWNoZURlbGV0ZS5SZXNwb25zZT4gPSB7fTtcbiAgd2hpbGUgKGtleXMubGVuZ3RoKSB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSBrZXlzLnBvcCgpO1xuICAgIGlmIChjYWNoZUtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXNwb25zZXNbU3RyaW5nKGNhY2hlS2V5KV0gPSBhd2FpdCBjYWNoZUNsaWVudC5kZWxldGUoXG4gICAgICAgIGNhY2hlTmFtZSxcbiAgICAgICAgY2FjaGVLZXlcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2VzKTtcbn1cbiJdfQ==