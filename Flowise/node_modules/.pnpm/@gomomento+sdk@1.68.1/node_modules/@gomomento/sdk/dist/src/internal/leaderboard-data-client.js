"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LeaderboardDataClient = exports.CONNECTION_ID_KEY = void 0;
const sdk_core_1 = require("@gomomento/sdk-core");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const leaderboard_1 = require("@gomomento/generated-types/dist/leaderboard");
var _Element = leaderboard_1.leaderboard._Element;
const idle_grpc_client_wrapper_1 = require("./grpc/idle-grpc-client-wrapper");
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
const middlewares_interceptor_1 = require("./grpc/middlewares-interceptor");
const grpc_channel_options_1 = require("./grpc/grpc-channel-options");
exports.CONNECTION_ID_KEY = Symbol('connectionID');
class LeaderboardDataClient {
    /**
     * @param {LeaderboardClientPropsWithConfig} props
     * @param dataClientID
     */
    constructor(props, dataClientID) {
        this.configuration = props.configuration;
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(props.configuration.getThrowOnErrors());
        this.credentialProvider = props.credentialProvider;
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        const grpcConfig = this.configuration
            .getTransportStrategy()
            .getGrpcConfig();
        this.requestTimeoutMs = grpcConfig.getDeadlineMillis();
        this.validateRequestTimeout(this.requestTimeoutMs);
        this.logger.debug(`Creating leaderboard client using endpoint: '${this.credentialProvider.getCacheEndpoint()}'`);
        const numDataClients = grpcConfig.getNumClients();
        // We round-robin the requests through all of our clients.  Since javascript
        // is single-threaded, we don't have to worry about thread safety on this
        // index variable.
        this.nextDataClientIndex = 0;
        const channelOptions = (0, grpc_channel_options_1.grpcChannelOptionsFromGrpcConfig)(grpcConfig);
        this.clientWrappers = (0, utils_1.range)(numDataClients).map(() => new idle_grpc_client_wrapper_1.IdleGrpcClientWrapper({
            clientFactoryFn: () => new leaderboard_1.leaderboard.LeaderboardClient(this.credentialProvider.getCacheEndpoint(), grpc_js_1.ChannelCredentials.createSsl(), channelOptions),
            loggerFactory: this.configuration.getLoggerFactory(),
            maxIdleMillis: this.configuration
                .getTransportStrategy()
                .getMaxIdleMillis(),
        }));
        const context = {};
        context[exports.CONNECTION_ID_KEY] = dataClientID;
        this.interceptors = this.initializeInterceptors(this.configuration.getLoggerFactory(), this.configuration.getMiddlewares(), context);
    }
    close() {
        this.logger.debug('Closing leaderboard data clients');
        this.clientWrappers.map(wrapper => wrapper.getClient().close());
    }
    validateRequestTimeout(timeout) {
        this.logger.debug(`Request timeout ms: ${String(timeout)}`);
        if (timeout !== undefined && timeout <= 0) {
            throw new sdk_core_1.InvalidArgumentError('request timeout must be greater than zero.');
        }
    }
    initializeInterceptors(_loggerFactory, middlewares, middlewareRequestContext) {
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        return [
            (0, middlewares_interceptor_1.middlewaresInterceptor)(_loggerFactory, middlewares, middlewareRequestContext),
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(this.requestTimeoutMs),
        ];
    }
    createMetadata(cacheName) {
        const metadata = new grpc_js_1.Metadata();
        metadata.set('cache', cacheName);
        return metadata;
    }
    convertMapOrRecordToElementsList(elements) {
        const convertedElements = [];
        if (elements instanceof Map) {
            elements.forEach((score, id) => convertedElements.push(new _Element({ id: id, score: score })));
        }
        else {
            Object.entries(elements).forEach(element => convertedElements.push(new _Element({ id: Number(element[0]), score: element[1] })));
        }
        return convertedElements;
    }
    async upsert(cacheName, leaderboardName, elements) {
        const size = elements instanceof Map ? elements.size : Object.keys(elements).length;
        try {
            (0, utils_1.validateLeaderboardNumberOfElements)(size);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardUpsert.Error(err));
        }
        this.logger.trace(`Issuing 'upsert' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, number of elements: ${size}`);
        return await this.sendUpsert(cacheName, leaderboardName, elements);
    }
    async sendUpsert(cacheName, leaderboardName, elements) {
        const request = new leaderboard_1.leaderboard._UpsertElementsRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            elements: this.convertMapOrRecordToElementsList(elements),
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().UpsertElements(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.LeaderboardUpsert.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardUpsert.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async fetchByScore(cacheName, leaderboardName, minScore, maxScore, order, offset, count) {
        var _a;
        const offsetValue = offset === undefined ? 0 : offset;
        const countValue = count === undefined ? 8192 : count;
        const orderValue = order !== null && order !== void 0 ? order : sdk_core_1.LeaderboardOrder.Ascending;
        try {
            (0, utils_1.validateSortedSetScores)(minScore, maxScore);
            (0, utils_1.validateLeaderboardOffset)(offsetValue);
            (0, utils_1.validateLeaderboardCount)(countValue);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardFetch.Error(err));
        }
        this.logger.trace(`Issuing 'fetchByScore' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, order: ${orderValue.toString()}, minScore: ${minScore !== null && minScore !== void 0 ? minScore : 'null'}, maxScore: ${(_a = maxScore === null || maxScore === void 0 ? void 0 : maxScore.toString()) !== null && _a !== void 0 ? _a : 'null'}, offset: ${offsetValue.toString()}, count: ${countValue.toString()}`);
        return await this.sendFetchByScore(cacheName, leaderboardName, orderValue, offsetValue, countValue, minScore, maxScore);
    }
    async sendFetchByScore(cacheName, leaderboardName, order, offset, count, minScore, maxScore) {
        const protoBufOrder = order === sdk_core_1.LeaderboardOrder.Descending
            ? leaderboard_1.leaderboard._Order.DESCENDING
            : leaderboard_1.leaderboard._Order.ASCENDING;
        const protoBufScoreRange = new leaderboard_1.leaderboard._ScoreRange();
        if (minScore !== undefined) {
            protoBufScoreRange.min_inclusive = minScore;
        }
        else {
            protoBufScoreRange.unbounded_min = new leaderboard_1.leaderboard._Unbounded();
        }
        if (maxScore !== undefined) {
            protoBufScoreRange.max_exclusive = maxScore;
        }
        else {
            protoBufScoreRange.unbounded_max = new leaderboard_1.leaderboard._Unbounded();
        }
        const request = new leaderboard_1.leaderboard._GetByScoreRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            score_range: protoBufScoreRange,
            order: protoBufOrder,
            offset: offset,
            limit_elements: count,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetByScore(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const foundElements = resp
                        .elements;
                    resolve(new sdk_core_1.LeaderboardFetch.Success(foundElements));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardFetch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async fetchByRank(cacheName, leaderboardName, startRank, endRank, order) {
        const rankOrder = order !== null && order !== void 0 ? order : sdk_core_1.LeaderboardOrder.Ascending;
        try {
            (0, utils_1.validateLeaderboardRanks)(startRank, endRank);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardFetch.Error(err));
        }
        this.logger.trace(`Issuing 'fetchByRank' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, order: ${rankOrder.toString()}, startRank: ${startRank}, endRank: ${endRank}`);
        return await this.sendFetchByRank(cacheName, leaderboardName, startRank, endRank, rankOrder);
    }
    async sendFetchByRank(cacheName, leaderboardName, startRank, endRank, order) {
        const protoBufOrder = order === sdk_core_1.LeaderboardOrder.Descending
            ? leaderboard_1.leaderboard._Order.DESCENDING
            : leaderboard_1.leaderboard._Order.ASCENDING;
        const protoBufRankRange = new leaderboard_1.leaderboard._RankRange({
            start_inclusive: startRank,
            end_exclusive: endRank,
        });
        const request = new leaderboard_1.leaderboard._GetByRankRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            rank_range: protoBufRankRange,
            order: protoBufOrder,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetByRank(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const foundElements = resp
                        .elements;
                    resolve(new sdk_core_1.LeaderboardFetch.Success(foundElements));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardFetch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async getRank(cacheName, leaderboardName, ids, order) {
        const orderValue = order !== null && order !== void 0 ? order : sdk_core_1.LeaderboardOrder.Ascending;
        this.logger.trace(`Issuing 'getRank' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, order: ${orderValue.toString()}, number of ids: ${ids.length}`);
        return await this.sendGetRank(cacheName, leaderboardName, ids, orderValue);
    }
    async sendGetRank(cacheName, leaderboardName, ids, order) {
        const protoBufOrder = order === sdk_core_1.LeaderboardOrder.Descending
            ? leaderboard_1.leaderboard._Order.DESCENDING
            : leaderboard_1.leaderboard._Order.ASCENDING;
        const request = new leaderboard_1.leaderboard._GetRankRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            ids: ids,
            order: protoBufOrder,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetRank(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const foundElements = resp
                        .elements;
                    resolve(new sdk_core_1.LeaderboardFetch.Success(foundElements));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardFetch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async length(cacheName, leaderboardName) {
        this.logger.trace(`Issuing 'length' request; cache: ${cacheName}, leaderboard: ${leaderboardName}`);
        return await this.sendLength(cacheName, leaderboardName);
    }
    async sendLength(cacheName, leaderboardName) {
        const request = new leaderboard_1.leaderboard._GetLeaderboardLengthRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetLeaderboardLength(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const length = resp
                        .count;
                    resolve(new sdk_core_1.LeaderboardLength.Success(length));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardLength.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async removeElements(cacheName, leaderboardName, ids) {
        try {
            (0, utils_1.validateLeaderboardNumberOfElements)(ids.length);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardRemoveElements.Error(err));
        }
        this.logger.trace(`Issuing 'removeElements' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, number of elements: ${ids.length.toString()}`);
        return await this.sendRemoveElements(cacheName, leaderboardName, ids);
    }
    async sendRemoveElements(cacheName, leaderboardName, ids) {
        const request = new leaderboard_1.leaderboard._RemoveElementsRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            ids: ids,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().RemoveElements(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.LeaderboardRemoveElements.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardRemoveElements.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async delete(cacheName, leaderboardName) {
        this.logger.trace(`Issuing 'delete' request; cache: ${cacheName}, leaderboard: ${leaderboardName}`);
        return await this.sendDelete(cacheName, leaderboardName);
    }
    async sendDelete(cacheName, leaderboardName) {
        const request = new leaderboard_1.leaderboard._DeleteLeaderboardRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().DeleteLeaderboard(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.LeaderboardDelete.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardDelete.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    getNextDataClient() {
        const clientWrapper = this.clientWrappers[this.nextDataClientIndex];
        this.nextDataClientIndex =
            (this.nextDataClientIndex + 1) % this.clientWrappers.length;
        return clientWrapper.getClient();
    }
}
exports.LeaderboardDataClient = LeaderboardDataClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhZGVyYm9hcmQtZGF0YS1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvbGVhZGVyYm9hcmQtZGF0YS1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0RBVzZCO0FBQzdCLHVFQU9xRDtBQUVyRCw2RUFBd0U7QUFDeEUsSUFBTyxRQUFRLEdBQUcseUJBQVcsQ0FBQyxRQUFRLENBQUM7QUFDdkMsOEVBQXNFO0FBRXRFLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UscUZBQTZFO0FBQzdFLDJDQUt1QjtBQUN2QixxREFBMkM7QUFHM0MsNEVBQXNFO0FBS3RFLHNFQUE2RTtBQUVoRSxRQUFBLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUV4RCxNQUFhLHFCQUFxQjtJQVVoQzs7O09BR0c7SUFDSCxZQUFZLEtBQXVDLEVBQUUsWUFBb0I7UUFDdkUsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQ3pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLG9EQUF1QixDQUN4RCxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQ3ZDLENBQUM7UUFDRixJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBQ25ELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYTthQUNsQyxvQkFBb0IsRUFBRTthQUN0QixhQUFhLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDdkQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFD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biAgQ3JlZGVudGlhbFByb3ZpZGVyLFxuICBJbnZhbGlkQXJndW1lbnRFcnJvcixcbiAgTGVhZGVyYm9hcmREZWxldGUsXG4gIExlYWRlcmJvYXJkRmV0Y2gsXG4gIExlYWRlcmJvYXJkTGVuZ3RoLFxuICBMZWFkZXJib2FyZFJlbW92ZUVsZW1lbnRzLFxuICBMZWFkZXJib2FyZFVwc2VydCxcbiAgTW9tZW50b0xvZ2dlcixcbiAgTW9tZW50b0xvZ2dlckZhY3RvcnksXG4gIExlYWRlcmJvYXJkT3JkZXIsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtcbiAgdmFsaWRhdGVMZWFkZXJib2FyZE51bWJlck9mRWxlbWVudHMsXG4gIHZhbGlkYXRlU29ydGVkU2V0U2NvcmVzLFxuICB2YWxpZGF0ZUxlYWRlcmJvYXJkT2Zmc2V0LFxuICB2YWxpZGF0ZUxlYWRlcmJvYXJkQ291bnQsXG4gIHZhbGlkYXRlTGVhZGVyYm9hcmRSYW5rcyxcbiAgcmFuZ2UsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHtMZWFkZXJib2FyZENvbmZpZ3VyYXRpb259IGZyb20gJy4uL2NvbmZpZy9sZWFkZXJib2FyZC1jb25maWd1cmF0aW9uJztcbmltcG9ydCB7bGVhZGVyYm9hcmR9IGZyb20gJ0Bnb21vbWVudG8vZ2VuZXJhdGVkLXR5cGVzL2Rpc3QvbGVhZGVyYm9hcmQnO1xuaW1wb3J0IF9FbGVtZW50ID0gbGVhZGVyYm9hcmQuX0VsZW1lbnQ7XG5pbXBvcnQge0lkbGVHcnBjQ2xpZW50V3JhcHBlcn0gZnJvbSAnLi9ncnBjL2lkbGUtZ3JwYy1jbGllbnQtd3JhcHBlcic7XG5pbXBvcnQge0dycGNDbGllbnRXcmFwcGVyfSBmcm9tICcuL2dycGMvZ3JwYy1jbGllbnQtd3JhcHBlcic7XG5pbXBvcnQge0hlYWRlciwgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcn0gZnJvbSAnLi9ncnBjL2hlYWRlcnMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9jbGllbnQtdGltZW91dC1pbnRlcmNlcHRvcic7XG5pbXBvcnQge0NhY2hlU2VydmljZUVycm9yTWFwcGVyfSBmcm9tICcuLi9lcnJvcnMvY2FjaGUtc2VydmljZS1lcnJvci1tYXBwZXInO1xuaW1wb3J0IHtcbiAgQ2hhbm5lbENyZWRlbnRpYWxzLFxuICBJbnRlcmNlcHRvcixcbiAgTWV0YWRhdGEsXG4gIFNlcnZpY2VFcnJvcixcbn0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge3ZlcnNpb259IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQge0lMZWFkZXJib2FyZERhdGFDbGllbnR9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvY2xpZW50cy9sZWFkZXJib2FyZC9JTGVhZGVyYm9hcmREYXRhQ2xpZW50JztcbmltcG9ydCB7TGVhZGVyYm9hcmRDbGllbnRQcm9wc1dpdGhDb25maWd9IGZyb20gJy4vbGVhZGVyYm9hcmQtY2xpZW50LXByb3BzLXdpdGgtY29uZmlnJztcbmltcG9ydCB7bWlkZGxld2FyZXNJbnRlcmNlcHRvcn0gZnJvbSAnLi9ncnBjL21pZGRsZXdhcmVzLWludGVyY2VwdG9yJztcbmltcG9ydCB7XG4gIE1pZGRsZXdhcmUsXG4gIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHQsXG59IGZyb20gJy4uL2NvbmZpZy9taWRkbGV3YXJlL21pZGRsZXdhcmUnO1xuaW1wb3J0IHtncnBjQ2hhbm5lbE9wdGlvbnNGcm9tR3JwY0NvbmZpZ30gZnJvbSAnLi9ncnBjL2dycGMtY2hhbm5lbC1vcHRpb25zJztcblxuZXhwb3J0IGNvbnN0IENPTk5FQ1RJT05fSURfS0VZID0gU3ltYm9sKCdjb25uZWN0aW9uSUQnKTtcblxuZXhwb3J0IGNsYXNzIExlYWRlcmJvYXJkRGF0YUNsaWVudCBpbXBsZW1lbnRzIElMZWFkZXJib2FyZERhdGFDbGllbnQge1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IExlYWRlcmJvYXJkQ29uZmlndXJhdGlvbjtcbiAgcHJpdmF0ZSByZWFkb25seSBjcmVkZW50aWFsUHJvdmlkZXI6IENyZWRlbnRpYWxQcm92aWRlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXI6IENhY2hlU2VydmljZUVycm9yTWFwcGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3RUaW1lb3V0TXM6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnRXcmFwcGVyczogR3JwY0NsaWVudFdyYXBwZXI8bGVhZGVyYm9hcmQuTGVhZGVyYm9hcmRDbGllbnQ+W107XG4gIHByb3RlY3RlZCBuZXh0RGF0YUNsaWVudEluZGV4OiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge0xlYWRlcmJvYXJkQ2xpZW50UHJvcHNXaXRoQ29uZmlnfSBwcm9wc1xuICAgKiBAcGFyYW0gZGF0YUNsaWVudElEXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogTGVhZGVyYm9hcmRDbGllbnRQcm9wc1dpdGhDb25maWcsIGRhdGFDbGllbnRJRDogc3RyaW5nKSB7XG4gICAgdGhpcy5jb25maWd1cmF0aW9uID0gcHJvcHMuY29uZmlndXJhdGlvbjtcbiAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyID0gbmV3IENhY2hlU2VydmljZUVycm9yTWFwcGVyKFxuICAgICAgcHJvcHMuY29uZmlndXJhdGlvbi5nZXRUaHJvd09uRXJyb3JzKClcbiAgICApO1xuICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIHRoaXMubG9nZ2VyID0gdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIodGhpcyk7XG4gICAgY29uc3QgZ3JwY0NvbmZpZyA9IHRoaXMuY29uZmlndXJhdGlvblxuICAgICAgLmdldFRyYW5zcG9ydFN0cmF0ZWd5KClcbiAgICAgIC5nZXRHcnBjQ29uZmlnKCk7XG5cbiAgICB0aGlzLnJlcXVlc3RUaW1lb3V0TXMgPSBncnBjQ29uZmlnLmdldERlYWRsaW5lTWlsbGlzKCk7XG4gICAgdGhpcy52YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KHRoaXMucmVxdWVzdFRpbWVvdXRNcyk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICBgQ3JlYXRpbmcgbGVhZGVyYm9hcmQgY2xpZW50IHVzaW5nIGVuZHBvaW50OiAnJHt0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRDYWNoZUVuZHBvaW50KCl9J2BcbiAgICApO1xuXG4gICAgY29uc3QgbnVtRGF0YUNsaWVudHMgPSBncnBjQ29uZmlnLmdldE51bUNsaWVudHMoKTtcblxuICAgIC8vIFdlIHJvdW5kLXJvYmluIHRoZSByZXF1ZXN0cyB0aHJvdWdoIGFsbCBvZiBvdXIgY2xpZW50cy4gIFNpbmNlIGphdmFzY3JpcHRcbiAgICAvLyBpcyBzaW5nbGUtdGhyZWFkZWQsIHdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgdGhyZWFkIHNhZmV0eSBvbiB0aGlzXG4gICAgLy8gaW5kZXggdmFyaWFibGUuXG4gICAgdGhpcy5uZXh0RGF0YUNsaWVudEluZGV4ID0gMDtcblxuICAgIGNvbnN0IGNoYW5uZWxPcHRpb25zID0gZ3JwY0NoYW5uZWxPcHRpb25zRnJvbUdycGNDb25maWcoZ3JwY0NvbmZpZyk7XG5cbiAgICB0aGlzLmNsaWVudFdyYXBwZXJzID0gcmFuZ2UobnVtRGF0YUNsaWVudHMpLm1hcChcbiAgICAgICgpID0+XG4gICAgICAgIG5ldyBJZGxlR3JwY0NsaWVudFdyYXBwZXIoe1xuICAgICAgICAgIGNsaWVudEZhY3RvcnlGbjogKCkgPT5cbiAgICAgICAgICAgIG5ldyBsZWFkZXJib2FyZC5MZWFkZXJib2FyZENsaWVudChcbiAgICAgICAgICAgICAgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpLFxuICAgICAgICAgICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKCksXG4gICAgICAgICAgICAgIGNoYW5uZWxPcHRpb25zXG4gICAgICAgICAgICApLFxuICAgICAgICAgIGxvZ2dlckZhY3Rvcnk6IHRoaXMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCksXG4gICAgICAgICAgbWF4SWRsZU1pbGxpczogdGhpcy5jb25maWd1cmF0aW9uXG4gICAgICAgICAgICAuZ2V0VHJhbnNwb3J0U3RyYXRlZ3koKVxuICAgICAgICAgICAgLmdldE1heElkbGVNaWxsaXMoKSxcbiAgICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgY29udGV4dDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dCA9IHt9O1xuICAgIGNvbnRleHRbQ09OTkVDVElPTl9JRF9LRVldID0gZGF0YUNsaWVudElEO1xuICAgIHRoaXMuaW50ZXJjZXB0b3JzID0gdGhpcy5pbml0aWFsaXplSW50ZXJjZXB0b3JzKFxuICAgICAgdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKSxcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5nZXRNaWRkbGV3YXJlcygpLFxuICAgICAgY29udGV4dFxuICAgICk7XG4gIH1cblxuICBjbG9zZSgpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnQ2xvc2luZyBsZWFkZXJib2FyZCBkYXRhIGNsaWVudHMnKTtcbiAgICB0aGlzLmNsaWVudFdyYXBwZXJzLm1hcCh3cmFwcGVyID0+IHdyYXBwZXIuZ2V0Q2xpZW50KCkuY2xvc2UoKSk7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUmVxdWVzdFRpbWVvdXQodGltZW91dD86IG51bWJlcikge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBSZXF1ZXN0IHRpbWVvdXQgbXM6ICR7U3RyaW5nKHRpbWVvdXQpfWApO1xuICAgIGlmICh0aW1lb3V0ICE9PSB1bmRlZmluZWQgJiYgdGltZW91dCA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50RXJyb3IoXG4gICAgICAgICdyZXF1ZXN0IHRpbWVvdXQgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4nXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUludGVyY2VwdG9ycyhcbiAgICBfbG9nZ2VyRmFjdG9yeTogTW9tZW50b0xvZ2dlckZhY3RvcnksXG4gICAgbWlkZGxld2FyZXM6IE1pZGRsZXdhcmVbXSxcbiAgICBtaWRkbGV3YXJlUmVxdWVzdENvbnRleHQ6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHRcbiAgKTogSW50ZXJjZXB0b3JbXSB7XG4gICAgY29uc3QgaGVhZGVycyA9IFtcbiAgICAgIG5ldyBIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCB0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRBdXRoVG9rZW4oKSksXG4gICAgICBuZXcgSGVhZGVyKCdBZ2VudCcsIGBub2RlanM6JHt2ZXJzaW9ufWApLFxuICAgIF07XG4gICAgcmV0dXJuIFtcbiAgICAgIG1pZGRsZXdhcmVzSW50ZXJjZXB0b3IoXG4gICAgICAgIF9sb2dnZXJGYWN0b3J5LFxuICAgICAgICBtaWRkbGV3YXJlcyxcbiAgICAgICAgbWlkZGxld2FyZVJlcXVlc3RDb250ZXh0XG4gICAgICApLFxuICAgICAgbmV3IEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXIoaGVhZGVycykuY3JlYXRlSGVhZGVyc0ludGVyY2VwdG9yKCksXG4gICAgICBDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3IodGhpcy5yZXF1ZXN0VGltZW91dE1zKSxcbiAgICBdO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNZXRhZGF0YShjYWNoZU5hbWU6IHN0cmluZyk6IE1ldGFkYXRhIHtcbiAgICBjb25zdCBtZXRhZGF0YSA9IG5ldyBNZXRhZGF0YSgpO1xuICAgIG1ldGFkYXRhLnNldCgnY2FjaGUnLCBjYWNoZU5hbWUpO1xuICAgIHJldHVybiBtZXRhZGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydE1hcE9yUmVjb3JkVG9FbGVtZW50c0xpc3QoXG4gICAgZWxlbWVudHM6IFJlY29yZDxudW1iZXIsIG51bWJlcj4gfCBNYXA8bnVtYmVyLCBudW1iZXI+XG4gICk6IF9FbGVtZW50W10ge1xuICAgIGNvbnN0IGNvbnZlcnRlZEVsZW1lbnRzOiBfRWxlbWVudFtdID0gW107XG4gICAgaWYgKGVsZW1lbnRzIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICBlbGVtZW50cy5mb3JFYWNoKChzY29yZSwgaWQpID0+XG4gICAgICAgIGNvbnZlcnRlZEVsZW1lbnRzLnB1c2gobmV3IF9FbGVtZW50KHtpZDogaWQsIHNjb3JlOiBzY29yZX0pKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmVudHJpZXMoZWxlbWVudHMpLmZvckVhY2goZWxlbWVudCA9PlxuICAgICAgICBjb252ZXJ0ZWRFbGVtZW50cy5wdXNoKFxuICAgICAgICAgIG5ldyBfRWxlbWVudCh7aWQ6IE51bWJlcihlbGVtZW50WzBdKSwgc2NvcmU6IGVsZW1lbnRbMV19KVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gY29udmVydGVkRWxlbWVudHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBzZXJ0KFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIGVsZW1lbnRzOiBSZWNvcmQ8bnVtYmVyLCBudW1iZXI+IHwgTWFwPG51bWJlciwgbnVtYmVyPlxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkVXBzZXJ0LlJlc3BvbnNlPiB7XG4gICAgY29uc3Qgc2l6ZSA9XG4gICAgICBlbGVtZW50cyBpbnN0YW5jZW9mIE1hcCA/IGVsZW1lbnRzLnNpemUgOiBPYmplY3Qua2V5cyhlbGVtZW50cykubGVuZ3RoO1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUxlYWRlcmJvYXJkTnVtYmVyT2ZFbGVtZW50cyhzaXplKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IExlYWRlcmJvYXJkVXBzZXJ0LkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ3Vwc2VydCcgcmVxdWVzdDsgY2FjaGU6ICR7Y2FjaGVOYW1lfSwgbGVhZGVyYm9hcmQ6ICR7bGVhZGVyYm9hcmROYW1lfSwgbnVtYmVyIG9mIGVsZW1lbnRzOiAke3NpemV9YFxuICAgICk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFVwc2VydChjYWNoZU5hbWUsIGxlYWRlcmJvYXJkTmFtZSwgZWxlbWVudHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kVXBzZXJ0KFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIGVsZW1lbnRzOiBSZWNvcmQ8bnVtYmVyLCBudW1iZXI+IHwgTWFwPG51bWJlciwgbnVtYmVyPlxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkVXBzZXJ0LlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBsZWFkZXJib2FyZC5fVXBzZXJ0RWxlbWVudHNSZXF1ZXN0KHtcbiAgICAgIGNhY2hlX25hbWU6IGNhY2hlTmFtZSxcbiAgICAgIGxlYWRlcmJvYXJkOiBsZWFkZXJib2FyZE5hbWUsXG4gICAgICBlbGVtZW50czogdGhpcy5jb252ZXJ0TWFwT3JSZWNvcmRUb0VsZW1lbnRzTGlzdChlbGVtZW50cyksXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKGNhY2hlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKS5VcHNlcnRFbGVtZW50cyhcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwOiB1bmtub3duKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExlYWRlcmJvYXJkVXBzZXJ0LlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGVhZGVyYm9hcmRVcHNlcnQuRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBmZXRjaEJ5U2NvcmUoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmcsXG4gICAgbWluU2NvcmU/OiBudW1iZXIsXG4gICAgbWF4U2NvcmU/OiBudW1iZXIsXG4gICAgb3JkZXI/OiBMZWFkZXJib2FyZE9yZGVyLFxuICAgIG9mZnNldD86IG51bWJlcixcbiAgICBjb3VudD86IG51bWJlclxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkRmV0Y2guUmVzcG9uc2U+IHtcbiAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9mZnNldCA9PT0gdW5kZWZpbmVkID8gMCA6IG9mZnNldDtcbiAgICBjb25zdCBjb3VudFZhbHVlID0gY291bnQgPT09IHVuZGVmaW5lZCA/IDgxOTIgOiBjb3VudDtcbiAgICBjb25zdCBvcmRlclZhbHVlID0gb3JkZXIgPz8gTGVhZGVyYm9hcmRPcmRlci5Bc2NlbmRpbmc7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlU29ydGVkU2V0U2NvcmVzKG1pblNjb3JlLCBtYXhTY29yZSk7XG4gICAgICB2YWxpZGF0ZUxlYWRlcmJvYXJkT2Zmc2V0KG9mZnNldFZhbHVlKTtcbiAgICAgIHZhbGlkYXRlTGVhZGVyYm9hcmRDb3VudChjb3VudFZhbHVlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IExlYWRlcmJvYXJkRmV0Y2guRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICBgSXNzdWluZyAnZmV0Y2hCeVNjb3JlJyByZXF1ZXN0OyBjYWNoZTogJHtjYWNoZU5hbWV9LCBsZWFkZXJib2FyZDogJHtsZWFkZXJib2FyZE5hbWV9LCBvcmRlcjogJHtvcmRlclZhbHVlLnRvU3RyaW5nKCl9LCBtaW5TY29yZTogJHtcbiAgICAgICAgbWluU2NvcmUgPz8gJ251bGwnXG4gICAgICB9LCBtYXhTY29yZTogJHtcbiAgICAgICAgbWF4U2NvcmU/LnRvU3RyaW5nKCkgPz8gJ251bGwnXG4gICAgICB9LCBvZmZzZXQ6ICR7b2Zmc2V0VmFsdWUudG9TdHJpbmcoKX0sIGNvdW50OiAke2NvdW50VmFsdWUudG9TdHJpbmcoKX1gXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kRmV0Y2hCeVNjb3JlKFxuICAgICAgY2FjaGVOYW1lLFxuICAgICAgbGVhZGVyYm9hcmROYW1lLFxuICAgICAgb3JkZXJWYWx1ZSxcbiAgICAgIG9mZnNldFZhbHVlLFxuICAgICAgY291bnRWYWx1ZSxcbiAgICAgIG1pblNjb3JlLFxuICAgICAgbWF4U2NvcmVcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kRmV0Y2hCeVNjb3JlKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIG9yZGVyOiBMZWFkZXJib2FyZE9yZGVyLFxuICAgIG9mZnNldDogbnVtYmVyLFxuICAgIGNvdW50OiBudW1iZXIsXG4gICAgbWluU2NvcmU/OiBudW1iZXIsXG4gICAgbWF4U2NvcmU/OiBudW1iZXJcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZEZldGNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcHJvdG9CdWZPcmRlciA9XG4gICAgICBvcmRlciA9PT0gTGVhZGVyYm9hcmRPcmRlci5EZXNjZW5kaW5nXG4gICAgICAgID8gbGVhZGVyYm9hcmQuX09yZGVyLkRFU0NFTkRJTkdcbiAgICAgICAgOiBsZWFkZXJib2FyZC5fT3JkZXIuQVNDRU5ESU5HO1xuXG4gICAgY29uc3QgcHJvdG9CdWZTY29yZVJhbmdlID0gbmV3IGxlYWRlcmJvYXJkLl9TY29yZVJhbmdlKCk7XG4gICAgaWYgKG1pblNjb3JlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHByb3RvQnVmU2NvcmVSYW5nZS5taW5faW5jbHVzaXZlID0gbWluU2NvcmU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHByb3RvQnVmU2NvcmVSYW5nZS51bmJvdW5kZWRfbWluID0gbmV3IGxlYWRlcmJvYXJkLl9VbmJvdW5kZWQoKTtcbiAgICB9XG4gICAgaWYgKG1heFNjb3JlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHByb3RvQnVmU2NvcmVSYW5nZS5tYXhfZXhjbHVzaXZlID0gbWF4U2NvcmU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHByb3RvQnVmU2NvcmVSYW5nZS51bmJvdW5kZWRfbWF4ID0gbmV3IGxlYWRlcmJvYXJkLl9VbmJvdW5kZWQoKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGxlYWRlcmJvYXJkLl9HZXRCeVNjb3JlUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgICBsZWFkZXJib2FyZDogbGVhZGVyYm9hcmROYW1lLFxuICAgICAgc2NvcmVfcmFuZ2U6IHByb3RvQnVmU2NvcmVSYW5nZSxcbiAgICAgIG9yZGVyOiBwcm90b0J1Zk9yZGVyLFxuICAgICAgb2Zmc2V0OiBvZmZzZXQsXG4gICAgICBsaW1pdF9lbGVtZW50czogY291bnQsXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKGNhY2hlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKS5HZXRCeVNjb3JlKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAge1xuICAgICAgICAgIGludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnMsXG4gICAgICAgIH0sXG4gICAgICAgIChlcnI6IFNlcnZpY2VFcnJvciB8IG51bGwsIHJlc3A6IHVua25vd24pID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgY29uc3QgZm91bmRFbGVtZW50cyA9IChyZXNwIGFzIGxlYWRlcmJvYXJkLl9HZXRCeVNjb3JlUmVzcG9uc2UpXG4gICAgICAgICAgICAgIC5lbGVtZW50cztcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExlYWRlcmJvYXJkRmV0Y2guU3VjY2Vzcyhmb3VuZEVsZW1lbnRzKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGVhZGVyYm9hcmRGZXRjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGZldGNoQnlSYW5rKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIHN0YXJ0UmFuazogbnVtYmVyLFxuICAgIGVuZFJhbms6IG51bWJlcixcbiAgICBvcmRlcj86IExlYWRlcmJvYXJkT3JkZXJcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZEZldGNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmFua09yZGVyID0gb3JkZXIgPz8gTGVhZGVyYm9hcmRPcmRlci5Bc2NlbmRpbmc7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlTGVhZGVyYm9hcmRSYW5rcyhzdGFydFJhbmssIGVuZFJhbmspO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgIGVyciA9PiBuZXcgTGVhZGVyYm9hcmRGZXRjaC5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdmZXRjaEJ5UmFuaycgcmVxdWVzdDsgY2FjaGU6ICR7Y2FjaGVOYW1lfSwgbGVhZGVyYm9hcmQ6ICR7bGVhZGVyYm9hcmROYW1lfSwgb3JkZXI6ICR7cmFua09yZGVyLnRvU3RyaW5nKCl9LCBzdGFydFJhbms6ICR7c3RhcnRSYW5rfSwgZW5kUmFuazogJHtlbmRSYW5rfWBcbiAgICApO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRGZXRjaEJ5UmFuayhcbiAgICAgIGNhY2hlTmFtZSxcbiAgICAgIGxlYWRlcmJvYXJkTmFtZSxcbiAgICAgIHN0YXJ0UmFuayxcbiAgICAgIGVuZFJhbmssXG4gICAgICByYW5rT3JkZXJcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kRmV0Y2hCeVJhbmsoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmcsXG4gICAgc3RhcnRSYW5rOiBudW1iZXIsXG4gICAgZW5kUmFuazogbnVtYmVyLFxuICAgIG9yZGVyOiBMZWFkZXJib2FyZE9yZGVyXG4gICk6IFByb21pc2U8TGVhZGVyYm9hcmRGZXRjaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHByb3RvQnVmT3JkZXIgPVxuICAgICAgb3JkZXIgPT09IExlYWRlcmJvYXJkT3JkZXIuRGVzY2VuZGluZ1xuICAgICAgICA/IGxlYWRlcmJvYXJkLl9PcmRlci5ERVNDRU5ESU5HXG4gICAgICAgIDogbGVhZGVyYm9hcmQuX09yZGVyLkFTQ0VORElORztcblxuICAgIGNvbnN0IHByb3RvQnVmUmFua1JhbmdlID0gbmV3IGxlYWRlcmJvYXJkLl9SYW5rUmFuZ2Uoe1xuICAgICAgc3RhcnRfaW5jbHVzaXZlOiBzdGFydFJhbmssXG4gICAgICBlbmRfZXhjbHVzaXZlOiBlbmRSYW5rLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBsZWFkZXJib2FyZC5fR2V0QnlSYW5rUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgICBsZWFkZXJib2FyZDogbGVhZGVyYm9hcmROYW1lLFxuICAgICAgcmFua19yYW5nZTogcHJvdG9CdWZSYW5rUmFuZ2UsXG4gICAgICBvcmRlcjogcHJvdG9CdWZPcmRlcixcbiAgICB9KTtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuY3JlYXRlTWV0YWRhdGEoY2FjaGVOYW1lKTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5nZXROZXh0RGF0YUNsaWVudCgpLkdldEJ5UmFuayhcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwOiB1bmtub3duKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIGNvbnN0IGZvdW5kRWxlbWVudHMgPSAocmVzcCBhcyBsZWFkZXJib2FyZC5fR2V0QnlSYW5rUmVzcG9uc2UpXG4gICAgICAgICAgICAgIC5lbGVtZW50cztcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExlYWRlcmJvYXJkRmV0Y2guU3VjY2Vzcyhmb3VuZEVsZW1lbnRzKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGVhZGVyYm9hcmRGZXRjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFJhbmsoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmcsXG4gICAgaWRzOiBBcnJheTxudW1iZXI+LFxuICAgIG9yZGVyPzogTGVhZGVyYm9hcmRPcmRlclxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkRmV0Y2guUmVzcG9uc2U+IHtcbiAgICBjb25zdCBvcmRlclZhbHVlID0gb3JkZXIgPz8gTGVhZGVyYm9hcmRPcmRlci5Bc2NlbmRpbmc7XG4gICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICBgSXNzdWluZyAnZ2V0UmFuaycgcmVxdWVzdDsgY2FjaGU6ICR7Y2FjaGVOYW1lfSwgbGVhZGVyYm9hcmQ6ICR7bGVhZGVyYm9hcmROYW1lfSwgb3JkZXI6ICR7b3JkZXJWYWx1ZS50b1N0cmluZygpfSwgbnVtYmVyIG9mIGlkczogJHtcbiAgICAgICAgaWRzLmxlbmd0aFxuICAgICAgfWBcbiAgICApO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRHZXRSYW5rKGNhY2hlTmFtZSwgbGVhZGVyYm9hcmROYW1lLCBpZHMsIG9yZGVyVmFsdWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kR2V0UmFuayhcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBpZHM6IEFycmF5PG51bWJlcj4sXG4gICAgb3JkZXI6IExlYWRlcmJvYXJkT3JkZXJcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZEZldGNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcHJvdG9CdWZPcmRlciA9XG4gICAgICBvcmRlciA9PT0gTGVhZGVyYm9hcmRPcmRlci5EZXNjZW5kaW5nXG4gICAgICAgID8gbGVhZGVyYm9hcmQuX09yZGVyLkRFU0NFTkRJTkdcbiAgICAgICAgOiBsZWFkZXJib2FyZC5fT3JkZXIuQVNDRU5ESU5HO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBsZWFkZXJib2FyZC5fR2V0UmFua1JlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgbGVhZGVyYm9hcmQ6IGxlYWRlcmJvYXJkTmFtZSxcbiAgICAgIGlkczogaWRzLFxuICAgICAgb3JkZXI6IHByb3RvQnVmT3JkZXIsXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKGNhY2hlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKS5HZXRSYW5rKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAge1xuICAgICAgICAgIGludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnMsXG4gICAgICAgIH0sXG4gICAgICAgIChlcnI6IFNlcnZpY2VFcnJvciB8IG51bGwsIHJlc3A6IHVua25vd24pID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgY29uc3QgZm91bmRFbGVtZW50cyA9IChyZXNwIGFzIGxlYWRlcmJvYXJkLl9HZXRSYW5rUmVzcG9uc2UpXG4gICAgICAgICAgICAgIC5lbGVtZW50cztcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExlYWRlcmJvYXJkRmV0Y2guU3VjY2Vzcyhmb3VuZEVsZW1lbnRzKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGVhZGVyYm9hcmRGZXRjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxlbmd0aChcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPExlYWRlcmJvYXJkTGVuZ3RoLlJlc3BvbnNlPiB7XG4gICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICBgSXNzdWluZyAnbGVuZ3RoJyByZXF1ZXN0OyBjYWNoZTogJHtjYWNoZU5hbWV9LCBsZWFkZXJib2FyZDogJHtsZWFkZXJib2FyZE5hbWV9YFxuICAgICk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZExlbmd0aChjYWNoZU5hbWUsIGxlYWRlcmJvYXJkTmFtZSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRMZW5ndGgoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZExlbmd0aC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgbGVhZGVyYm9hcmQuX0dldExlYWRlcmJvYXJkTGVuZ3RoUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgICBsZWFkZXJib2FyZDogbGVhZGVyYm9hcmROYW1lLFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShjYWNoZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldE5leHREYXRhQ2xpZW50KCkuR2V0TGVhZGVyYm9hcmRMZW5ndGgoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVycjogU2VydmljZUVycm9yIHwgbnVsbCwgcmVzcDogdW5rbm93bikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICBjb25zdCBsZW5ndGggPSAocmVzcCBhcyBsZWFkZXJib2FyZC5fR2V0TGVhZGVyYm9hcmRMZW5ndGhSZXNwb25zZSlcbiAgICAgICAgICAgICAgLmNvdW50O1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgTGVhZGVyYm9hcmRMZW5ndGguU3VjY2VzcyhsZW5ndGgpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXNvbHZlT3JSZWplY3RFcnJvcih7XG4gICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICBlcnJvclJlc3BvbnNlRmFjdG9yeUZuOiBlID0+IG5ldyBMZWFkZXJib2FyZExlbmd0aC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbW92ZUVsZW1lbnRzKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIGlkczogQXJyYXk8bnVtYmVyPlxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkUmVtb3ZlRWxlbWVudHMuUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVMZWFkZXJib2FyZE51bWJlck9mRWxlbWVudHMoaWRzLmxlbmd0aCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBMZWFkZXJib2FyZFJlbW92ZUVsZW1lbnRzLkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ3JlbW92ZUVsZW1lbnRzJyByZXF1ZXN0OyBjYWNoZTogJHtjYWNoZU5hbWV9LCBsZWFkZXJib2FyZDogJHtsZWFkZXJib2FyZE5hbWV9LCBudW1iZXIgb2YgZWxlbWVudHM6ICR7aWRzLmxlbmd0aC50b1N0cmluZygpfWBcbiAgICApO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRSZW1vdmVFbGVtZW50cyhjYWNoZU5hbWUsIGxlYWRlcmJvYXJkTmFtZSwgaWRzKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFJlbW92ZUVsZW1lbnRzKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIGlkczogQXJyYXk8bnVtYmVyPlxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkUmVtb3ZlRWxlbWVudHMuUmVzcG9uc2U+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGxlYWRlcmJvYXJkLl9SZW1vdmVFbGVtZW50c1JlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgbGVhZGVyYm9hcmQ6IGxlYWRlcmJvYXJkTmFtZSxcbiAgICAgIGlkczogaWRzLFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShjYWNoZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldE5leHREYXRhQ2xpZW50KCkuUmVtb3ZlRWxlbWVudHMoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVycjogU2VydmljZUVycm9yIHwgbnVsbCwgcmVzcDogdW5rbm93bikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMZWFkZXJib2FyZFJlbW92ZUVsZW1lbnRzLlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PlxuICAgICAgICAgICAgICAgIG5ldyBMZWFkZXJib2FyZFJlbW92ZUVsZW1lbnRzLkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nXG4gICk6IFByb21pc2U8TGVhZGVyYm9hcmREZWxldGUuUmVzcG9uc2U+IHtcbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdkZWxldGUnIHJlcXVlc3Q7IGNhY2hlOiAke2NhY2hlTmFtZX0sIGxlYWRlcmJvYXJkOiAke2xlYWRlcmJvYXJkTmFtZX1gXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kRGVsZXRlKGNhY2hlTmFtZSwgbGVhZGVyYm9hcmROYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZERlbGV0ZShcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPExlYWRlcmJvYXJkRGVsZXRlLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBsZWFkZXJib2FyZC5fRGVsZXRlTGVhZGVyYm9hcmRSZXF1ZXN0KHtcbiAgICAgIGNhY2hlX25hbWU6IGNhY2hlTmFtZSxcbiAgICAgIGxlYWRlcmJvYXJkOiBsZWFkZXJib2FyZE5hbWUsXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKGNhY2hlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKS5EZWxldGVMZWFkZXJib2FyZChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwOiB1bmtub3duKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExlYWRlcmJvYXJkRGVsZXRlLlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGVhZGVyYm9hcmREZWxldGUuRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXROZXh0RGF0YUNsaWVudCgpOiBsZWFkZXJib2FyZC5MZWFkZXJib2FyZENsaWVudCB7XG4gICAgY29uc3QgY2xpZW50V3JhcHBlciA9IHRoaXMuY2xpZW50V3JhcHBlcnNbdGhpcy5uZXh0RGF0YUNsaWVudEluZGV4XTtcbiAgICB0aGlzLm5leHREYXRhQ2xpZW50SW5kZXggPVxuICAgICAgKHRoaXMubmV4dERhdGFDbGllbnRJbmRleCArIDEpICUgdGhpcy5jbGllbnRXcmFwcGVycy5sZW5ndGg7XG4gICAgcmV0dXJuIGNsaWVudFdyYXBwZXIuZ2V0Q2xpZW50KCk7XG4gIH1cbn1cbiJdfQ==