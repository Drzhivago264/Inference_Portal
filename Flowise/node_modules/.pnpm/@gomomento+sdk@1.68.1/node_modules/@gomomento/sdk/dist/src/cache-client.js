"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SimpleCacheClient = exports.CacheClient = void 0;
const cache_control_client_1 = require("./internal/cache-control-client");
const cache_data_client_1 = require("./internal/cache-data-client");
const _1 = require(".");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractCacheClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/cache/AbstractCacheClient");
const EAGER_CONNECTION_DEFAULT_TIMEOUT_SECONDS = 30;
/**
 * Momento Cache Client.
 *
 * Features include:
 * - Get, set, and delete data
 * - Create, delete, and list caches
 * - Create, revoke, and list signing keys
 */
class CacheClient extends AbstractCacheClient_1.AbstractCacheClient {
    /**
     * Creates an instance of CacheClient.
     * @param {CacheClientProps} props configuration and credentials for creating a CacheClient.
     */
    constructor(props) {
        var _a;
        (0, utils_1.validateTtlSeconds)(props.defaultTtlSeconds);
        const configuration = (_a = props.configuration) !== null && _a !== void 0 ? _a : getDefaultCacheClientConfiguration();
        const propsWithConfig = {
            ...props,
            configuration: configuration,
        };
        const controlClient = new cache_control_client_1.CacheControlClient({
            configuration: configuration,
            credentialProvider: props.credentialProvider,
        });
        const numClients = configuration
            .getTransportStrategy()
            .getGrpcConfig()
            .getNumClients();
        const dataClients = (0, utils_1.range)(numClients).map((_, id) => new cache_data_client_1.CacheDataClient(propsWithConfig, String(id)));
        super(controlClient, dataClients);
        this.configuration = configuration;
        this.notYetAbstractedControlClient = controlClient;
        this.logger = configuration.getLoggerFactory().getLogger(this);
        this.logger.debug('Creating Momento CacheClient');
    }
    close() {
        this.controlClient.close();
        this.dataClients.map(dc => dc.close());
        this.configuration.getMiddlewares().map(m => {
            if (m.close) {
                m.close();
            }
        });
    }
    /**
     * Creates a new instance of CacheClient. If eagerConnectTimeout is present in the given props, the client will
     * eagerly create its connection to Momento. It will wait until the connection is established, or until the timout
     * runs out. It the timeout runs out, the client will be valid to use, but it may still be connecting in the background.
     * @param {EagerCacheClientProps} props configuration and credentials for creating a CacheClient.
     */
    static async create(props) {
        const client = new CacheClient(props);
        const timeout = props.eagerConnectTimeout !== undefined
            ? props.eagerConnectTimeout
            : EAGER_CONNECTION_DEFAULT_TIMEOUT_SECONDS;
        // eslint-disable-next-line @typescript-eslint/no-unsafe-call
        (0, utils_1.validateTimeout)(timeout);
        // client need to explicitly set the value as 0 to disable eager connection.
        if (props.eagerConnectTimeout !== 0) {
            await Promise.all(client.dataClients.map(dc => dc.connect(timeout)));
        }
        return client;
    }
    /**
     * Flushes / clears all the items of the given cache
     *
     * @param {string} cacheName - The cache to be flushed.
     * @returns {Promise<CacheFlush.Response>} -
     * {@link CacheFlush.Success} on success.
     * {@link CacheFlush.Error} on failure.
     */
    async flushCache(cacheName) {
        return await this.notYetAbstractedControlClient.flushCache(cacheName);
    }
    /**
     * Creates a Momento signing key.
     *
     * @param {number} ttlMinutes - The time to live in minutes until the Momento
     * signing key expires.
     * @returns {Promise<CreateSigningKey.Response>} -
     * {@link CreateSigningKey.Success} containing the key, key ID, endpoint, and
     * expiration date on success.
     * {@link CreateSigningKey.Error} on failure.
     */
    async createSigningKey(ttlMinutes) {
        const client = this.getNextDataClient();
        return await this.notYetAbstractedControlClient.createSigningKey(ttlMinutes, client.getEndpoint());
    }
    /**
     * Revokes a Momento signing key.
     *
     * @remarks
     * All tokens signed by this key will be invalid.
     *
     * @param {string} keyId - The ID of the key to revoke.
     * @returns {Promise<RevokeSigningKey.Response>} -
     * {@link RevokeSigningKey.Success} on success.
     * {@link RevokeSigningKey.Error} on failure.
     */
    async revokeSigningKey(keyId) {
        return await this.notYetAbstractedControlClient.revokeSigningKey(keyId);
    }
    /**
     * Lists all Momento signing keys for the provided auth token.
     *
     * @returns {Promise<ListSigningKeys.Response>} -
     * {@link ListSigningKeys.Success} containing the keys on success.
     * {@link ListSigningKeys.Error} on failure.
     */
    async listSigningKeys() {
        const client = this.getNextDataClient();
        return await this.notYetAbstractedControlClient.listSigningKeys(client.getEndpoint());
    }
    getNextDataClient() {
        const client = this.dataClients[this.nextDataClientIndex];
        this.nextDataClientIndex =
            (this.nextDataClientIndex + 1) % this.dataClients.length;
        return client;
    }
}
exports.CacheClient = CacheClient;
function getDefaultCacheClientConfiguration() {
    const config = _1.Configurations.Laptop.latest();
    const logger = config.getLoggerFactory().getLogger('CacheClient');
    logger.info('No configuration provided to CacheClient. Using default "Laptop" configuration, suitable for development. For production use, consider specifying an explicit configuration.');
    return config;
}
/**
 * @deprecated use {CacheClient} instead
 */
class SimpleCacheClient extends CacheClient {
}
exports.SimpleCacheClient = SimpleCacheClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NhY2hlLWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwRUFBbUU7QUFDbkUsb0VBQTZEO0FBQzdELHdCQVFXO0FBRVgsdUVBSXFEO0FBRXJELGlIQUE0RztBQUc1RyxNQUFNLHdDQUF3QyxHQUFHLEVBQUUsQ0FBQztBQUVwRDs7Ozs7OztHQU9HO0FBQ0gsTUFBYSxXQUFZLFNBQVEseUNBQW1CO0lBS2xEOzs7T0FHRztJQUNILFlBQVksS0FBdUI7O1FBQ2pDLElBQUEsMEJBQWtCLEVBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDNUMsTUFBTSxhQUFhLEdBQ2pCLE1BQUEsS0FBSyxDQUFDLGFBQWEsbUNBQUksa0NBQWtDLEVBQUUsQ0FBQztRQUM5RCxNQUFNLGVBQWUsR0FBK0I7WUFDbEQsR0FBRyxLQUFLO1lBQ1IsYUFBYSxFQUFFLGFBQWE7U0FDN0IsQ0FBQztRQUVGLE1BQU0sYUFBYSxHQUFHLElBQUkseUNBQWtCLENBQUM7WUFDM0MsYUFBYSxFQUFFLGFBQWE7WUFDNUIsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLGtCQUFrQjtTQUM3QyxDQUFDLENBQUM7UUFFSCxNQUFNLFVBQVUsR0FBRyxhQUFhO2FBQzdCLG9CQUFvQixFQUFFO2FBQ3RCLGFBQWEsRUFBRTthQUNmLGFBQWEsRUFBRSxDQUFDO1FBQ25CLE1BQU0sV0FBVyxHQUFHLElBQUEsYUFBSyxFQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FDdkMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLG1DQUFlLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUM1RCxDQUFDO1FBQ0YsS0FBSyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztRQUNu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RjtBQTVJRCxrQ0E0SUM7QUFFRCxTQUFTLGtDQUFrQztJQUN6QyxNQUFNLE1BQU0sR0FBRyxpQkFBYyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM5QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbEUsTUFBTSxDQUFDLElBQUksQ0FDVCw4S0FBOEssQ0FDL0ssQ0FBQztJQUNGLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFFRDs7R0FFRztBQUNILE1BQWEsaUJBQWtCLFNBQVEsV0FBVztDQUFHO0FBQXJELDhDQUFxRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2FjaGVDb250cm9sQ2xpZW50fSBmcm9tICcuL2ludGVybmFsL2NhY2hlLWNvbnRyb2wtY2xpZW50JztcbmltcG9ydCB7Q2FjaGVEYXRhQ2xpZW50fSBmcm9tICcuL2ludGVybmFsL2NhY2hlLWRhdGEtY2xpZW50JztcbmltcG9ydCB7XG4gIENyZWF0ZVNpZ25pbmdLZXksXG4gIExpc3RTaWduaW5nS2V5cyxcbiAgUmV2b2tlU2lnbmluZ0tleSxcbiAgQ2FjaGVGbHVzaCxcbiAgTW9tZW50b0xvZ2dlcixcbiAgQ29uZmlndXJhdGlvbixcbiAgQ29uZmlndXJhdGlvbnMsXG59IGZyb20gJy4nO1xuaW1wb3J0IHtDYWNoZUNsaWVudFByb3BzLCBFYWdlckNhY2hlQ2xpZW50UHJvcHN9IGZyb20gJy4vY2FjaGUtY2xpZW50LXByb3BzJztcbmltcG9ydCB7XG4gIHJhbmdlLFxuICB2YWxpZGF0ZVRpbWVvdXQsXG4gIHZhbGlkYXRlVHRsU2Vjb25kcyxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQge0lDYWNoZUNsaWVudH0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9jbGllbnRzL0lDYWNoZUNsaWVudCc7XG5pbXBvcnQge0Fic3RyYWN0Q2FjaGVDbGllbnR9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvY2xpZW50cy9jYWNoZS9BYnN0cmFjdENhY2hlQ2xpZW50JztcbmltcG9ydCB7Q2FjaGVDbGllbnRQcm9wc1dpdGhDb25maWd9IGZyb20gJy4vaW50ZXJuYWwvY2FjaGUtY2xpZW50LXByb3BzLXdpdGgtY29uZmlnJztcblxuY29uc3QgRUFHRVJfQ09OTkVDVElPTl9ERUZBVUxUX1RJTUVPVVRfU0VDT05EUyA9IDMwO1xuXG4vKipcbiAqIE1vbWVudG8gQ2FjaGUgQ2xpZW50LlxuICpcbiAqIEZlYXR1cmVzIGluY2x1ZGU6XG4gKiAtIEdldCwgc2V0LCBhbmQgZGVsZXRlIGRhdGFcbiAqIC0gQ3JlYXRlLCBkZWxldGUsIGFuZCBsaXN0IGNhY2hlc1xuICogLSBDcmVhdGUsIHJldm9rZSwgYW5kIGxpc3Qgc2lnbmluZyBrZXlzXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZUNsaWVudCBleHRlbmRzIEFic3RyYWN0Q2FjaGVDbGllbnQgaW1wbGVtZW50cyBJQ2FjaGVDbGllbnQge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogTW9tZW50b0xvZ2dlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudDogQ2FjaGVDb250cm9sQ2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IENvbmZpZ3VyYXRpb247XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQ2FjaGVDbGllbnQuXG4gICAqIEBwYXJhbSB7Q2FjaGVDbGllbnRQcm9wc30gcHJvcHMgY29uZmlndXJhdGlvbiBhbmQgY3JlZGVudGlhbHMgZm9yIGNyZWF0aW5nIGEgQ2FjaGVDbGllbnQuXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogQ2FjaGVDbGllbnRQcm9wcykge1xuICAgIHZhbGlkYXRlVHRsU2Vjb25kcyhwcm9wcy5kZWZhdWx0VHRsU2Vjb25kcyk7XG4gICAgY29uc3QgY29uZmlndXJhdGlvbjogQ29uZmlndXJhdGlvbiA9XG4gICAgICBwcm9wcy5jb25maWd1cmF0aW9uID8/IGdldERlZmF1bHRDYWNoZUNsaWVudENvbmZpZ3VyYXRpb24oKTtcbiAgICBjb25zdCBwcm9wc1dpdGhDb25maWc6IENhY2hlQ2xpZW50UHJvcHNXaXRoQ29uZmlnID0ge1xuICAgICAgLi4ucHJvcHMsXG4gICAgICBjb25maWd1cmF0aW9uOiBjb25maWd1cmF0aW9uLFxuICAgIH07XG5cbiAgICBjb25zdCBjb250cm9sQ2xpZW50ID0gbmV3IENhY2hlQ29udHJvbENsaWVudCh7XG4gICAgICBjb25maWd1cmF0aW9uOiBjb25maWd1cmF0aW9uLFxuICAgICAgY3JlZGVudGlhbFByb3ZpZGVyOiBwcm9wcy5jcmVkZW50aWFsUHJvdmlkZXIsXG4gICAgfSk7XG5cbiAgICBjb25zdCBudW1DbGllbnRzID0gY29uZmlndXJhdGlvblxuICAgICAgLmdldFRyYW5zcG9ydFN0cmF0ZWd5KClcbiAgICAgIC5nZXRHcnBjQ29uZmlnKClcbiAgICAgIC5nZXROdW1DbGllbnRzKCk7XG4gICAgY29uc3QgZGF0YUNsaWVudHMgPSByYW5nZShudW1DbGllbnRzKS5tYXAoXG4gICAgICAoXywgaWQpID0+IG5ldyBDYWNoZURhdGFDbGllbnQocHJvcHNXaXRoQ29uZmlnLCBTdHJpbmcoaWQpKVxuICAgICk7XG4gICAgc3VwZXIoY29udHJvbENsaWVudCwgZGF0YUNsaWVudHMpO1xuICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gICAgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudCA9IGNvbnRyb2xDbGllbnQ7XG5cbiAgICB0aGlzLmxvZ2dlciA9IGNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLmdldExvZ2dlcih0aGlzKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnQ3JlYXRpbmcgTW9tZW50byBDYWNoZUNsaWVudCcpO1xuICB9XG5cbiAgcHVibGljIGNsb3NlKCkge1xuICAgIHRoaXMuY29udHJvbENsaWVudC5jbG9zZSgpO1xuICAgIHRoaXMuZGF0YUNsaWVudHMubWFwKGRjID0+IGRjLmNsb3NlKCkpO1xuICAgIHRoaXMuY29uZmlndXJhdGlvbi5nZXRNaWRkbGV3YXJlcygpLm1hcChtID0+IHtcbiAgICAgIGlmIChtLmNsb3NlKSB7XG4gICAgICAgIG0uY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgbmV3IGluc3RhbmNlIG9mIENhY2hlQ2xpZW50LiBJZiBlYWdlckNvbm5lY3RUaW1lb3V0IGlzIHByZXNlbnQgaW4gdGhlIGdpdmVuIHByb3BzLCB0aGUgY2xpZW50IHdpbGxcbiAgICogZWFnZXJseSBjcmVhdGUgaXRzIGNvbm5lY3Rpb24gdG8gTW9tZW50by4gSXQgd2lsbCB3YWl0IHVudGlsIHRoZSBjb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkLCBvciB1bnRpbCB0aGUgdGltb3V0XG4gICAqIHJ1bnMgb3V0LiBJdCB0aGUgdGltZW91dCBydW5zIG91dCwgdGhlIGNsaWVudCB3aWxsIGJlIHZhbGlkIHRvIHVzZSwgYnV0IGl0IG1heSBzdGlsbCBiZSBjb25uZWN0aW5nIGluIHRoZSBiYWNrZ3JvdW5kLlxuICAgKiBAcGFyYW0ge0VhZ2VyQ2FjaGVDbGllbnRQcm9wc30gcHJvcHMgY29uZmlndXJhdGlvbiBhbmQgY3JlZGVudGlhbHMgZm9yIGNyZWF0aW5nIGEgQ2FjaGVDbGllbnQuXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgY3JlYXRlKHByb3BzOiBFYWdlckNhY2hlQ2xpZW50UHJvcHMpOiBQcm9taXNlPENhY2hlQ2xpZW50PiB7XG4gICAgY29uc3QgY2xpZW50ID0gbmV3IENhY2hlQ2xpZW50KHByb3BzKTtcbiAgICBjb25zdCB0aW1lb3V0ID1cbiAgICAgIHByb3BzLmVhZ2VyQ29ubmVjdFRpbWVvdXQgIT09IHVuZGVmaW5lZFxuICAgICAgICA/IHByb3BzLmVhZ2VyQ29ubmVjdFRpbWVvdXRcbiAgICAgICAgOiBFQUdFUl9DT05ORUNUSU9OX0RFRkFVTFRfVElNRU9VVF9TRUNPTkRTO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWNhbGxcbiAgICB2YWxpZGF0ZVRpbWVvdXQodGltZW91dCk7XG4gICAgLy8gY2xpZW50IG5lZWQgdG8gZXhwbGljaXRseSBzZXQgdGhlIHZhbHVlIGFzIDAgdG8gZGlzYWJsZSBlYWdlciBjb25uZWN0aW9uLlxuICAgIGlmIChwcm9wcy5lYWdlckNvbm5lY3RUaW1lb3V0ICE9PSAwKSB7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgY2xpZW50LmRhdGFDbGllbnRzLm1hcChkYyA9PiAoZGMgYXMgQ2FjaGVEYXRhQ2xpZW50KS5jb25uZWN0KHRpbWVvdXQpKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNsaWVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBGbHVzaGVzIC8gY2xlYXJzIGFsbCB0aGUgaXRlbXMgb2YgdGhlIGdpdmVuIGNhY2hlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZU5hbWUgLSBUaGUgY2FjaGUgdG8gYmUgZmx1c2hlZC5cbiAgICogQHJldHVybnMge1Byb21pc2U8Q2FjaGVGbHVzaC5SZXNwb25zZT59IC1cbiAgICoge0BsaW5rIENhY2hlRmx1c2guU3VjY2Vzc30gb24gc3VjY2Vzcy5cbiAgICoge0BsaW5rIENhY2hlRmx1c2guRXJyb3J9IG9uIGZhaWx1cmUuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZmx1c2hDYWNoZShjYWNoZU5hbWU6IHN0cmluZyk6IFByb21pc2U8Q2FjaGVGbHVzaC5SZXNwb25zZT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLm5vdFlldEFic3RyYWN0ZWRDb250cm9sQ2xpZW50LmZsdXNoQ2FjaGUoY2FjaGVOYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgTW9tZW50byBzaWduaW5nIGtleS5cbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHR0bE1pbnV0ZXMgLSBUaGUgdGltZSB0byBsaXZlIGluIG1pbnV0ZXMgdW50aWwgdGhlIE1vbWVudG9cbiAgICogc2lnbmluZyBrZXkgZXhwaXJlcy5cbiAgICogQHJldHVybnMge1Byb21pc2U8Q3JlYXRlU2lnbmluZ0tleS5SZXNwb25zZT59IC1cbiAgICoge0BsaW5rIENyZWF0ZVNpZ25pbmdLZXkuU3VjY2Vzc30gY29udGFpbmluZyB0aGUga2V5LCBrZXkgSUQsIGVuZHBvaW50LCBhbmRcbiAgICogZXhwaXJhdGlvbiBkYXRlIG9uIHN1Y2Nlc3MuXG4gICAqIHtAbGluayBDcmVhdGVTaWduaW5nS2V5LkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGNyZWF0ZVNpZ25pbmdLZXkoXG4gICAgdHRsTWludXRlczogbnVtYmVyXG4gICk6IFByb21pc2U8Q3JlYXRlU2lnbmluZ0tleS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5jcmVhdGVTaWduaW5nS2V5KFxuICAgICAgdHRsTWludXRlcyxcbiAgICAgIGNsaWVudC5nZXRFbmRwb2ludCgpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXZva2VzIGEgTW9tZW50byBzaWduaW5nIGtleS5cbiAgICpcbiAgICogQHJlbWFya3NcbiAgICogQWxsIHRva2VucyBzaWduZWQgYnkgdGhpcyBrZXkgd2lsbCBiZSBpbnZhbGlkLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5SWQgLSBUaGUgSUQgb2YgdGhlIGtleSB0byByZXZva2UuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFJldm9rZVNpZ25pbmdLZXkuUmVzcG9uc2U+fSAtXG4gICAqIHtAbGluayBSZXZva2VTaWduaW5nS2V5LlN1Y2Nlc3N9IG9uIHN1Y2Nlc3MuXG4gICAqIHtAbGluayBSZXZva2VTaWduaW5nS2V5LkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIHJldm9rZVNpZ25pbmdLZXkoXG4gICAga2V5SWQ6IHN0cmluZ1xuICApOiBQcm9taXNlPFJldm9rZVNpZ25pbmdLZXkuUmVzcG9uc2U+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5yZXZva2VTaWduaW5nS2V5KGtleUlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBhbGwgTW9tZW50byBzaWduaW5nIGtleXMgZm9yIHRoZSBwcm92aWRlZCBhdXRoIHRva2VuLlxuICAgKlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxMaXN0U2lnbmluZ0tleXMuUmVzcG9uc2U+fSAtXG4gICAqIHtAbGluayBMaXN0U2lnbmluZ0tleXMuU3VjY2Vzc30gY29udGFpbmluZyB0aGUga2V5cyBvbiBzdWNjZXNzLlxuICAgKiB7QGxpbmsgTGlzdFNpZ25pbmdLZXlzLkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGxpc3RTaWduaW5nS2V5cygpOiBQcm9taXNlPExpc3RTaWduaW5nS2V5cy5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5saXN0U2lnbmluZ0tleXMoXG4gICAgICBjbGllbnQuZ2V0RW5kcG9pbnQoKVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0TmV4dERhdGFDbGllbnQoKTogQ2FjaGVEYXRhQ2xpZW50IHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmRhdGFDbGllbnRzW3RoaXMubmV4dERhdGFDbGllbnRJbmRleF07XG4gICAgdGhpcy5uZXh0RGF0YUNsaWVudEluZGV4ID1cbiAgICAgICh0aGlzLm5leHREYXRhQ2xpZW50SW5kZXggKyAxKSAlIHRoaXMuZGF0YUNsaWVudHMubGVuZ3RoO1xuICAgIHJldHVybiBjbGllbnQgYXMgQ2FjaGVEYXRhQ2xpZW50O1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldERlZmF1bHRDYWNoZUNsaWVudENvbmZpZ3VyYXRpb24oKTogQ29uZmlndXJhdGlvbiB7XG4gIGNvbnN0IGNvbmZpZyA9IENvbmZpZ3VyYXRpb25zLkxhcHRvcC5sYXRlc3QoKTtcbiAgY29uc3QgbG9nZ2VyID0gY29uZmlnLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIoJ0NhY2hlQ2xpZW50Jyk7XG4gIGxvZ2dlci5pbmZvKFxuICAgICdObyBjb25maWd1cmF0aW9uIHByb3ZpZGVkIHRvIENhY2hlQ2xpZW50LiBVc2luZyBkZWZhdWx0IFwiTGFwdG9wXCIgY29uZmlndXJhdGlvbiwgc3VpdGFibGUgZm9yIGRldmVsb3BtZW50LiBGb3IgcHJvZHVjdGlvbiB1c2UsIGNvbnNpZGVyIHNwZWNpZnlpbmcgYW4gZXhwbGljaXQgY29uZmlndXJhdGlvbi4nXG4gICk7XG4gIHJldHVybiBjb25maWc7XG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgdXNlIHtDYWNoZUNsaWVudH0gaW5zdGVhZFxuICovXG5leHBvcnQgY2xhc3MgU2ltcGxlQ2FjaGVDbGllbnQgZXh0ZW5kcyBDYWNoZUNsaWVudCB7fVxuIl19