"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.permissionsFromDisposableTokenScope = exports.permissionsFromTokenScope = exports.InternalAuthClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcAuth = generated_types_1.auth.auth;
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
var Never = grpcAuth._GenerateApiTokenRequest.Never;
var Expires = grpcAuth._GenerateApiTokenRequest.Expires;
const sdk_core_1 = require("@gomomento/sdk-core");
const permission_scope_1 = require("@gomomento/sdk-core/dist/src/auth/tokens/permission-scope");
const permissionmessages_1 = require("@gomomento/generated-types/dist/permissionmessages");
const utils_2 = require("./utils");
const disposable_token_scope_1 = require("@gomomento/sdk-core/dist/src/auth/tokens/disposable-token-scope");
class InternalAuthClient {
    constructor(props) {
        var _a;
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper((_a = props.throwOnErrors) !== null && _a !== void 0 ? _a : false);
        this.creds = props.credentialProvider;
        const headers = [new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`)];
        this.interceptors = [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(InternalAuthClient.REQUEST_TIMEOUT_MS),
        ];
        this.tokenClient = new generated_types_1.token.token.TokenClient(this.creds.getTokenEndpoint(), grpc_js_1.ChannelCredentials.createSsl());
        this.authClient = new grpcAuth.AuthClient(this.creds.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl());
    }
    async generateApiKey(scope, expiresIn) {
        let permissions;
        try {
            permissions = permissionsFromTokenScope(scope);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.GenerateApiKey.Error(err));
        }
        const request = new grpcAuth._GenerateApiTokenRequest({
            auth_token: this.creds.getAuthToken(),
            permissions: permissions,
        });
        if (expiresIn.doesExpire()) {
            try {
                (0, utils_1.validateValidForSeconds)(expiresIn.seconds());
            }
            catch (err) {
                return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.GenerateApiKey.Error(err));
            }
            request.expires = new Expires({
                valid_for_seconds: expiresIn.seconds(),
            });
        }
        else {
            request.never = new Never();
        }
        return await new Promise((resolve, reject) => {
            this.authClient.GenerateApiToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.GenerateApiKey.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.GenerateApiKey.Success(resp.api_key, resp.refresh_token, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
    /**
     * @deprecated please use `generateApiKey` instead
     */
    generateAuthToken(scope, expiresIn) {
        return this.generateApiKey(scope, expiresIn);
    }
    async refreshApiKey(refreshToken) {
        const request = new grpcAuth._RefreshApiTokenRequest({
            api_key: this.creds.getAuthToken(),
            refresh_token: refreshToken,
        });
        return await new Promise((resolve, reject) => {
            this.authClient.RefreshApiToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.RefreshApiKey.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.RefreshApiKey.Success(resp.api_key, resp.refresh_token, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
    /**
     * @deprecated please use `refreshApiKey` instead
     */
    refreshAuthToken(refreshToken) {
        return this.refreshApiKey(refreshToken);
    }
    async generateDisposableToken(scope, expiresIn, disposableTokenProps) {
        try {
            (0, utils_1.validateDisposableTokenExpiry)(expiresIn);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.GenerateDisposableToken.Error(err));
        }
        const expires = new generated_types_1.token.token._GenerateDisposableTokenRequest.Expires({
            valid_for_seconds: expiresIn.seconds(),
        });
        let permissions;
        try {
            permissions = permissionsFromDisposableTokenScope(scope);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.GenerateDisposableToken.Error(err));
        }
        const tokenId = disposableTokenProps === null || disposableTokenProps === void 0 ? void 0 : disposableTokenProps.tokenId;
        if (tokenId !== undefined) {
            try {
                (0, utils_1.validateDisposableTokenTokenID)(tokenId);
            }
            catch (err) {
                return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.GenerateDisposableToken.Error(err));
            }
        }
        const request = new generated_types_1.token.token._GenerateDisposableTokenRequest({
            expires: expires,
            auth_token: this.creds.getAuthToken(),
            permissions: permissions,
            token_id: tokenId,
        });
        return await new Promise((resolve, reject) => {
            this.tokenClient.GenerateDisposableToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.GenerateDisposableToken.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.GenerateDisposableToken.Success(resp.api_key, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
}
exports.InternalAuthClient = InternalAuthClient;
InternalAuthClient.REQUEST_TIMEOUT_MS = 60 * 1000;
function permissionsFromTokenScope(scope) {
    const result = new permissionmessages_1.permission_messages.Permissions();
    if (scope instanceof utils_1.InternalSuperUserPermissions) {
        result.super_user = permissionmessages_1.permission_messages.SuperUserPermissions.SuperUser;
        return result;
    }
    else if ((0, permission_scope_1.isPermissionsObject)(scope)) {
        const scopePermissions = (0, permission_scope_1.asPermissionsObject)(scope);
        const explicitPermissions = new permissionmessages_1.permission_messages.ExplicitPermissions();
        explicitPermissions.permissions = scopePermissions.permissions.map(p => tokenPermissionToGrpcPermission(p));
        result.explicit = explicitPermissions;
        return result;
    }
    throw new Error(`Unrecognized token scope: ${JSON.stringify(scope)}`);
}
exports.permissionsFromTokenScope = permissionsFromTokenScope;
function permissionsFromDisposableTokenScope(scope) {
    const result = new permissionmessages_1.permission_messages.Permissions();
    if (!(scope instanceof permission_scope_1.PredefinedScope) &&
        (0, disposable_token_scope_1.isDisposableTokenPermissionsObject)(scope)) {
        const scopePermissions = (0, disposable_token_scope_1.asDisposableTokenPermissionsObject)(scope);
        const explicitPermissions = new permissionmessages_1.permission_messages.ExplicitPermissions();
        explicitPermissions.permissions = scopePermissions.permissions.map(p => disposableTokenPermissionToGrpcPermission(p));
        result.explicit = explicitPermissions;
        return result;
    }
    else if ((0, permission_scope_1.isPermissionsObject)(scope)) {
        const scopePermissions = (0, permission_scope_1.asPermissionsObject)(scope);
        const explicitPermissions = new permissionmessages_1.permission_messages.ExplicitPermissions();
        explicitPermissions.permissions = scopePermissions.permissions.map(p => tokenPermissionToGrpcPermission(p));
        result.explicit = explicitPermissions;
        return result;
    }
    throw new Error(`Unrecognized token scope: ${JSON.stringify(scope)}`);
}
exports.permissionsFromDisposableTokenScope = permissionsFromDisposableTokenScope;
function tokenPermissionToGrpcPermission(permission) {
    const result = new permissionmessages_1.permission_messages.PermissionsType();
    if ((0, permission_scope_1.isTopicPermission)(permission)) {
        result.topic_permissions = topicPermissionToGrpcPermission((0, permission_scope_1.asTopicPermission)(permission));
        return result;
    }
    else if ((0, permission_scope_1.isCachePermission)(permission)) {
        result.cache_permissions = cachePermissionToGrpcPermission((0, permission_scope_1.asCachePermission)(permission));
        return result;
    }
    throw new Error(`Unrecognized token permission: ${JSON.stringify(permission)}`);
}
function topicPermissionToGrpcPermission(permission) {
    const grpcPermission = new permissionmessages_1.permission_messages.PermissionsType.TopicPermissions();
    switch (permission.role) {
        case sdk_core_1.TopicRole.PublishSubscribe: {
            grpcPermission.role = permissionmessages_1.permission_messages.TopicRole.TopicReadWrite;
            break;
        }
        case sdk_core_1.TopicRole.SubscribeOnly: {
            grpcPermission.role = permissionmessages_1.permission_messages.TopicRole.TopicReadOnly;
            break;
        }
        case sdk_core_1.TopicRole.PublishOnly: {
            grpcPermission.role = permissionmessages_1.permission_messages.TopicRole.TopicWriteOnly;
            break;
        }
        default: {
            throw new Error(`Unrecognized topic role: ${JSON.stringify(permission)}`);
        }
    }
    if (permission.cache === sdk_core_1.AllCaches) {
        grpcPermission.all_caches = new permissionmessages_1.permission_messages.PermissionsType.All();
    }
    else if (typeof permission.cache === 'string') {
        grpcPermission.cache_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheSelector({
                cache_name: permission.cache,
            });
    }
    else if ((0, sdk_core_1.isCacheName)(permission.cache)) {
        grpcPermission.cache_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheSelector({
                cache_name: permission.cache.name,
            });
    }
    else {
        throw new Error(`Unrecognized cache specification in topic permission: ${JSON.stringify(permission)}`);
    }
    if (permission.topic === sdk_core_1.AllTopics) {
        grpcPermission.all_topics = new permissionmessages_1.permission_messages.PermissionsType.All();
    }
    else if (typeof permission.topic === 'string') {
        grpcPermission.topic_selector =
            new permissionmessages_1.permission_messages.PermissionsType.TopicSelector({
                topic_name: permission.topic,
            });
    }
    else if ((0, sdk_core_1.isTopicName)(permission.topic)) {
        grpcPermission.topic_selector =
            new permissionmessages_1.permission_messages.PermissionsType.TopicSelector({
                topic_name: permission.topic.name,
            });
    }
    else {
        throw new Error(`Unrecognized topic specification in topic permission: ${JSON.stringify(permission)}`);
    }
    return grpcPermission;
}
function assignCacheRole(permission, grpcPermission) {
    switch (permission.role) {
        case sdk_core_1.CacheRole.ReadWrite: {
            grpcPermission.role = permissionmessages_1.permission_messages.CacheRole.CacheReadWrite;
            break;
        }
        case sdk_core_1.CacheRole.ReadOnly: {
            grpcPermission.role = permissionmessages_1.permission_messages.CacheRole.CacheReadOnly;
            break;
        }
        case sdk_core_1.CacheRole.WriteOnly: {
            grpcPermission.role = permissionmessages_1.permission_messages.CacheRole.CacheWriteOnly;
            break;
        }
        default: {
            throw new Error(`Unrecognized cache role: ${JSON.stringify(permission)}`);
        }
    }
    return grpcPermission;
}
function assignCacheSelector(permission, grpcPermission) {
    if (permission.cache === sdk_core_1.AllCaches) {
        grpcPermission.all_caches = new permissionmessages_1.permission_messages.PermissionsType.All();
    }
    else if (typeof permission.cache === 'string') {
        grpcPermission.cache_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheSelector({
                cache_name: permission.cache,
            });
    }
    else if ((0, sdk_core_1.isCacheName)(permission.cache)) {
        grpcPermission.cache_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheSelector({
                cache_name: permission.cache.name,
            });
    }
    else {
        throw new Error(`Unrecognized cache specification in cache permission: ${JSON.stringify(permission)}`);
    }
    return grpcPermission;
}
function assignCacheItemSelector(permission, grpcPermission) {
    if (permission.item === sdk_core_1.AllCacheItems) {
        grpcPermission.all_items = new permissionmessages_1.permission_messages.PermissionsType.All();
    }
    else if (typeof permission.item === 'string') {
        grpcPermission.item_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheItemSelector({
                key: (0, utils_2.convert)(permission.item),
            });
    }
    else if ((0, sdk_core_1.isCacheItemKey)(permission.item)) {
        (0, utils_1.validateCacheKeyOrPrefix)(permission.item.key);
        grpcPermission.item_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheItemSelector({
                key: (0, utils_2.convert)(permission.item.key),
            });
    }
    else if ((0, sdk_core_1.isCacheItemKeyPrefix)(permission.item)) {
        (0, utils_1.validateCacheKeyOrPrefix)(permission.item.keyPrefix);
        grpcPermission.item_selector =
            new permissionmessages_1.permission_messages.PermissionsType.CacheItemSelector({
                key_prefix: (0, utils_2.convert)(permission.item.keyPrefix),
            });
    }
    else {
        throw new Error(`Unrecognized cache item specification in cache permission: ${JSON.stringify(permission)}`);
    }
    return grpcPermission;
}
function cachePermissionToGrpcPermission(permission) {
    let grpcPermission = new permissionmessages_1.permission_messages.PermissionsType.CachePermissions();
    grpcPermission = assignCacheRole(permission, grpcPermission);
    grpcPermission = assignCacheSelector(permission, grpcPermission);
    return grpcPermission;
}
function disposableTokenPermissionToGrpcPermission(permission) {
    const result = new permissionmessages_1.permission_messages.PermissionsType();
    if ((0, disposable_token_scope_1.isDisposableTokenCachePermission)(permission)) {
        result.cache_permissions = disposableCachePermissionToGrpcPermission((0, disposable_token_scope_1.asDisposableTokenCachePermission)(permission));
        return result;
    }
    throw new Error(`Unrecognized token permission: ${JSON.stringify(permission)}`);
}
function disposableCachePermissionToGrpcPermission(permission) {
    let grpcPermission = new permissionmessages_1.permission_messages.PermissionsType.CachePermissions();
    grpcPermission = assignCacheRole(permission, grpcPermission);
    grpcPermission = assignCacheSelector(permission, grpcPermission);
    grpcPermission = assignCacheItemSelector(permission, grpcPermission);
    return grpcPermission;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwtYXV0aC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvaW50ZXJuYWwtYXV0aC1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0VBQXVEO0FBQ3ZELElBQU8sUUFBUSxHQUFHLHNCQUFJLENBQUMsSUFBSSxDQUFDO0FBQzVCLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UsMkNBQThEO0FBQzlELHFEQUEyQztBQUMzQyxxRkFBNkU7QUFDN0UsdUVBTXFEO0FBQ3JELElBQU8sS0FBSyxHQUFHLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUM7QUFDdkQsSUFBTyxPQUFPLEdBQUcsUUFBUSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQztBQUMzRCxrREFzQjZCO0FBRzdCLGdHQVFtRTtBQUNuRSwyRkFBdUY7QUFDdkYsbUNBQWdDO0FBQ2hDLDRHQU95RTtBQUV6RSxNQUFhLGtCQUFrQjtJQVM3QixZQUFZLEtBQXNCOztRQUNoQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxvREFBdUIsQ0FDeEQsTUFBQSxLQUFLLENBQUMsYUFBYSxtQ0FBSSxLQUFLLENBQzdCLENBQUM7UUFDRixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUN0QyxNQUFNLE9BQU8sR0FBRyxDQUFDLElBQUksNEJBQU0sQ0FBQyxPQUFPLEVBQUUsVUFBVSxzQkFBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsSUFBSSwrQ0FBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyx3QkFBd0IsRUFBRTtZQUNqRSxJQUFBLHFEQUF3QixFQUFDLGtCQUFrQixDQUFDLGtCQUFrQixDQUFDO1NBQ2hFLENBQUM7UUFDRixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksdUJBQUssQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUM1QyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLEVBQzdCLDRCQUFrQixDQUFDLFNBQVMsRUFBRSxDQUMvQixDQUFDO1FBQ0YsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFFBQVEsQ0FBQyxVQUFVLENBQ3ZDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsRUFDL0IsNEJBQWtCLENBQUMsU0FBUyxFQUFFLENBQy9CLENBQUM7SUFDSixDQUFDO0lBRU0sS0FBSyxDQUFDLGNBQWMsQ0FDekIsS0FBc0IsRUFDdEIsU0FBb0I7UUFFcEIsSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSTtZQUNGLFdBQVcsR0FBRyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNoRDtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLENBQ3BELEdBQVksRUFDWixHQUFHLENBQUMsRUFBRSxDQUFDLElBQUkseUJBQWMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQ3JDLENBQUM7U0FDSDtRQUNELE1BQU0sT0FBTyxHQUFHLElBQUksUUFBUSxDQUFDLHdCQUF3QixDQUFDO1lBQ3BELFVBQVUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRTtZQUNyQyxXQUFXLEVBQUUsV0FBVztTQUN6QixDQUFDLENBQUM7UUFFSCxJQUFJLFNBQVMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUMxQixJQUFJO2dCQUNGLElBQUEsK0JBQXVCLEVBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7YUFDOUM7WUFBQyxPQUFPLEdBQUcsRUFBRTtnQkFDWixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FDcEQsR0FBWSxFQUNaLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSx5QkFBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FDckMsQ0FBQzthQUNIO1lBRUQsT0FBTyxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQztnQkFDNUIsaUJBQWlCLEVBQUUsU0FBUyxDQUFDLE9BQU8sRUFBRTthQUN2QyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsT0FBTyxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1NBQzdCO1FBRUQsT0FBTyxNQUFNLElBQUksT0FBTyxDQUEwQixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNwRSxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUM5QixPQUFPLEVBQ1AsRUFBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBQyxFQUNqQyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDWixJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRTtvQkFDaEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLG9CQUFvQixDQUFDO3dCQUNoRCxHQUFHLEVBQUUsR0FBRzt3QkFDUixzQkFBc0IsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUkseUJBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO3dCQUN4RCxTQUFTLEVBQUUsT0FBTzt3QkFDbEIsUUFBUSxFQUFFLE1BQU07cUJBQ2pCLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxPQUFPLENBQ0wsSUFBSSx5QkFBYyxDQUFDLE9BQU8sQ0FDeEIsSUFBSSxDQUFDLE9BQU8sRUFDWixJQUFJLENBQUMsYUFBYSxFQUNsQixJQUFJLENBQUMsUUFBUSxFQUNiLG9CQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FDdEMsQ0FDRixDQUFDO2lCQUNIO1lBQ0gsQ0FBQyxDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNJLGlCQUFpQixDQUN0QixLQUFzQixFQUN0QixTQUFvQjtRQUVwQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFTSxLQUFLLENBQUMsYUFBYSxDQUN4QixZQUFvQjtRQUVwQixNQUFNLE9BQU8sR0FBRyxJQUFJLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQztZQUNuRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUU7WUFDbEMsYUFBYSxFQUFFLFlBQVk7U0FDNUIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLElBQUksT0FBTyxDQUF5QixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuRSxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FDN0IsT0FBTyxFQUNQLEVBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUMsRUFDakMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ1osSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxvQkFBb0IsQ0FBQzt3QkFDaEQsR0FBRyxFQUFFLEdBQUc7d0JBQ1Isc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLHdCQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzt3QkFDdkQsU0FBUyxFQUFFLE9BQU87d0JBQ2xCLFFBQVEsRUFBRSxNQUFNO3FCQUNqQixDQUFDLENBQUM7aUJBQ0o7cUJBQU07b0JBQ0wsT0FBTyxDQUNMLElBQUksd0JBQWEsQ0FBQyxPQUFPLENBQ3ZCLElBQUksQ0FBQyxPQUFPLEVBQ1osSUFBSSxDQUFDLGFBQWEsRUFDbEIsSUFBSSxDQUFDLFFBQVEsRUFDYixvQkFBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQ3RDLENBQ0YsQ0FBQztpQkFDSDtZQUNILENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxnQkFBZ0IsQ0FDckIsWUFBb0I7UUFFcEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFTSxLQUFLLENBQUMsdUJBQXVCLENBQ2xDLEtBQTJCLEVBQzNCLFNBQW9CLEVBQ3BCLG9CQUEyQztRQUUzQyxJQUFJO1lBQ0YsSUFBQSxxQ0FBNkIsRUFBQyxTQUFTLENBQUMsQ0FBQztTQUMxQztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLENBQ3BELEdBQVksRUFDWixHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksa0NBQXVCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUM5QyxDQUFDO1NBQ0g7UUFDRCxNQUFNLE9BQU8sR0FBRyxJQUFJLHVCQUFLLENBQUMsS0FBSyxDQUFDLCtCQUErQixDQUFDLE9BQU8sQ0FBQztZQUN0RSxpQkFBaUIsRUFBRSxTQUFTLENBQUMsT0FBTyxFQUFFO1NBQ3ZDLENBQUMsQ0FBQztRQUVILElBQUksV0FBVyxDQUFDO1FBQ2hCLElBQUk7WUFDRixXQUFXLEdBQUcsbUNBQW1DLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDMUQ7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLE9BQU8sSUFBSSxDQUFDLHVCQUF1QixDQUFDLGtCQUFrQixDQUNwRCxHQUFZLEVBQ1osR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLGtDQUF1QixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FDOUMsQ0FBQztTQUNIO1FBRUQsTUFBTSxPQUFPLEdBQUcsb0JBQW9CLGFBQXBCLG9CQUFvQix1QkFBcEIsb0JBQW9CLENBQUUsT0FBTyxDQUFDO1FBQzlDLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtZQUN6QixJQUFJO2dCQUNGLElBQUEsc0NBQThCLEVBQUMsT0FBTyxDQUFDLENBQUM7YUFDekM7WUFBQyxPQUFPLEdBQUcsRUFBRTtnQkFDWixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FDcEQsR0FBWSxFQUNaLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxrQ0FBdUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQzlDLENBQUM7YUFDSDtTQUNGO1FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSx1QkFBSyxDQUFDLEtBQUssQ0FBQywrQkFBK0IsQ0FBQztZQUM5RCxPQUFPLEVBQUUsT0FBTztZQUNoQixVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUU7WUFDckMsV0FBVyxFQUFFLFdBQVc7WUFDeEIsUUFBUSxFQUFFLE9BQU87U0FDbEIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLElBQUksT0FBTyxDQUN0QixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUN0QyxPQUFPLEVBQ1AsRUFBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBQyxFQUNqQyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDWixJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRTtvQkFDaEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLG9CQUFvQixDQUFDO3dCQUNoRCxHQUFHLEVBQUUsR0FBRzt3QkFDUixzQkFBc0IsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUMxQixJQUFJLGtDQUF1QixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7d0JBQ3RDLFNBQVMsRUFBRSxPQUFPO3dCQUNsQixRQUFRLEVBQUUsTUFBTTtxQkFDakIsQ0FBQyxDQUFDO2lCQUNKO3FCQUFNO29CQUNMLE9BQU8sQ0FDTCxJQUFJLGtDQUF1QixDQUFDLE9BQU8sQ0FDakMsSUFBSSxDQUFDLE9BQU8sRUFDWixJQUFJLENBQUMsUUFBUSxFQUNiLG9CQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FDdEMsQ0FDRixDQUFDO2lCQUNIO1lBQ0gsQ0FBQyxDQUNGLENBQUM7UUFDSixDQUFDLENBQ0YsQ0FBQztJQUNKLENBQUM7O0FBMU5ILGdEQTJOQztBQTFOeUIscUNBQWtCLEdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQztBQTROakUsU0FBZ0IseUJBQXlCLENBQ3ZDLEtBQXNCO0lBRXRCLE1BQU0sTUFBTSxHQUFHLElBQUksd0NBQW1CLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckQsSUFBSSxLQUFLLFlBQVksb0NBQTRCLEVBQUU7UUFDakQsTUFBTSxDQUFDLFVBQVUsR0FBRyx3Q0FBbUIsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUM7UUFDdkUsT0FBTyxNQUFNLENBQUM7S0FDZjtTQUFNLElBQUksSUFBQSxzQ0FBbUIsRUFBQyxLQUFLLENBQUMsRUFBRTtRQUNyQyxNQUFNLGdCQUFnQixHQUFnQixJQUFBLHNDQUFtQixFQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSx3Q0FBbUIsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzFFLG1CQUFtQixDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3JFLCtCQUErQixDQUFDLENBQUMsQ0FBQyxDQUNuQyxDQUFDO1FBQ0YsTUFBTSxDQUFDLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQztRQUN0QyxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEUsQ0FBQztBQWpCRCw4REFpQkM7QUFFRCxTQUFnQixtQ0FBbUMsQ0FDakQsS0FBMkI7SUFFM0IsTUFBTSxNQUFNLEdBQUcsSUFBSSx3Q0FBbUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyRCxJQUNFLENBQUMsQ0FBQyxLQUFLLFlBQVksa0NBQWUsQ0FBQztRQUNuQyxJQUFBLDJEQUFrQyxFQUFDLEtBQUssQ0FBQyxFQUN6QztRQUNBLE1BQU0sZ0JBQWdCLEdBQUcsSUFBQSwyREFBa0MsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUNuRSxNQUFNLG1CQUFtQixHQUFHLElBQUksd0NBQW1CLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMxRSxtQkFBbUIsQ0FBQyxXQUFXLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUNyRSx5Q0FBeUMsQ0FBQyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztRQUNGLE1BQU0sQ0FBQyxRQUFRLEdBQUcsbUJBQW1CLENBQUM7UUFDdEMsT0FBTyxNQUFNLENBQUM7S0FDZjtTQUFNLElBQUksSUFBQSxzQ0FBbUIsRUFBQyxLQUFLLENBQUMsRUFBRTtRQUNyQyxNQUFNLGdCQUFnQixHQUFnQixJQUFBLHNDQUFtQixFQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSx3Q0FBbUIsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzFFLG1CQUFtQixDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3JFLCtCQUErQixDQUFDLENBQUMsQ0FBQyxDQUNuQyxDQUFDO1FBQ0YsTUFBTSxDQUFDLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQztRQUN0QyxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEUsQ0FBQztBQXpCRCxrRkF5QkM7QUFFRCxTQUFTLCtCQUErQixDQUN0QyxVQUFzQjtJQUV0QixNQUFNLE1BQU0sR0FBRyxJQUFJLHdDQUFtQixDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pELElBQUksSUFBQSxvQ0FBaUIsRUFBQyxVQUFVLENBQUMsRUFBRTtRQUNqQyxNQUFNLENBQUMsaUJBQWlCLEdBQUcsK0JBQStCLENBQ3hELElBQUEsb0NBQWlCLEVBQUMsVUFBVSxDQUFDLENBQzlCLENBQUM7UUFDRixPQUFPLE1BQU0sQ0FBQztLQUNmO1NBQU0sSUFBSSxJQUFBLG9DQUFpQixFQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQ3hDLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRywrQkFBK0IsQ0FDeEQsSUFBQSxvQ0FBaUIsRUFBQyxVQUFVLENBQUMsQ0FDOUIsQ0FBQztRQUNGLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFDRCxNQUFNLElBQUksS0FBSyxDQUNiLGtDQUFrQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQy9ELENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUywrQkFBK0IsQ0FDdEMsVUFBMkI7SUFFM0IsTUFBTSxjQUFjLEdBQ2xCLElBQUksd0NBQW1CLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDN0QsUUFBUSxVQUFVLENBQUMsSUFBSSxFQUFFO1FBQ3ZCLEtBQUssb0JBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQy9CLGNBQWMsQ0FBQyxJQUFJLEdBQUcsd0NBQW1CLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQztZQUNuRSxNQUFNO1NBQ1A7UUFDRCxLQUFLLG9CQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUIsY0FBYyxDQUFDLElBQUksR0FBRyx3Q0FBbUIsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDO1lBQ2xFLE1BQU07U0FDUDtRQUNELEtBQUssb0JBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUMxQixjQUFjLENBQUMsSUFBSSxHQUFHLHdDQUFtQixDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUM7WUFDbkUsTUFBTTtTQUNQO1FBQ0QsT0FBTyxDQUFDLENBQUM7WUFDUCxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMzRTtLQUNGO0lBRUQsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLG9CQUFTLEVBQUU7UUFDbEMsY0FBYyxDQUFDLFVBQVUsR0FBRyxJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztLQUMzRTtTQUFNLElBQUksT0FBTyxVQUFVLENBQUMsS0FBSyxLQUFLLFFBQVEsRUFBRTtRQUMvQyxjQUFjLENBQUMsY0FBYztZQUMzQixJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUM7Z0JBQ3BELFVBQVUsRUFBRSxVQUFVLENBQUMsS0FBSzthQUM3QixDQUFDLENBQUM7S0FDTjtTQUFNLElBQUksSUFBQSxzQkFBVyxFQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN4QyxjQUFjLENBQUMsY0FBYztZQUMzQixJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUM7Z0JBQ3BELFVBQVUsRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUk7YUFDbEMsQ0FBQyxDQUFDO0tBQ047U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQ2IseURBQXlELElBQUksQ0FBQyxTQUFTLENBQ3JFLFVBQVUsQ0FDWCxFQUFFLENBQ0osQ0FBQztLQUNIO0lBRUQsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLG9CQUFTLEVBQUU7UUFDbEMsY0FBYyxDQUFDLFVBQVUsR0FBRyxJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztLQUMzRTtTQUFNLElBQUksT0FBTyxVQUFVLENBQUMsS0FBSyxLQUFLLFFBQVEsRUFBRTtRQUMvQyxjQUFjLENBQUMsY0FBYztZQUMzQixJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUM7Z0JBQ3BELFVBQVUsRUFBRSxVQUFVLENBQUMsS0FBSzthQUM3QixDQUFDLENBQUM7S0FDTjtTQUFNLElBQUksSUFBQSxzQkFBVyxFQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN4QyxjQUFjLENBQUMsY0FBYztZQUMzQixJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUM7Z0JBQ3BELFVBQVUsRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUk7YUFDbEMsQ0FBQyxDQUFDO0tBQ047U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQ2IseURBQXlELElBQUksQ0FBQyxTQUFTLENBQ3JFLFVBQVUsQ0FDWCxFQUFFLENBQ0osQ0FBQztLQUNIO0lBQ0QsT0FBTyxjQUFjLENBQUM7QUFDeEIsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUN0QixVQUE0RCxFQUM1RCxjQUFvRTtJQUVwRSxRQUFRLFVBQVUsQ0FBQyxJQUFJLEVBQUU7UUFDdkIsS0FBSyxvQkFBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hCLGNBQWMsQ0FBQyxJQUFJLEdBQUcsd0NBQW1CLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQztZQUNuRSxNQUFNO1NBQ1A7UUFDRCxLQUFLLG9CQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdkIsY0FBYyxDQUFDLElBQUksR0FBRyx3Q0FBbUIsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDO1lBQ2xFLE1BQU07U0FDUDtRQUNELEtBQUssb0JBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN4QixjQUFjLENBQUMsSUFBSSxHQUFHLHdDQUFtQixDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUM7WUFDbkUsTUFBTTtTQUNQO1FBQ0QsT0FBTyxDQUFDLENBQUM7WUFDUCxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMzRTtLQUNGO0lBQ0QsT0FBTyxjQUFjLENBQUM7QUFDeEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQzFCLFVBQTRELEVBQzVELGNBQW9FO0lBRXBFLElBQUksVUFBVSxDQUFDLEtBQUssS0FBSyxvQkFBUyxFQUFFO1FBQ2xDLGNBQWMsQ0FBQyxVQUFVLEdBQUcsSUFBSSx3Q0FBbUIsQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLENBQUM7S0FDM0U7U0FBTSxJQUFJLE9BQU8sVUFBVSxDQUFDLEtBQUssS0FBSyxRQUFRLEVBQUU7UUFDL0MsY0FBYyxDQUFDLGNBQWM7WUFDM0IsSUFBSSx3Q0FBbUIsQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDO2dCQUNwRCxVQUFVLEVBQUUsVUFBVSxDQUFDLEtBQUs7YUFDN0IsQ0FBQyxDQUFDO0tBQ047U0FBTSxJQUFJLElBQUEsc0JBQVcsRUFBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDeEMsY0FBYyxDQUFDLGNBQWM7WUFDM0IsSUFBSSx3Q0FBbUIsQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDO2dCQUNwRCxVQUFVLEVBQUUsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJO2FBQ2xDLENBQUMsQ0FBQztLQUNOO1NBQU07UUFDTCxNQUFNLElBQUksS0FBSyxDQUNiLHlEQUF5RCxJQUFJLENBQUMsU0FBUyxDQUNyRSxVQUFVLENBQ1gsRUFBRSxDQUNKLENBQUM7S0FDSDtJQUNELE9BQU8sY0FBYyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxTQUFTLHVCQUF1QixDQUM5QixVQUEwQyxFQUMxQyxjQUFvRTtJQUVwRSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssd0JBQWEsRUFBRTtRQUNyQyxjQUFjLENBQUMsU0FBUyxHQUFHLElBQUksd0NBQW1CLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQzFFO1NBQU0sSUFBSSxPQUFPLFVBQVUsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQzlDLGNBQWMsQ0FBQyxhQUFhO1lBQzFCLElBQUksd0NBQW1CLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDO2dCQUN4RCxHQUFHLEVBQUUsSUFBQSxlQUFPLEVBQUMsVUFBVSxDQUFDLElBQUksQ0FBQzthQUM5QixDQUFDLENBQUM7S0FDTjtTQUFNLElBQUksSUFBQSx5QkFBYyxFQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUMxQyxJQUFBLGdDQUF3QixFQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDOUMsY0FBYyxDQUFDLGFBQWE7WUFDMUIsSUFBSSx3Q0FBbUIsQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUM7Z0JBQ3hELEdBQUcsRUFBRSxJQUFBLGVBQU8sRUFBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzthQUNsQyxDQUFDLENBQUM7S0FDTjtTQUFNLElBQUksSUFBQSwrQkFBb0IsRUFBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDaEQsSUFBQSxnQ0FBd0IsRUFBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELGNBQWMsQ0FBQyxhQUFhO1lBQzFCLElBQUksd0NBQW1CLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDO2dCQUN4RCxVQUFVLEVBQUUsSUFBQSxlQUFPLEVBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7YUFDL0MsQ0FBQyxDQUFDO0tBQ047U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQ2IsOERBQThELElBQUksQ0FBQyxTQUFTLENBQzFFLFVBQVUsQ0FDWCxFQUFFLENBQ0osQ0FBQztLQUNIO0lBQ0QsT0FBTyxjQUFjLENBQUM7QUFDeEIsQ0FBQztBQUVELFNBQVMsK0JBQStCLENBQ3RDLFVBQTJCO0lBRTNCLElBQUksY0FBYyxHQUNoQixJQUFJLHdDQUFtQixDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzdELGNBQWMsR0FBRyxlQUFlLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQzdELGNBQWMsR0FBRyxtQkFBbUIsQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDakUsT0FBTyxjQUFjLENBQUM7QUFDeEIsQ0FBQztBQUVELFNBQVMseUNBQXlDLENBQ2hELFVBQTBDO0lBRTFDLE1BQU0sTUFBTSxHQUFHLElBQUksd0NBQW1CLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDekQsSUFBSSxJQUFBLHlEQUFnQyxFQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQ2hELE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyx5Q0FBeUMsQ0FDbEUsSUFBQSx5REFBZ0MsRUFBQyxVQUFVLENBQUMsQ0FDN0MsQ0FBQztRQUNGLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFDRCxNQUFNLElBQUksS0FBSyxDQUNiLGtDQUFrQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQy9ELENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyx5Q0FBeUMsQ0FDaEQsVUFBMEM7SUFFMUMsSUFBSSxjQUFjLEdBQ2hCLElBQUksd0NBQW1CLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDN0QsY0FBYyxHQUFHLGVBQWUsQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDN0QsY0FBYyxHQUFHLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUNqRSxjQUFjLEdBQUcsdUJBQXVCLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBRXJFLE9BQU8sY0FBYyxDQUFDO0FBQ3hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2F1dGgsIHRva2VufSBmcm9tICdAZ29tb21lbnRvL2dlbmVyYXRlZC10eXBlcyc7XG5pbXBvcnQgZ3JwY0F1dGggPSBhdXRoLmF1dGg7XG5pbXBvcnQge0hlYWRlciwgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcn0gZnJvbSAnLi9ncnBjL2hlYWRlcnMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9jbGllbnQtdGltZW91dC1pbnRlcmNlcHRvcic7XG5pbXBvcnQge0NoYW5uZWxDcmVkZW50aWFscywgSW50ZXJjZXB0b3J9IGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0IHt2ZXJzaW9ufSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHtDYWNoZVNlcnZpY2VFcnJvck1hcHBlcn0gZnJvbSAnLi4vZXJyb3JzL2NhY2hlLXNlcnZpY2UtZXJyb3ItbWFwcGVyJztcbmltcG9ydCB7XG4gIEludGVybmFsU3VwZXJVc2VyUGVybWlzc2lvbnMsXG4gIHZhbGlkYXRlRGlzcG9zYWJsZVRva2VuRXhwaXJ5LFxuICB2YWxpZGF0ZVZhbGlkRm9yU2Vjb25kcyxcbiAgdmFsaWRhdGVDYWNoZUtleU9yUHJlZml4LFxuICB2YWxpZGF0ZURpc3Bvc2FibGVUb2tlblRva2VuSUQsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IE5ldmVyID0gZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0Lk5ldmVyO1xuaW1wb3J0IEV4cGlyZXMgPSBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuRXhwaXJlcztcbmltcG9ydCB7XG4gIEV4cGlyZXNJbixcbiAgRXhwaXJlc0F0LFxuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIFJlZnJlc2hBcGlLZXksXG4gIEdlbmVyYXRlQXBpS2V5LFxuICBQZXJtaXNzaW9uU2NvcGUsXG4gIFBlcm1pc3Npb25zLFxuICBQZXJtaXNzaW9uLFxuICBUb3BpY1Blcm1pc3Npb24sXG4gIENhY2hlUGVybWlzc2lvbixcbiAgVG9waWNSb2xlLFxuICBDYWNoZVJvbGUsXG4gIEFsbENhY2hlcyxcbiAgQWxsVG9waWNzLFxuICBpc0NhY2hlTmFtZSxcbiAgaXNUb3BpY05hbWUsXG4gIEdlbmVyYXRlRGlzcG9zYWJsZVRva2VuLFxuICBBbGxDYWNoZUl0ZW1zLFxuICBpc0NhY2hlSXRlbUtleSxcbiAgaXNDYWNoZUl0ZW1LZXlQcmVmaXgsXG4gIERpc3Bvc2FibGVUb2tlblNjb3BlLFxufSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlJztcbmltcG9ydCB7SUF1dGhDbGllbnR9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvY2xpZW50cyc7XG5pbXBvcnQge0F1dGhDbGllbnRQcm9wc30gZnJvbSAnLi4vYXV0aC1jbGllbnQtcHJvcHMnO1xuaW1wb3J0IHtcbiAgYXNDYWNoZVBlcm1pc3Npb24sXG4gIGFzUGVybWlzc2lvbnNPYmplY3QsXG4gIGFzVG9waWNQZXJtaXNzaW9uLFxuICBpc0NhY2hlUGVybWlzc2lvbixcbiAgaXNQZXJtaXNzaW9uc09iamVjdCxcbiAgaXNUb3BpY1Blcm1pc3Npb24sXG4gIFByZWRlZmluZWRTY29wZSxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9hdXRoL3Rva2Vucy9wZXJtaXNzaW9uLXNjb3BlJztcbmltcG9ydCB7cGVybWlzc2lvbl9tZXNzYWdlc30gZnJvbSAnQGdvbW9tZW50by9nZW5lcmF0ZWQtdHlwZXMvZGlzdC9wZXJtaXNzaW9ubWVzc2FnZXMnO1xuaW1wb3J0IHtjb252ZXJ0fSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7XG4gIGFzRGlzcG9zYWJsZVRva2VuQ2FjaGVQZXJtaXNzaW9uLFxuICBhc0Rpc3Bvc2FibGVUb2tlblBlcm1pc3Npb25zT2JqZWN0LFxuICBEaXNwb3NhYmxlVG9rZW5DYWNoZVBlcm1pc3Npb24sXG4gIERpc3Bvc2FibGVUb2tlblByb3BzLFxuICBpc0Rpc3Bvc2FibGVUb2tlbkNhY2hlUGVybWlzc2lvbixcbiAgaXNEaXNwb3NhYmxlVG9rZW5QZXJtaXNzaW9uc09iamVjdCxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9hdXRoL3Rva2Vucy9kaXNwb3NhYmxlLXRva2VuLXNjb3BlJztcblxuZXhwb3J0IGNsYXNzIEludGVybmFsQXV0aENsaWVudCBpbXBsZW1lbnRzIElBdXRoQ2xpZW50IHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgUkVRVUVTVF9USU1FT1VUX01TOiBudW1iZXIgPSA2MCAqIDEwMDA7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjYWNoZVNlcnZpY2VFcnJvck1hcHBlcjogQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlZHM6IENyZWRlbnRpYWxQcm92aWRlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBpbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG4gIHByaXZhdGUgcmVhZG9ubHkgdG9rZW5DbGllbnQ6IHRva2VuLnRva2VuLlRva2VuQ2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGF1dGhDbGllbnQ6IGdycGNBdXRoLkF1dGhDbGllbnQ7XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IEF1dGhDbGllbnRQcm9wcykge1xuICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIgPSBuZXcgQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoXG4gICAgICBwcm9wcy50aHJvd09uRXJyb3JzID8/IGZhbHNlXG4gICAgKTtcbiAgICB0aGlzLmNyZWRzID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIGNvbnN0IGhlYWRlcnMgPSBbbmV3IEhlYWRlcignQWdlbnQnLCBgbm9kZWpzOiR7dmVyc2lvbn1gKV07XG4gICAgdGhpcy5pbnRlcmNlcHRvcnMgPSBbXG4gICAgICBuZXcgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcihoZWFkZXJzKS5jcmVhdGVIZWFkZXJzSW50ZXJjZXB0b3IoKSxcbiAgICAgIENsaWVudFRpbWVvdXRJbnRlcmNlcHRvcihJbnRlcm5hbEF1dGhDbGllbnQuUkVRVUVTVF9USU1FT1VUX01TKSxcbiAgICBdO1xuICAgIHRoaXMudG9rZW5DbGllbnQgPSBuZXcgdG9rZW4udG9rZW4uVG9rZW5DbGllbnQoXG4gICAgICB0aGlzLmNyZWRzLmdldFRva2VuRW5kcG9pbnQoKSxcbiAgICAgIENoYW5uZWxDcmVkZW50aWFscy5jcmVhdGVTc2woKVxuICAgICk7XG4gICAgdGhpcy5hdXRoQ2xpZW50ID0gbmV3IGdycGNBdXRoLkF1dGhDbGllbnQoXG4gICAgICB0aGlzLmNyZWRzLmdldENvbnRyb2xFbmRwb2ludCgpLFxuICAgICAgQ2hhbm5lbENyZWRlbnRpYWxzLmNyZWF0ZVNzbCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZW5lcmF0ZUFwaUtleShcbiAgICBzY29wZTogUGVybWlzc2lvblNjb3BlLFxuICAgIGV4cGlyZXNJbjogRXhwaXJlc0luXG4gICk6IFByb21pc2U8R2VuZXJhdGVBcGlLZXkuUmVzcG9uc2U+IHtcbiAgICBsZXQgcGVybWlzc2lvbnM7XG4gICAgdHJ5IHtcbiAgICAgIHBlcm1pc3Npb25zID0gcGVybWlzc2lvbnNGcm9tVG9rZW5TY29wZShzY29wZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBHZW5lcmF0ZUFwaUtleS5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdCh7XG4gICAgICBhdXRoX3Rva2VuOiB0aGlzLmNyZWRzLmdldEF1dGhUb2tlbigpLFxuICAgICAgcGVybWlzc2lvbnM6IHBlcm1pc3Npb25zLFxuICAgIH0pO1xuXG4gICAgaWYgKGV4cGlyZXNJbi5kb2VzRXhwaXJlKCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhbGlkYXRlVmFsaWRGb3JTZWNvbmRzKGV4cGlyZXNJbi5zZWNvbmRzKCkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgICAgZXJyID0+IG5ldyBHZW5lcmF0ZUFwaUtleS5FcnJvcihlcnIpXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJlcXVlc3QuZXhwaXJlcyA9IG5ldyBFeHBpcmVzKHtcbiAgICAgICAgdmFsaWRfZm9yX3NlY29uZHM6IGV4cGlyZXNJbi5zZWNvbmRzKCksXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVxdWVzdC5uZXZlciA9IG5ldyBOZXZlcigpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxHZW5lcmF0ZUFwaUtleS5SZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5hdXRoQ2xpZW50LkdlbmVyYXRlQXBpVG9rZW4oXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgR2VuZXJhdGVBcGlLZXkuRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICBuZXcgR2VuZXJhdGVBcGlLZXkuU3VjY2VzcyhcbiAgICAgICAgICAgICAgICByZXNwLmFwaV9rZXksXG4gICAgICAgICAgICAgICAgcmVzcC5yZWZyZXNoX3Rva2VuLFxuICAgICAgICAgICAgICAgIHJlc3AuZW5kcG9pbnQsXG4gICAgICAgICAgICAgICAgRXhwaXJlc0F0LmZyb21FcG9jaChyZXNwLnZhbGlkX3VudGlsKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBwbGVhc2UgdXNlIGBnZW5lcmF0ZUFwaUtleWAgaW5zdGVhZFxuICAgKi9cbiAgcHVibGljIGdlbmVyYXRlQXV0aFRva2VuKFxuICAgIHNjb3BlOiBQZXJtaXNzaW9uU2NvcGUsXG4gICAgZXhwaXJlc0luOiBFeHBpcmVzSW5cbiAgKTogUHJvbWlzZTxHZW5lcmF0ZUFwaUtleS5SZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLmdlbmVyYXRlQXBpS2V5KHNjb3BlLCBleHBpcmVzSW4pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlZnJlc2hBcGlLZXkoXG4gICAgcmVmcmVzaFRva2VuOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxSZWZyZXNoQXBpS2V5LlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQXV0aC5fUmVmcmVzaEFwaVRva2VuUmVxdWVzdCh7XG4gICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmdldEF1dGhUb2tlbigpLFxuICAgICAgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPFJlZnJlc2hBcGlLZXkuUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuYXV0aENsaWVudC5SZWZyZXNoQXBpVG9rZW4oXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgUmVmcmVzaEFwaUtleS5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgIG5ldyBSZWZyZXNoQXBpS2V5LlN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgcmVzcC5hcGlfa2V5LFxuICAgICAgICAgICAgICAgIHJlc3AucmVmcmVzaF90b2tlbixcbiAgICAgICAgICAgICAgICByZXNwLmVuZHBvaW50LFxuICAgICAgICAgICAgICAgIEV4cGlyZXNBdC5mcm9tRXBvY2gocmVzcC52YWxpZF91bnRpbClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgcGxlYXNlIHVzZSBgcmVmcmVzaEFwaUtleWAgaW5zdGVhZFxuICAgKi9cbiAgcHVibGljIHJlZnJlc2hBdXRoVG9rZW4oXG4gICAgcmVmcmVzaFRva2VuOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxSZWZyZXNoQXBpS2V5LlJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIHRoaXMucmVmcmVzaEFwaUtleShyZWZyZXNoVG9rZW4pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdlbmVyYXRlRGlzcG9zYWJsZVRva2VuKFxuICAgIHNjb3BlOiBEaXNwb3NhYmxlVG9rZW5TY29wZSxcbiAgICBleHBpcmVzSW46IEV4cGlyZXNJbixcbiAgICBkaXNwb3NhYmxlVG9rZW5Qcm9wcz86IERpc3Bvc2FibGVUb2tlblByb3BzXG4gICk6IFByb21pc2U8R2VuZXJhdGVEaXNwb3NhYmxlVG9rZW4uUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVEaXNwb3NhYmxlVG9rZW5FeHBpcnkoZXhwaXJlc0luKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IEdlbmVyYXRlRGlzcG9zYWJsZVRva2VuLkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IGV4cGlyZXMgPSBuZXcgdG9rZW4udG9rZW4uX0dlbmVyYXRlRGlzcG9zYWJsZVRva2VuUmVxdWVzdC5FeHBpcmVzKHtcbiAgICAgIHZhbGlkX2Zvcl9zZWNvbmRzOiBleHBpcmVzSW4uc2Vjb25kcygpLFxuICAgIH0pO1xuXG4gICAgbGV0IHBlcm1pc3Npb25zO1xuICAgIHRyeSB7XG4gICAgICBwZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zRnJvbURpc3Bvc2FibGVUb2tlblNjb3BlKHNjb3BlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IEdlbmVyYXRlRGlzcG9zYWJsZVRva2VuLkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgdG9rZW5JZCA9IGRpc3Bvc2FibGVUb2tlblByb3BzPy50b2tlbklkO1xuICAgIGlmICh0b2tlbklkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhbGlkYXRlRGlzcG9zYWJsZVRva2VuVG9rZW5JRCh0b2tlbklkKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICAgIGVyciA9PiBuZXcgR2VuZXJhdGVEaXNwb3NhYmxlVG9rZW4uRXJyb3IoZXJyKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgdG9rZW4udG9rZW4uX0dlbmVyYXRlRGlzcG9zYWJsZVRva2VuUmVxdWVzdCh7XG4gICAgICBleHBpcmVzOiBleHBpcmVzLFxuICAgICAgYXV0aF90b2tlbjogdGhpcy5jcmVkcy5nZXRBdXRoVG9rZW4oKSxcbiAgICAgIHBlcm1pc3Npb25zOiBwZXJtaXNzaW9ucyxcbiAgICAgIHRva2VuX2lkOiB0b2tlbklkLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPEdlbmVyYXRlRGlzcG9zYWJsZVRva2VuLlJlc3BvbnNlPihcbiAgICAgIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy50b2tlbkNsaWVudC5HZW5lcmF0ZURpc3Bvc2FibGVUb2tlbihcbiAgICAgICAgICByZXF1ZXN0LFxuICAgICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyIHx8ICFyZXNwKSB7XG4gICAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT5cbiAgICAgICAgICAgICAgICAgIG5ldyBHZW5lcmF0ZURpc3Bvc2FibGVUb2tlbi5FcnJvcihlKSxcbiAgICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICAgIG5ldyBHZW5lcmF0ZURpc3Bvc2FibGVUb2tlbi5TdWNjZXNzKFxuICAgICAgICAgICAgICAgICAgcmVzcC5hcGlfa2V5LFxuICAgICAgICAgICAgICAgICAgcmVzcC5lbmRwb2ludCxcbiAgICAgICAgICAgICAgICAgIEV4cGlyZXNBdC5mcm9tRXBvY2gocmVzcC52YWxpZF91bnRpbClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcm1pc3Npb25zRnJvbVRva2VuU2NvcGUoXG4gIHNjb3BlOiBQZXJtaXNzaW9uU2NvcGVcbik6IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnMge1xuICBjb25zdCByZXN1bHQgPSBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9ucygpO1xuICBpZiAoc2NvcGUgaW5zdGFuY2VvZiBJbnRlcm5hbFN1cGVyVXNlclBlcm1pc3Npb25zKSB7XG4gICAgcmVzdWx0LnN1cGVyX3VzZXIgPSBwZXJtaXNzaW9uX21lc3NhZ2VzLlN1cGVyVXNlclBlcm1pc3Npb25zLlN1cGVyVXNlcjtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9IGVsc2UgaWYgKGlzUGVybWlzc2lvbnNPYmplY3Qoc2NvcGUpKSB7XG4gICAgY29uc3Qgc2NvcGVQZXJtaXNzaW9uczogUGVybWlzc2lvbnMgPSBhc1Blcm1pc3Npb25zT2JqZWN0KHNjb3BlKTtcbiAgICBjb25zdCBleHBsaWNpdFBlcm1pc3Npb25zID0gbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuRXhwbGljaXRQZXJtaXNzaW9ucygpO1xuICAgIGV4cGxpY2l0UGVybWlzc2lvbnMucGVybWlzc2lvbnMgPSBzY29wZVBlcm1pc3Npb25zLnBlcm1pc3Npb25zLm1hcChwID0+XG4gICAgICB0b2tlblBlcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKHApXG4gICAgKTtcbiAgICByZXN1bHQuZXhwbGljaXQgPSBleHBsaWNpdFBlcm1pc3Npb25zO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgdG9rZW4gc2NvcGU6ICR7SlNPTi5zdHJpbmdpZnkoc2NvcGUpfWApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGVybWlzc2lvbnNGcm9tRGlzcG9zYWJsZVRva2VuU2NvcGUoXG4gIHNjb3BlOiBEaXNwb3NhYmxlVG9rZW5TY29wZVxuKTogcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9ucyB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zKCk7XG4gIGlmIChcbiAgICAhKHNjb3BlIGluc3RhbmNlb2YgUHJlZGVmaW5lZFNjb3BlKSAmJlxuICAgIGlzRGlzcG9zYWJsZVRva2VuUGVybWlzc2lvbnNPYmplY3Qoc2NvcGUpXG4gICkge1xuICAgIGNvbnN0IHNjb3BlUGVybWlzc2lvbnMgPSBhc0Rpc3Bvc2FibGVUb2tlblBlcm1pc3Npb25zT2JqZWN0KHNjb3BlKTtcbiAgICBjb25zdCBleHBsaWNpdFBlcm1pc3Npb25zID0gbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuRXhwbGljaXRQZXJtaXNzaW9ucygpO1xuICAgIGV4cGxpY2l0UGVybWlzc2lvbnMucGVybWlzc2lvbnMgPSBzY29wZVBlcm1pc3Npb25zLnBlcm1pc3Npb25zLm1hcChwID0+XG4gICAgICBkaXNwb3NhYmxlVG9rZW5QZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihwKVxuICAgICk7XG4gICAgcmVzdWx0LmV4cGxpY2l0ID0gZXhwbGljaXRQZXJtaXNzaW9ucztcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9IGVsc2UgaWYgKGlzUGVybWlzc2lvbnNPYmplY3Qoc2NvcGUpKSB7XG4gICAgY29uc3Qgc2NvcGVQZXJtaXNzaW9uczogUGVybWlzc2lvbnMgPSBhc1Blcm1pc3Npb25zT2JqZWN0KHNjb3BlKTtcbiAgICBjb25zdCBleHBsaWNpdFBlcm1pc3Npb25zID0gbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuRXhwbGljaXRQZXJtaXNzaW9ucygpO1xuICAgIGV4cGxpY2l0UGVybWlzc2lvbnMucGVybWlzc2lvbnMgPSBzY29wZVBlcm1pc3Npb25zLnBlcm1pc3Npb25zLm1hcChwID0+XG4gICAgICB0b2tlblBlcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKHApXG4gICAgKTtcbiAgICByZXN1bHQuZXhwbGljaXQgPSBleHBsaWNpdFBlcm1pc3Npb25zO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgdG9rZW4gc2NvcGU6ICR7SlNPTi5zdHJpbmdpZnkoc2NvcGUpfWApO1xufVxuXG5mdW5jdGlvbiB0b2tlblBlcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKFxuICBwZXJtaXNzaW9uOiBQZXJtaXNzaW9uXG4pOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZSB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZSgpO1xuICBpZiAoaXNUb3BpY1Blcm1pc3Npb24ocGVybWlzc2lvbikpIHtcbiAgICByZXN1bHQudG9waWNfcGVybWlzc2lvbnMgPSB0b3BpY1Blcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKFxuICAgICAgYXNUb3BpY1Blcm1pc3Npb24ocGVybWlzc2lvbilcbiAgICApO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH0gZWxzZSBpZiAoaXNDYWNoZVBlcm1pc3Npb24ocGVybWlzc2lvbikpIHtcbiAgICByZXN1bHQuY2FjaGVfcGVybWlzc2lvbnMgPSBjYWNoZVBlcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKFxuICAgICAgYXNDYWNoZVBlcm1pc3Npb24ocGVybWlzc2lvbilcbiAgICApO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKFxuICAgIGBVbnJlY29nbml6ZWQgdG9rZW4gcGVybWlzc2lvbjogJHtKU09OLnN0cmluZ2lmeShwZXJtaXNzaW9uKX1gXG4gICk7XG59XG5cbmZ1bmN0aW9uIHRvcGljUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24oXG4gIHBlcm1pc3Npb246IFRvcGljUGVybWlzc2lvblxuKTogcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuVG9waWNQZXJtaXNzaW9ucyB7XG4gIGNvbnN0IGdycGNQZXJtaXNzaW9uID1cbiAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuVG9waWNQZXJtaXNzaW9ucygpO1xuICBzd2l0Y2ggKHBlcm1pc3Npb24ucm9sZSkge1xuICAgIGNhc2UgVG9waWNSb2xlLlB1Ymxpc2hTdWJzY3JpYmU6IHtcbiAgICAgIGdycGNQZXJtaXNzaW9uLnJvbGUgPSBwZXJtaXNzaW9uX21lc3NhZ2VzLlRvcGljUm9sZS5Ub3BpY1JlYWRXcml0ZTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIFRvcGljUm9sZS5TdWJzY3JpYmVPbmx5OiB7XG4gICAgICBncnBjUGVybWlzc2lvbi5yb2xlID0gcGVybWlzc2lvbl9tZXNzYWdlcy5Ub3BpY1JvbGUuVG9waWNSZWFkT25seTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIFRvcGljUm9sZS5QdWJsaXNoT25seToge1xuICAgICAgZ3JwY1Blcm1pc3Npb24ucm9sZSA9IHBlcm1pc3Npb25fbWVzc2FnZXMuVG9waWNSb2xlLlRvcGljV3JpdGVPbmx5O1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIHRvcGljIHJvbGU6ICR7SlNPTi5zdHJpbmdpZnkocGVybWlzc2lvbil9YCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHBlcm1pc3Npb24uY2FjaGUgPT09IEFsbENhY2hlcykge1xuICAgIGdycGNQZXJtaXNzaW9uLmFsbF9jYWNoZXMgPSBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQWxsKCk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIHBlcm1pc3Npb24uY2FjaGUgPT09ICdzdHJpbmcnKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uY2FjaGVfc2VsZWN0b3IgPVxuICAgICAgbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkNhY2hlU2VsZWN0b3Ioe1xuICAgICAgICBjYWNoZV9uYW1lOiBwZXJtaXNzaW9uLmNhY2hlLFxuICAgICAgfSk7XG4gIH0gZWxzZSBpZiAoaXNDYWNoZU5hbWUocGVybWlzc2lvbi5jYWNoZSkpIHtcbiAgICBncnBjUGVybWlzc2lvbi5jYWNoZV9zZWxlY3RvciA9XG4gICAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVTZWxlY3Rvcih7XG4gICAgICAgIGNhY2hlX25hbWU6IHBlcm1pc3Npb24uY2FjaGUubmFtZSxcbiAgICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBVbnJlY29nbml6ZWQgY2FjaGUgc3BlY2lmaWNhdGlvbiBpbiB0b3BpYyBwZXJtaXNzaW9uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBwZXJtaXNzaW9uXG4gICAgICApfWBcbiAgICApO1xuICB9XG5cbiAgaWYgKHBlcm1pc3Npb24udG9waWMgPT09IEFsbFRvcGljcykge1xuICAgIGdycGNQZXJtaXNzaW9uLmFsbF90b3BpY3MgPSBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQWxsKCk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIHBlcm1pc3Npb24udG9waWMgPT09ICdzdHJpbmcnKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24udG9waWNfc2VsZWN0b3IgPVxuICAgICAgbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLlRvcGljU2VsZWN0b3Ioe1xuICAgICAgICB0b3BpY19uYW1lOiBwZXJtaXNzaW9uLnRvcGljLFxuICAgICAgfSk7XG4gIH0gZWxzZSBpZiAoaXNUb3BpY05hbWUocGVybWlzc2lvbi50b3BpYykpIHtcbiAgICBncnBjUGVybWlzc2lvbi50b3BpY19zZWxlY3RvciA9XG4gICAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuVG9waWNTZWxlY3Rvcih7XG4gICAgICAgIHRvcGljX25hbWU6IHBlcm1pc3Npb24udG9waWMubmFtZSxcbiAgICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBVbnJlY29nbml6ZWQgdG9waWMgc3BlY2lmaWNhdGlvbiBpbiB0b3BpYyBwZXJtaXNzaW9uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBwZXJtaXNzaW9uXG4gICAgICApfWBcbiAgICApO1xuICB9XG4gIHJldHVybiBncnBjUGVybWlzc2lvbjtcbn1cblxuZnVuY3Rpb24gYXNzaWduQ2FjaGVSb2xlKFxuICBwZXJtaXNzaW9uOiBDYWNoZVBlcm1pc3Npb24gfCBEaXNwb3NhYmxlVG9rZW5DYWNoZVBlcm1pc3Npb24sXG4gIGdycGNQZXJtaXNzaW9uOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zXG4pOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zIHtcbiAgc3dpdGNoIChwZXJtaXNzaW9uLnJvbGUpIHtcbiAgICBjYXNlIENhY2hlUm9sZS5SZWFkV3JpdGU6IHtcbiAgICAgIGdycGNQZXJtaXNzaW9uLnJvbGUgPSBwZXJtaXNzaW9uX21lc3NhZ2VzLkNhY2hlUm9sZS5DYWNoZVJlYWRXcml0ZTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIENhY2hlUm9sZS5SZWFkT25seToge1xuICAgICAgZ3JwY1Blcm1pc3Npb24ucm9sZSA9IHBlcm1pc3Npb25fbWVzc2FnZXMuQ2FjaGVSb2xlLkNhY2hlUmVhZE9ubHk7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBDYWNoZVJvbGUuV3JpdGVPbmx5OiB7XG4gICAgICBncnBjUGVybWlzc2lvbi5yb2xlID0gcGVybWlzc2lvbl9tZXNzYWdlcy5DYWNoZVJvbGUuQ2FjaGVXcml0ZU9ubHk7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgZGVmYXVsdDoge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgY2FjaGUgcm9sZTogJHtKU09OLnN0cmluZ2lmeShwZXJtaXNzaW9uKX1gKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGdycGNQZXJtaXNzaW9uO1xufVxuXG5mdW5jdGlvbiBhc3NpZ25DYWNoZVNlbGVjdG9yKFxuICBwZXJtaXNzaW9uOiBDYWNoZVBlcm1pc3Npb24gfCBEaXNwb3NhYmxlVG9rZW5DYWNoZVBlcm1pc3Npb24sXG4gIGdycGNQZXJtaXNzaW9uOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zXG4pOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zIHtcbiAgaWYgKHBlcm1pc3Npb24uY2FjaGUgPT09IEFsbENhY2hlcykge1xuICAgIGdycGNQZXJtaXNzaW9uLmFsbF9jYWNoZXMgPSBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQWxsKCk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIHBlcm1pc3Npb24uY2FjaGUgPT09ICdzdHJpbmcnKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uY2FjaGVfc2VsZWN0b3IgPVxuICAgICAgbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkNhY2hlU2VsZWN0b3Ioe1xuICAgICAgICBjYWNoZV9uYW1lOiBwZXJtaXNzaW9uLmNhY2hlLFxuICAgICAgfSk7XG4gIH0gZWxzZSBpZiAoaXNDYWNoZU5hbWUocGVybWlzc2lvbi5jYWNoZSkpIHtcbiAgICBncnBjUGVybWlzc2lvbi5jYWNoZV9zZWxlY3RvciA9XG4gICAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVTZWxlY3Rvcih7XG4gICAgICAgIGNhY2hlX25hbWU6IHBlcm1pc3Npb24uY2FjaGUubmFtZSxcbiAgICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBVbnJlY29nbml6ZWQgY2FjaGUgc3BlY2lmaWNhdGlvbiBpbiBjYWNoZSBwZXJtaXNzaW9uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBwZXJtaXNzaW9uXG4gICAgICApfWBcbiAgICApO1xuICB9XG4gIHJldHVybiBncnBjUGVybWlzc2lvbjtcbn1cblxuZnVuY3Rpb24gYXNzaWduQ2FjaGVJdGVtU2VsZWN0b3IoXG4gIHBlcm1pc3Npb246IERpc3Bvc2FibGVUb2tlbkNhY2hlUGVybWlzc2lvbixcbiAgZ3JwY1Blcm1pc3Npb246IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkNhY2hlUGVybWlzc2lvbnNcbik6IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkNhY2hlUGVybWlzc2lvbnMge1xuICBpZiAocGVybWlzc2lvbi5pdGVtID09PSBBbGxDYWNoZUl0ZW1zKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uYWxsX2l0ZW1zID0gbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkFsbCgpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBwZXJtaXNzaW9uLml0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uaXRlbV9zZWxlY3RvciA9XG4gICAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVJdGVtU2VsZWN0b3Ioe1xuICAgICAgICBrZXk6IGNvbnZlcnQocGVybWlzc2lvbi5pdGVtKSxcbiAgICAgIH0pO1xuICB9IGVsc2UgaWYgKGlzQ2FjaGVJdGVtS2V5KHBlcm1pc3Npb24uaXRlbSkpIHtcbiAgICB2YWxpZGF0ZUNhY2hlS2V5T3JQcmVmaXgocGVybWlzc2lvbi5pdGVtLmtleSk7XG4gICAgZ3JwY1Blcm1pc3Npb24uaXRlbV9zZWxlY3RvciA9XG4gICAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVJdGVtU2VsZWN0b3Ioe1xuICAgICAgICBrZXk6IGNvbnZlcnQocGVybWlzc2lvbi5pdGVtLmtleSksXG4gICAgICB9KTtcbiAgfSBlbHNlIGlmIChpc0NhY2hlSXRlbUtleVByZWZpeChwZXJtaXNzaW9uLml0ZW0pKSB7XG4gICAgdmFsaWRhdGVDYWNoZUtleU9yUHJlZml4KHBlcm1pc3Npb24uaXRlbS5rZXlQcmVmaXgpO1xuICAgIGdycGNQZXJtaXNzaW9uLml0ZW1fc2VsZWN0b3IgPVxuICAgICAgbmV3IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkNhY2hlSXRlbVNlbGVjdG9yKHtcbiAgICAgICAga2V5X3ByZWZpeDogY29udmVydChwZXJtaXNzaW9uLml0ZW0ua2V5UHJlZml4KSxcbiAgICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBVbnJlY29nbml6ZWQgY2FjaGUgaXRlbSBzcGVjaWZpY2F0aW9uIGluIGNhY2hlIHBlcm1pc3Npb246ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHBlcm1pc3Npb25cbiAgICAgICl9YFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGdycGNQZXJtaXNzaW9uO1xufVxuXG5mdW5jdGlvbiBjYWNoZVBlcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKFxuICBwZXJtaXNzaW9uOiBDYWNoZVBlcm1pc3Npb25cbik6IHBlcm1pc3Npb25fbWVzc2FnZXMuUGVybWlzc2lvbnNUeXBlLkNhY2hlUGVybWlzc2lvbnMge1xuICBsZXQgZ3JwY1Blcm1pc3Npb24gPVxuICAgIG5ldyBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zKCk7XG4gIGdycGNQZXJtaXNzaW9uID0gYXNzaWduQ2FjaGVSb2xlKHBlcm1pc3Npb24sIGdycGNQZXJtaXNzaW9uKTtcbiAgZ3JwY1Blcm1pc3Npb24gPSBhc3NpZ25DYWNoZVNlbGVjdG9yKHBlcm1pc3Npb24sIGdycGNQZXJtaXNzaW9uKTtcbiAgcmV0dXJuIGdycGNQZXJtaXNzaW9uO1xufVxuXG5mdW5jdGlvbiBkaXNwb3NhYmxlVG9rZW5QZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihcbiAgcGVybWlzc2lvbjogRGlzcG9zYWJsZVRva2VuQ2FjaGVQZXJtaXNzaW9uXG4pOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZSB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZSgpO1xuICBpZiAoaXNEaXNwb3NhYmxlVG9rZW5DYWNoZVBlcm1pc3Npb24ocGVybWlzc2lvbikpIHtcbiAgICByZXN1bHQuY2FjaGVfcGVybWlzc2lvbnMgPSBkaXNwb3NhYmxlQ2FjaGVQZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihcbiAgICAgIGFzRGlzcG9zYWJsZVRva2VuQ2FjaGVQZXJtaXNzaW9uKHBlcm1pc3Npb24pXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihcbiAgICBgVW5yZWNvZ25pemVkIHRva2VuIHBlcm1pc3Npb246ICR7SlNPTi5zdHJpbmdpZnkocGVybWlzc2lvbil9YFxuICApO1xufVxuXG5mdW5jdGlvbiBkaXNwb3NhYmxlQ2FjaGVQZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihcbiAgcGVybWlzc2lvbjogRGlzcG9zYWJsZVRva2VuQ2FjaGVQZXJtaXNzaW9uXG4pOiBwZXJtaXNzaW9uX21lc3NhZ2VzLlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zIHtcbiAgbGV0IGdycGNQZXJtaXNzaW9uID1cbiAgICBuZXcgcGVybWlzc2lvbl9tZXNzYWdlcy5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVQZXJtaXNzaW9ucygpO1xuICBncnBjUGVybWlzc2lvbiA9IGFzc2lnbkNhY2hlUm9sZShwZXJtaXNzaW9uLCBncnBjUGVybWlzc2lvbik7XG4gIGdycGNQZXJtaXNzaW9uID0gYXNzaWduQ2FjaGVTZWxlY3RvcihwZXJtaXNzaW9uLCBncnBjUGVybWlzc2lvbik7XG4gIGdycGNQZXJtaXNzaW9uID0gYXNzaWduQ2FjaGVJdGVtU2VsZWN0b3IocGVybWlzc2lvbiwgZ3JwY1Blcm1pc3Npb24pO1xuXG4gIHJldHVybiBncnBjUGVybWlzc2lvbjtcbn1cbiJdfQ==