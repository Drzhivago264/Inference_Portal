"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExperimentalMetricsLoggingMiddleware = void 0;
const experimental_metrics_middleware_1 = require("./impl/experimental-metrics-middleware");
const perf_hooks_1 = require("perf_hooks");
class ExperimentalMetricsLoggingMiddlewareRequestHandler extends experimental_metrics_middleware_1.ExperimentalMetricsMiddlewareRequestHandler {
    constructor(parent, logger, context) {
        super(parent, logger, context);
    }
    emitMetrics(metrics) {
        this.logger.info(JSON.stringify(metrics));
        return Promise.resolve();
    }
}
/**
 * This middleware enables per-request client-side metrics.  Metrics for each
 * request will be written to logs; the log data can be analyzed or shared
 * with Momento to diagnose performance issues.
 *
 * The metrics format is currently considered experimental; in a future release,
 * once the format is considered stable, this class will be renamed to remove
 * the Experimental prefix.
 *
 * It also enables regular logging of congestion in the node event loop. Once
 * per second it will output the event loop utilization ratio, as well as stats
 * about the event loop delay, measured in 20ms increments.
 *
 * WARNING: enabling this middleware may have minor performance implications,
 * so enable with caution.
 *
 * WARNING: depending on your request volume, this middleware will produce a high
 * volume of log output. If you are writing logs directly to local disk, be aware
 * of disk usage and make sure you have log rotation / compression enabled via a
 * tool such as `logrotate`.
 *
 * See `advanced.ts` in the examples directory for an example of how to set up
 * your {Configuration} to enable this middleware.
 */
class ExperimentalMetricsLoggingMiddleware extends experimental_metrics_middleware_1.ExperimentalMetricsMiddleware {
    constructor(loggerFactory) {
        super(loggerFactory, (p, l, c) => new ExperimentalMetricsLoggingMiddlewareRequestHandler(p, l, c));
        if (!ExperimentalMetricsLoggingMiddleware.isLoggingStarted) {
            ExperimentalMetricsLoggingMiddleware.isLoggingStarted = true;
            ExperimentalMetricsLoggingMiddleware.startLogging(this.logger);
        }
    }
    static startLogging(logger) {
        this.eldMonitor = (0, perf_hooks_1.monitorEventLoopDelay)({
            resolution: this.eventLoopDelayInterval,
        });
        this.eldMonitor.enable();
        this.elu = perf_hooks_1.performance.eventLoopUtilization();
        this.intervalId = setInterval(() => {
            this.elu = perf_hooks_1.performance.eventLoopUtilization(this.elu);
            const metrics = {
                eventLoopUtilization: this.elu.utilization,
                eventLoopDelayMean: this.eldMonitor.mean,
                eventLoopDelayMin: this.eldMonitor.min,
                eventLoopDelayP50: this.eldMonitor.percentile(50),
                eventLoopDelayP75: this.eldMonitor.percentile(75),
                eventLoopDelayP90: this.eldMonitor.percentile(90),
                eventLoopDelayP95: this.eldMonitor.percentile(95),
                eventLoopDelayP99: this.eldMonitor.percentile(99),
                eventLoopDelayMax: this.eldMonitor.max,
            };
            logger.info(JSON.stringify(metrics));
            this.eldMonitor.reset();
        }, this.metricsLogInterval);
    }
    close() {
        if (ExperimentalMetricsLoggingMiddleware.intervalId) {
            this.logger.debug('Stopping Metrics logging.');
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            clearInterval(ExperimentalMetricsLoggingMiddleware.intervalId);
            ExperimentalMetricsLoggingMiddleware.intervalId = null;
            ExperimentalMetricsLoggingMiddleware.isLoggingStarted = false;
            this.logger.debug('Metrics logging stopped.');
        }
    }
}
exports.ExperimentalMetricsLoggingMiddleware = ExperimentalMetricsLoggingMiddleware;
ExperimentalMetricsLoggingMiddleware.metricsLogInterval = 1000;
ExperimentalMetricsLoggingMiddleware.eventLoopDelayInterval = 20;
ExperimentalMetricsLoggingMiddleware.isLoggingStarted = false;
ExperimentalMetricsLoggingMiddleware.numActiveRequests = 0;
// eslint-disable-next-line @typescript-eslint/no-explicit-any
ExperimentalMetricsLoggingMiddleware.intervalId = null; // Store the interval ID
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudGFsLW1ldHJpY3MtbG9nZ2luZy1taWRkbGV3YXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbmZpZy9taWRkbGV3YXJlL2V4cGVyaW1lbnRhbC1tZXRyaWNzLWxvZ2dpbmctbWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw0RkFJZ0Q7QUFFaEQsMkNBS29CO0FBaURwQixNQUFNLGtEQUFtRCxTQUFRLDZFQUEyQztJQUMxRyxZQUNFLE1BQXFDLEVBQ3JDLE1BQXFCLEVBQ3JCLE9BQXdDO1FBRXhDLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxXQUFXLENBQUMsT0FBbUM7UUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzFDLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzNCLENBQUM7Q0FDRjtBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXVCRztBQUNILE1BQWEsb0NBQXFDLFNBQVEsK0RBQTZCO0lBVXJGLFlBQVksYUFBbUM7UUFDN0MsS0FBSyxDQUNILGFBQWEsRUFDYixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FDVixJQUFJLGtEQUFrRCxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQ2xFLENBQUM7UUFDRixJQUFJLENBQUMsb0NBQW9DLENBQUMsZ0JBQWdCLEVBQUU7WUFDMUQsb0NBQW9DLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1lBQzdELG9DQUFvQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDO0lBRU8sTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFxQjtRQUMvQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUEsa0NBQXFCLEVBQUM7WUFDdEMsVUFBVSxFQUFFLElBQUksQ0FBQyxzQkFBc0I7U0FDeEMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLHdCQUFXLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUU5QyxJQUFJLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDakMsSUFBSSxDQUFDLEdBQUcsR0FBRyx3QkFBVyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0RCxNQUFNLE9BQU8sR0FBaUI7Z0JBQzVCLG9CQUFvQixFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVztnQkFDMUMsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJO2dCQUN4QyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7Z0JBQ3RDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDakQsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUNqRCxpQkFBaUIsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7Z0JBQ2pELGlCQUFpQixFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDakQsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUNqRCxpQkFBaUIsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7YUFDdkMsQ0FBQztZQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDMUIsQ0FBQyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBSSxvQ0FBb0MsQ0FBQyxVQUFVLEVBQUU7WUFDbkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztZQUMvQyxpRUFBaUU7WUFDakUsYUFBYSxDQUFDLG9DQUFvQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQy9ELG9DQUFvQyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDdkQsb0NBQW9DLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1lBQzlELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7U0FDL0M7SUFDSCxDQUFDOztBQXhESCxvRkF5REM7QUF4RHlCLHVEQUFrQixHQUFHLElBQUksQ0FBQztBQUMxQiwyREFBc0IsR0FBRyxFQUFFLENBQUM7QUFHckMscURBQWdCLEdBQUcsS0FBSyxDQUFDO0FBQ2pDLHNEQUFpQixHQUFHLENBQUMsQ0FBQztBQUM3Qiw4REFBOEQ7QUFDL0MsK0NBQVUsR0FBZSxJQUFJLENBQUMsQ0FBQyx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vbWVudG9Mb2dnZXIsIE1vbWVudG9Mb2dnZXJGYWN0b3J5fSBmcm9tICcuLi8uLi8nO1xuaW1wb3J0IHtcbiAgRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmUsXG4gIEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIsXG4gIEV4cGVyaW1lbnRhbFJlcXVlc3RNZXRyaWNzLFxufSBmcm9tICcuL2ltcGwvZXhwZXJpbWVudGFsLW1ldHJpY3MtbWlkZGxld2FyZSc7XG5pbXBvcnQge01pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHR9IGZyb20gJy4vbWlkZGxld2FyZSc7XG5pbXBvcnQge1xuICBFdmVudExvb3BEZWxheU1vbml0b3IsXG4gIEV2ZW50TG9vcFV0aWxpemF0aW9uLFxuICBtb25pdG9yRXZlbnRMb29wRGVsYXksXG4gIHBlcmZvcm1hbmNlLFxufSBmcm9tICdwZXJmX2hvb2tzJztcblxuaW50ZXJmYWNlIFN0YXRlTWV0cmljcyB7XG4gIC8qKlxuICAgKiBUaGUgcHJvcG9ydGlvbiBvZiB0aW1lIHRoZSBldmVudCBsb29wIHdhcyBidXN5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLlxuICAgKi9cbiAgZXZlbnRMb29wVXRpbGl6YXRpb246IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIGF2ZXJhZ2UgZXZlbnQgbG9vcCBkZWxheSBvdmVyIHRoZSBsYXN0IHNlY29uZCwgbWVhc3VyZWQgaW4gMjBtcyBpbmNyZW1lbnRzLlxuICAgKi9cbiAgZXZlbnRMb29wRGVsYXlNZWFuOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBtaW5pbXVtIGV2ZW50IGxvb3AgZGVsYXkgb3ZlciB0aGUgbGFzdCBzZWNvbmQsIG1lYXN1cmVkIGluIDIwbXMgaW5jcmVtZW50cy5cbiAgICovXG4gIGV2ZW50TG9vcERlbGF5TWluOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSA1MHRoIHBlcmNlbnRpbGUgZXZlbnQgbG9vcCBkZWxheSBvdmVyIHRoZSBsYXN0IHNlY29uZCwgbWVhc3VyZWQgaW4gMjBtcyBpbmNyZW1lbnRzLlxuICAgKi9cbiAgZXZlbnRMb29wRGVsYXlQNTA6IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIDc1dGggcGVyY2VudGlsZSBldmVudCBsb29wIGRlbGF5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gICAqL1xuICBldmVudExvb3BEZWxheVA3NTogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgOTB0aCBwZXJjZW50aWxlIGV2ZW50IGxvb3AgZGVsYXkgb3ZlciB0aGUgbGFzdCBzZWNvbmQsIG1lYXN1cmVkIGluIDIwbXMgaW5jcmVtZW50cy5cbiAgICovXG4gIGV2ZW50TG9vcERlbGF5UDkwOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSA5NXRoIHBlcmNlbnRpbGUgZXZlbnQgbG9vcCBkZWxheSBvdmVyIHRoZSBsYXN0IHNlY29uZCwgbWVhc3VyZWQgaW4gMjBtcyBpbmNyZW1lbnRzLlxuICAgKi9cbiAgZXZlbnRMb29wRGVsYXlQOTU6IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIDk5dGggcGVyY2VudGlsZSBldmVudCBsb29wIGRlbGF5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gICAqL1xuICBldmVudExvb3BEZWxheVA5OTogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgbWF4aW11bSBldmVudCBsb29wIGRlbGF5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gICAqL1xuICBldmVudExvb3BEZWxheU1heDogbnVtYmVyO1xufVxuXG5jbGFzcyBFeHBlcmltZW50YWxNZXRyaWNzTG9nZ2luZ01pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlciBleHRlbmRzIEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwYXJlbnQ6IEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlLFxuICAgIGxvZ2dlcjogTW9tZW50b0xvZ2dlcixcbiAgICBjb250ZXh0OiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJDb250ZXh0XG4gICkge1xuICAgIHN1cGVyKHBhcmVudCwgbG9nZ2VyLCBjb250ZXh0KTtcbiAgfVxuXG4gIGVtaXRNZXRyaWNzKG1ldHJpY3M6IEV4cGVyaW1lbnRhbFJlcXVlc3RNZXRyaWNzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5sb2dnZXIuaW5mbyhKU09OLnN0cmluZ2lmeShtZXRyaWNzKSk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG59XG5cbi8qKlxuICogVGhpcyBtaWRkbGV3YXJlIGVuYWJsZXMgcGVyLXJlcXVlc3QgY2xpZW50LXNpZGUgbWV0cmljcy4gIE1ldHJpY3MgZm9yIGVhY2hcbiAqIHJlcXVlc3Qgd2lsbCBiZSB3cml0dGVuIHRvIGxvZ3M7IHRoZSBsb2cgZGF0YSBjYW4gYmUgYW5hbHl6ZWQgb3Igc2hhcmVkXG4gKiB3aXRoIE1vbWVudG8gdG8gZGlhZ25vc2UgcGVyZm9ybWFuY2UgaXNzdWVzLlxuICpcbiAqIFRoZSBtZXRyaWNzIGZvcm1hdCBpcyBjdXJyZW50bHkgY29uc2lkZXJlZCBleHBlcmltZW50YWw7IGluIGEgZnV0dXJlIHJlbGVhc2UsXG4gKiBvbmNlIHRoZSBmb3JtYXQgaXMgY29uc2lkZXJlZCBzdGFibGUsIHRoaXMgY2xhc3Mgd2lsbCBiZSByZW5hbWVkIHRvIHJlbW92ZVxuICogdGhlIEV4cGVyaW1lbnRhbCBwcmVmaXguXG4gKlxuICogSXQgYWxzbyBlbmFibGVzIHJlZ3VsYXIgbG9nZ2luZyBvZiBjb25nZXN0aW9uIGluIHRoZSBub2RlIGV2ZW50IGxvb3AuIE9uY2VcbiAqIHBlciBzZWNvbmQgaXQgd2lsbCBvdXRwdXQgdGhlIGV2ZW50IGxvb3AgdXRpbGl6YXRpb24gcmF0aW8sIGFzIHdlbGwgYXMgc3RhdHNcbiAqIGFib3V0IHRoZSBldmVudCBsb29wIGRlbGF5LCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gKlxuICogV0FSTklORzogZW5hYmxpbmcgdGhpcyBtaWRkbGV3YXJlIG1heSBoYXZlIG1pbm9yIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucyxcbiAqIHNvIGVuYWJsZSB3aXRoIGNhdXRpb24uXG4gKlxuICogV0FSTklORzogZGVwZW5kaW5nIG9uIHlvdXIgcmVxdWVzdCB2b2x1bWUsIHRoaXMgbWlkZGxld2FyZSB3aWxsIHByb2R1Y2UgYSBoaWdoXG4gKiB2b2x1bWUgb2YgbG9nIG91dHB1dC4gSWYgeW91IGFyZSB3cml0aW5nIGxvZ3MgZGlyZWN0bHkgdG8gbG9jYWwgZGlzaywgYmUgYXdhcmVcbiAqIG9mIGRpc2sgdXNhZ2UgYW5kIG1ha2Ugc3VyZSB5b3UgaGF2ZSBsb2cgcm90YXRpb24gLyBjb21wcmVzc2lvbiBlbmFibGVkIHZpYSBhXG4gKiB0b29sIHN1Y2ggYXMgYGxvZ3JvdGF0ZWAuXG4gKlxuICogU2VlIGBhZHZhbmNlZC50c2AgaW4gdGhlIGV4YW1wbGVzIGRpcmVjdG9yeSBmb3IgYW4gZXhhbXBsZSBvZiBob3cgdG8gc2V0IHVwXG4gKiB5b3VyIHtDb25maWd1cmF0aW9ufSB0byBlbmFibGUgdGhpcyBtaWRkbGV3YXJlLlxuICovXG5leHBvcnQgY2xhc3MgRXhwZXJpbWVudGFsTWV0cmljc0xvZ2dpbmdNaWRkbGV3YXJlIGV4dGVuZHMgRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmUge1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBtZXRyaWNzTG9nSW50ZXJ2YWwgPSAxMDAwO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBldmVudExvb3BEZWxheUludGVydmFsID0gMjA7XG4gIHByaXZhdGUgc3RhdGljIGVsZE1vbml0b3I6IEV2ZW50TG9vcERlbGF5TW9uaXRvcjtcbiAgcHJpdmF0ZSBzdGF0aWMgZWx1OiBFdmVudExvb3BVdGlsaXphdGlvbjtcbiAgcHJpdmF0ZSBzdGF0aWMgaXNMb2dnaW5nU3RhcnRlZCA9IGZhbHNlO1xuICBzdGF0aWMgbnVtQWN0aXZlUmVxdWVzdHMgPSAwO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBwcml2YXRlIHN0YXRpYyBpbnRlcnZhbElkOiBhbnkgfCBudWxsID0gbnVsbDsgLy8gU3RvcmUgdGhlIGludGVydmFsIElEXG5cbiAgY29uc3RydWN0b3IobG9nZ2VyRmFjdG9yeTogTW9tZW50b0xvZ2dlckZhY3RvcnkpIHtcbiAgICBzdXBlcihcbiAgICAgIGxvZ2dlckZhY3RvcnksXG4gICAgICAocCwgbCwgYykgPT5cbiAgICAgICAgbmV3IEV4cGVyaW1lbnRhbE1ldHJpY3NMb2dnaW5nTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKHAsIGwsIGMpXG4gICAgKTtcbiAgICBpZiAoIUV4cGVyaW1lbnRhbE1ldHJpY3NMb2dnaW5nTWlkZGxld2FyZS5pc0xvZ2dpbmdTdGFydGVkKSB7XG4gICAgICBFeHBlcmltZW50YWxNZXRyaWNzTG9nZ2luZ01pZGRsZXdhcmUuaXNMb2dnaW5nU3RhcnRlZCA9IHRydWU7XG4gICAgICBFeHBlcmltZW50YWxNZXRyaWNzTG9nZ2luZ01pZGRsZXdhcmUuc3RhcnRMb2dnaW5nKHRoaXMubG9nZ2VyKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBzdGFydExvZ2dpbmcobG9nZ2VyOiBNb21lbnRvTG9nZ2VyKTogdm9pZCB7XG4gICAgdGhpcy5lbGRNb25pdG9yID0gbW9uaXRvckV2ZW50TG9vcERlbGF5KHtcbiAgICAgIHJlc29sdXRpb246IHRoaXMuZXZlbnRMb29wRGVsYXlJbnRlcnZhbCxcbiAgICB9KTtcbiAgICB0aGlzLmVsZE1vbml0b3IuZW5hYmxlKCk7XG4gICAgdGhpcy5lbHUgPSBwZXJmb3JtYW5jZS5ldmVudExvb3BVdGlsaXphdGlvbigpO1xuXG4gICAgdGhpcy5pbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgdGhpcy5lbHUgPSBwZXJmb3JtYW5jZS5ldmVudExvb3BVdGlsaXphdGlvbih0aGlzLmVsdSk7XG4gICAgICBjb25zdCBtZXRyaWNzOiBTdGF0ZU1ldHJpY3MgPSB7XG4gICAgICAgIGV2ZW50TG9vcFV0aWxpemF0aW9uOiB0aGlzLmVsdS51dGlsaXphdGlvbixcbiAgICAgICAgZXZlbnRMb29wRGVsYXlNZWFuOiB0aGlzLmVsZE1vbml0b3IubWVhbixcbiAgICAgICAgZXZlbnRMb29wRGVsYXlNaW46IHRoaXMuZWxkTW9uaXRvci5taW4sXG4gICAgICAgIGV2ZW50TG9vcERlbGF5UDUwOiB0aGlzLmVsZE1vbml0b3IucGVyY2VudGlsZSg1MCksXG4gICAgICAgIGV2ZW50TG9vcERlbGF5UDc1OiB0aGlzLmVsZE1vbml0b3IucGVyY2VudGlsZSg3NSksXG4gICAgICAgIGV2ZW50TG9vcERlbGF5UDkwOiB0aGlzLmVsZE1vbml0b3IucGVyY2VudGlsZSg5MCksXG4gICAgICAgIGV2ZW50TG9vcERlbGF5UDk1OiB0aGlzLmVsZE1vbml0b3IucGVyY2VudGlsZSg5NSksXG4gICAgICAgIGV2ZW50TG9vcERlbGF5UDk5OiB0aGlzLmVsZE1vbml0b3IucGVyY2VudGlsZSg5OSksXG4gICAgICAgIGV2ZW50TG9vcERlbGF5TWF4OiB0aGlzLmVsZE1vbml0b3IubWF4LFxuICAgICAgfTtcbiAgICAgIGxvZ2dlci5pbmZvKEpTT04uc3RyaW5naWZ5KG1ldHJpY3MpKTtcbiAgICAgIHRoaXMuZWxkTW9uaXRvci5yZXNldCgpO1xuICAgIH0sIHRoaXMubWV0cmljc0xvZ0ludGVydmFsKTtcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIGlmIChFeHBlcmltZW50YWxNZXRyaWNzTG9nZ2luZ01pZGRsZXdhcmUuaW50ZXJ2YWxJZCkge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ1N0b3BwaW5nIE1ldHJpY3MgbG9nZ2luZy4nKTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFyZ3VtZW50XG4gICAgICBjbGVhckludGVydmFsKEV4cGVyaW1lbnRhbE1ldHJpY3NMb2dnaW5nTWlkZGxld2FyZS5pbnRlcnZhbElkKTtcbiAgICAgIEV4cGVyaW1lbnRhbE1ldHJpY3NMb2dnaW5nTWlkZGxld2FyZS5pbnRlcnZhbElkID0gbnVsbDtcbiAgICAgIEV4cGVyaW1lbnRhbE1ldHJpY3NMb2dnaW5nTWlkZGxld2FyZS5pc0xvZ2dpbmdTdGFydGVkID0gZmFsc2U7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnTWV0cmljcyBsb2dnaW5nIHN0b3BwZWQuJyk7XG4gICAgfVxuICB9XG59XG4iXX0=