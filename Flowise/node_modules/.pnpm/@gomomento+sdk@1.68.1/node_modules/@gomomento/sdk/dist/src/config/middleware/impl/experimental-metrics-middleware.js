"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExperimentalMetricsMiddleware = exports.ExperimentalMetricsMiddlewareRequestHandler = void 0;
const cache_data_client_1 = require("../../../internal/cache-data-client");
const FIELD_NAMES = [
    'numActiveRequestsAtStart',
    'numActiveRequestsAtFinish',
    'requestType',
    'status',
    'startTime',
    'requestBodyTime',
    'endTime',
    'duration',
    'requestSize',
    'responseSize',
    'connectionID',
];
class ExperimentalMetricsMiddlewareRequestHandler {
    constructor(parent, logger, context) {
        this.parent = parent;
        this.logger = logger;
        this.connectionID = context[cache_data_client_1.CONNECTION_ID_KEY];
        this.numActiveRequestsAtStart = parent.incrementActiveRequestCount();
        this.startTime = new Date().getTime();
        this.receivedResponseBody = false;
        this.receivedResponseStatus = false;
    }
    onRequestBody(request) {
        this.requestSize = request.messageLength();
        this.requestType = request._grpcMessage.constructor.name;
        this.requestBodyTime = new Date().getTime();
        return Promise.resolve(request);
    }
    onRequestMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseBody(response) {
        if (response !== null) {
            this.responseSize = response.messageLength();
        }
        else {
            this.responseSize = 0;
        }
        this.receivedResponseBody = true;
        if (this.done())
            this.recordMetrics();
        return Promise.resolve(response);
    }
    onResponseMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseStatus(status) {
        this.receivedResponseStatus = true;
        this.responseStatusCode = status.code();
        if (this.done())
            this.recordMetrics();
        return Promise.resolve(status);
    }
    done() {
        return this.receivedResponseBody && this.receivedResponseStatus;
    }
    recordMetrics() {
        const endTime = new Date().getTime();
        const metrics = {
            momento: {
                numActiveRequestsAtStart: this.numActiveRequestsAtStart,
                numActiveRequestsAtFinish: this.parent.activeRequestCount(),
                requestType: this.requestType,
                status: this.responseStatusCode,
                startTime: this.startTime,
                requestBodyTime: this.requestBodyTime,
                endTime: endTime,
                duration: endTime - this.startTime,
                requestSize: this.requestSize,
                responseSize: this.responseSize,
                connectionID: this.connectionID,
            },
        };
        this.emitMetrics(metrics).catch(e => 
        // eslint-disable-next-line @typescript-eslint/restrict-template-expressions
        this.logger.error(`An error occurred when trying to emit metrics: ${e}`));
        this.parent.decrementActiveRequestCount();
    }
}
exports.ExperimentalMetricsMiddlewareRequestHandler = ExperimentalMetricsMiddlewareRequestHandler;
/**
 * This middleware enables per-request client-side metrics.  This is an abstract
 * class that does not route the metrics to a specific destination; concrete subclasses
 * may store the metrics as they see fit.
 *
 * The metrics format is currently considered experimental; in a future release,
 * once the format is considered stable, this class will be renamed to remove
 * the Experimental prefix.
 *
 * WARNING: enabling this middleware may have minor performance implications,
 * so enable with caution.
 *
 * See `advanced.ts` in the examples directory for an example of how to set up
 * your {Configuration} to enable this middleware.
 */
class ExperimentalMetricsMiddleware {
    constructor(loggerFactory, requestHandlerFactoryFn) {
        this.numActiveRequests = 0;
        this.logger = loggerFactory.getLogger(this);
        this.requestHandlerFactoryFn = requestHandlerFactoryFn;
    }
    fieldNames() {
        return FIELD_NAMES;
    }
    incrementActiveRequestCount() {
        return ++this.numActiveRequests;
    }
    activeRequestCount() {
        return this.numActiveRequests;
    }
    decrementActiveRequestCount() {
        --this.numActiveRequests;
    }
    onNewRequest(context) {
        return this.requestHandlerFactoryFn(this, this.logger, context);
    }
}
exports.ExperimentalMetricsMiddleware = ExperimentalMetricsMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudGFsLW1ldHJpY3MtbWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb25maWcvbWlkZGxld2FyZS9pbXBsL2V4cGVyaW1lbnRhbC1tZXRyaWNzLW1pZGRsZXdhcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBU0EsMkVBQXNFO0FBRXRFLE1BQU0sV0FBVyxHQUFrQjtJQUNqQywwQkFBMEI7SUFDMUIsMkJBQTJCO0lBQzNCLGFBQWE7SUFDYixRQUFRO0lBQ1IsV0FBVztJQUNYLGlCQUFpQjtJQUNqQixTQUFTO0lBQ1QsVUFBVTtJQUNWLGFBQWE7SUFDYixjQUFjO0lBQ2QsY0FBYztDQUNmLENBQUM7QUFtREYsTUFBc0IsMkNBQTJDO0lBa0IvRCxZQUNFLE1BQXFDLEVBQ3JDLE1BQXFCLEVBQ3JCLE9BQXdDO1FBRXhDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLHFDQUFpQixDQUFDLENBQUM7UUFFL0MsSUFBSSxDQUFDLHdCQUF3QixHQUFHLE1BQU0sQ0FBQywyQkFBMkIsRUFBRSxDQUFDO1FBQ3JFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUV0QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxLQUFLLENBQUM7SUFDdEMsQ0FBQztJQUlELGFBQWEsQ0FBQyxPQUEwQjtRQUN0QyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQztRQUN6RCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDNUMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxRQUE0QjtRQUM1QyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELGNBQWMsQ0FDWixRQUFrQztRQUVsQyxJQUFJLFFBQVEsS0FBSyxJQUFJLEVBQUU7WUFDckIsSUFBSSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDOUM7YUFBTTtZQUNMLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1NBQ3ZCO1FBQ0QsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztRQUNqQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDdEMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxrQkFBa0IsQ0FDaEIsUUFBNEI7UUFFNUIsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxNQUF3QjtRQUN2QyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDeEMsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3RDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRU8sSUFBSTtRQUNWLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztJQUNsRSxDQUFDO0lBRU8sYUFBYTtRQUNuQixNQUFNLE9BQU8sR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3JDLE1BQU0sT0FBTyxHQUErQjtZQUMxQyxPQUFPLEVBQUU7Z0JBQ1Asd0JBQXdCLEVBQUUsSUFBSSxDQUFDLHdCQUF3QjtnQkFDdkQseUJBQXlCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRTtnQkFDM0QsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO2dCQUM3QixNQUFNLEVBQUUsSUFBSSxDQUFDLGtCQUFrQjtnQkFDL0IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixlQUFlLEVBQUUsSUFBSSxDQUFDLGVBQWU7Z0JBQ3JDLE9BQU8sRUFBRSxPQUFPO2dCQUNoQixRQUFRLEVBQUUsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTO2dCQUNsQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7Z0JBQzdCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtnQkFDL0IsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQ2hDO1NBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ2xDLDRFQUE0RTtRQUM1RSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxFQUFFLENBQUMsQ0FDekUsQ0FBQztRQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0NBQ0Y7QUFwR0Qsa0dBb0dDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7O0dBY0c7QUFDSCxNQUFzQiw2QkFBNkI7SUFVakQsWUFDRSxhQUFtQyxFQUNuQyx1QkFJNkI7UUFmdkIsc0JBQWlCLEdBQUcsQ0FBQyxDQUFDO1FBaUI1QixJQUFJLENBQUMsTUFBTSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLHVCQUF1QixHQUFHLHVCQUF1QixDQUFDO0lBQ3pELENBQUM7SUFFRCxVQUFVO1FBQ1IsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVELDJCQUEyQjtRQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDO0lBQ2xDLENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUM7SUFDaEMsQ0FBQztJQUVELDJCQUEyQjtRQUN6QixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBRUQsWUFBWSxDQUNWLE9BQXdDO1FBRXhDLE9BQU8sSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xFLENBQUM7Q0FDRjtBQTNDRCxzRUEyQ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBNaWRkbGV3YXJlLFxuICBNaWRkbGV3YXJlTWVzc2FnZSxcbiAgTWlkZGxld2FyZU1ldGFkYXRhLFxuICBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIsXG4gIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHQsXG4gIE1pZGRsZXdhcmVTdGF0dXMsXG59IGZyb20gJy4uL21pZGRsZXdhcmUnO1xuaW1wb3J0IHtNb21lbnRvTG9nZ2VyLCBNb21lbnRvTG9nZ2VyRmFjdG9yeX0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZSc7XG5pbXBvcnQge0NPTk5FQ1RJT05fSURfS0VZfSBmcm9tICcuLi8uLi8uLi9pbnRlcm5hbC9jYWNoZS1kYXRhLWNsaWVudCc7XG5cbmNvbnN0IEZJRUxEX05BTUVTOiBBcnJheTxzdHJpbmc+ID0gW1xuICAnbnVtQWN0aXZlUmVxdWVzdHNBdFN0YXJ0JyxcbiAgJ251bUFjdGl2ZVJlcXVlc3RzQXRGaW5pc2gnLFxuICAncmVxdWVzdFR5cGUnLFxuICAnc3RhdHVzJyxcbiAgJ3N0YXJ0VGltZScsXG4gICdyZXF1ZXN0Qm9keVRpbWUnLFxuICAnZW5kVGltZScsXG4gICdkdXJhdGlvbicsXG4gICdyZXF1ZXN0U2l6ZScsXG4gICdyZXNwb25zZVNpemUnLFxuICAnY29ubmVjdGlvbklEJyxcbl07XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhwZXJpbWVudGFsUmVxdWVzdE1ldHJpY3Mge1xuICBtb21lbnRvOiB7XG4gICAgLyoqXG4gICAgICogbnVtYmVyIG9mIHJlcXVlc3RzIGFjdGl2ZSBhdCB0aGUgc3RhcnQgb2YgdGhlIHJlcXVlc3RcbiAgICAgKi9cbiAgICBudW1BY3RpdmVSZXF1ZXN0c0F0U3RhcnQ6IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBudW1iZXIgb2YgcmVxdWVzdHMgYWN0aXZlIGF0IHRoZSBmaW5pc2ggb2YgdGhlIHJlcXVlc3QgKGluY2x1ZGluZyB0aGUgcmVxdWVzdCBpdHNlbGYpXG4gICAgICovXG4gICAgbnVtQWN0aXZlUmVxdWVzdHNBdEZpbmlzaDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBnZW5lcmF0ZWQgZ3JwYyBvYmplY3QgdHlwZSBvZiB0aGUgcmVxdWVzdFxuICAgICAqL1xuICAgIHJlcXVlc3RUeXBlOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVGhlIGdycGMgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlXG4gICAgICovXG4gICAgc3RhdHVzOiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIHRpbWUgdGhlIHJlcXVlc3Qgc3RhcnRlZCAobWlsbGlzIHNpbmNlIGVwb2NoKVxuICAgICAqL1xuICAgIHN0YXJ0VGltZTogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSB0aW1lIHRoZSBib2R5IG9mIHRoZSByZXF1ZXN0IHdhcyBhdmFpbGFibGUgdG8gdGhlIGdycGMgbGlicmFyeSAobWlsbGlzIHNpbmNlIGVwb2NoKVxuICAgICAqL1xuICAgIHJlcXVlc3RCb2R5VGltZTogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSB0aW1lIHRoZSByZXF1ZXN0IGNvbXBsZXRlZCAobWlsbGlzIHNpbmNlIGVwb2NoKVxuICAgICAqL1xuICAgIGVuZFRpbWU6IG51bWJlcjtcbiAgICAvKipcbiAgICAgKiBUaGUgZHVyYXRpb24gb2YgdGhlIHJlcXVlc3QgKGluIG1pbGxpcylcbiAgICAgKi9cbiAgICBkdXJhdGlvbjogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBzaXplIG9mIHRoZSByZXF1ZXN0IGJvZHkgaW4gYnl0ZXNcbiAgICAgKi9cbiAgICByZXF1ZXN0U2l6ZTogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIFRoZSBzaXplIG9mIHRoZSByZXNwb25zZSBib2R5IGluIGJ5dGVzXG4gICAgICovXG4gICAgcmVzcG9uc2VTaXplOiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIElEIG9mIHRoZSBzcGVjaWZpYyBjb25uZWN0aW9uIHRoYXQgbWFkZSB0aGUgcmVxdWVzdFxuICAgICAqL1xuICAgIGNvbm5lY3Rpb25JRDogc3RyaW5nO1xuICB9O1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlclxuICBpbXBsZW1lbnRzIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlclxue1xuICBwcml2YXRlIHJlYWRvbmx5IHBhcmVudDogRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmU7XG4gIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29ubmVjdGlvbklEOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBudW1BY3RpdmVSZXF1ZXN0c0F0U3RhcnQ6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFydFRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSByZXF1ZXN0Qm9keVRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSByZXF1ZXN0VHlwZTogc3RyaW5nO1xuICBwcml2YXRlIHJlcXVlc3RTaXplOiBudW1iZXI7XG4gIHByaXZhdGUgcmVzcG9uc2VTdGF0dXNDb2RlOiBudW1iZXI7XG4gIHByaXZhdGUgcmVzcG9uc2VTaXplOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSByZWNlaXZlZFJlc3BvbnNlQm9keTogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWNlaXZlZFJlc3BvbnNlU3RhdHVzOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHBhcmVudDogRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmUsXG4gICAgbG9nZ2VyOiBNb21lbnRvTG9nZ2VyLFxuICAgIGNvbnRleHQ6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHRcbiAgKSB7XG4gICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG4gICAgdGhpcy5jb25uZWN0aW9uSUQgPSBjb250ZXh0W0NPTk5FQ1RJT05fSURfS0VZXTtcblxuICAgIHRoaXMubnVtQWN0aXZlUmVxdWVzdHNBdFN0YXJ0ID0gcGFyZW50LmluY3JlbWVudEFjdGl2ZVJlcXVlc3RDb3VudCgpO1xuICAgIHRoaXMuc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cbiAgICB0aGlzLnJlY2VpdmVkUmVzcG9uc2VCb2R5ID0gZmFsc2U7XG4gICAgdGhpcy5yZWNlaXZlZFJlc3BvbnNlU3RhdHVzID0gZmFsc2U7XG4gIH1cblxuICBhYnN0cmFjdCBlbWl0TWV0cmljcyhtZXRyaWNzOiBFeHBlcmltZW50YWxSZXF1ZXN0TWV0cmljcyk6IFByb21pc2U8dm9pZD47XG5cbiAgb25SZXF1ZXN0Qm9keShyZXF1ZXN0OiBNaWRkbGV3YXJlTWVzc2FnZSk6IFByb21pc2U8TWlkZGxld2FyZU1lc3NhZ2U+IHtcbiAgICB0aGlzLnJlcXVlc3RTaXplID0gcmVxdWVzdC5tZXNzYWdlTGVuZ3RoKCk7XG4gICAgdGhpcy5yZXF1ZXN0VHlwZSA9IHJlcXVlc3QuX2dycGNNZXNzYWdlLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgdGhpcy5yZXF1ZXN0Qm9keVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QpO1xuICB9XG5cbiAgb25SZXF1ZXN0TWV0YWRhdGEobWV0YWRhdGE6IE1pZGRsZXdhcmVNZXRhZGF0YSk6IFByb21pc2U8TWlkZGxld2FyZU1ldGFkYXRhPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtZXRhZGF0YSk7XG4gIH1cblxuICBvblJlc3BvbnNlQm9keShcbiAgICByZXNwb25zZTogTWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsXG4gICk6IFByb21pc2U8TWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsPiB7XG4gICAgaWYgKHJlc3BvbnNlICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnJlc3BvbnNlU2l6ZSA9IHJlc3BvbnNlLm1lc3NhZ2VMZW5ndGgoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZXNwb25zZVNpemUgPSAwO1xuICAgIH1cbiAgICB0aGlzLnJlY2VpdmVkUmVzcG9uc2VCb2R5ID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5kb25lKCkpIHRoaXMucmVjb3JkTWV0cmljcygpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2UpO1xuICB9XG5cbiAgb25SZXNwb25zZU1ldGFkYXRhKFxuICAgIG1ldGFkYXRhOiBNaWRkbGV3YXJlTWV0YWRhdGFcbiAgKTogUHJvbWlzZTxNaWRkbGV3YXJlTWV0YWRhdGE+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1ldGFkYXRhKTtcbiAgfVxuXG4gIG9uUmVzcG9uc2VTdGF0dXMoc3RhdHVzOiBNaWRkbGV3YXJlU3RhdHVzKTogUHJvbWlzZTxNaWRkbGV3YXJlU3RhdHVzPiB7XG4gICAgdGhpcy5yZWNlaXZlZFJlc3BvbnNlU3RhdHVzID0gdHJ1ZTtcbiAgICB0aGlzLnJlc3BvbnNlU3RhdHVzQ29kZSA9IHN0YXR1cy5jb2RlKCk7XG4gICAgaWYgKHRoaXMuZG9uZSgpKSB0aGlzLnJlY29yZE1ldHJpY3MoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHN0YXR1cyk7XG4gIH1cblxuICBwcml2YXRlIGRvbmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucmVjZWl2ZWRSZXNwb25zZUJvZHkgJiYgdGhpcy5yZWNlaXZlZFJlc3BvbnNlU3RhdHVzO1xuICB9XG5cbiAgcHJpdmF0ZSByZWNvcmRNZXRyaWNzKCk6IHZvaWQge1xuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICBjb25zdCBtZXRyaWNzOiBFeHBlcmltZW50YWxSZXF1ZXN0TWV0cmljcyA9IHtcbiAgICAgIG1vbWVudG86IHtcbiAgICAgICAgbnVtQWN0aXZlUmVxdWVzdHNBdFN0YXJ0OiB0aGlzLm51bUFjdGl2ZVJlcXVlc3RzQXRTdGFydCxcbiAgICAgICAgbnVtQWN0aXZlUmVxdWVzdHNBdEZpbmlzaDogdGhpcy5wYXJlbnQuYWN0aXZlUmVxdWVzdENvdW50KCksXG4gICAgICAgIHJlcXVlc3RUeXBlOiB0aGlzLnJlcXVlc3RUeXBlLFxuICAgICAgICBzdGF0dXM6IHRoaXMucmVzcG9uc2VTdGF0dXNDb2RlLFxuICAgICAgICBzdGFydFRpbWU6IHRoaXMuc3RhcnRUaW1lLFxuICAgICAgICByZXF1ZXN0Qm9keVRpbWU6IHRoaXMucmVxdWVzdEJvZHlUaW1lLFxuICAgICAgICBlbmRUaW1lOiBlbmRUaW1lLFxuICAgICAgICBkdXJhdGlvbjogZW5kVGltZSAtIHRoaXMuc3RhcnRUaW1lLFxuICAgICAgICByZXF1ZXN0U2l6ZTogdGhpcy5yZXF1ZXN0U2l6ZSxcbiAgICAgICAgcmVzcG9uc2VTaXplOiB0aGlzLnJlc3BvbnNlU2l6ZSxcbiAgICAgICAgY29ubmVjdGlvbklEOiB0aGlzLmNvbm5lY3Rpb25JRCxcbiAgICAgIH0sXG4gICAgfTtcbiAgICB0aGlzLmVtaXRNZXRyaWNzKG1ldHJpY3MpLmNhdGNoKGUgPT5cbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvcmVzdHJpY3QtdGVtcGxhdGUtZXhwcmVzc2lvbnNcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBBbiBlcnJvciBvY2N1cnJlZCB3aGVuIHRyeWluZyB0byBlbWl0IG1ldHJpY3M6ICR7ZX1gKVxuICAgICk7XG4gICAgdGhpcy5wYXJlbnQuZGVjcmVtZW50QWN0aXZlUmVxdWVzdENvdW50KCk7XG4gIH1cbn1cblxuLyoqXG4gKiBUaGlzIG1pZGRsZXdhcmUgZW5hYmxlcyBwZXItcmVxdWVzdCBjbGllbnQtc2lkZSBtZXRyaWNzLiAgVGhpcyBpcyBhbiBhYnN0cmFjdFxuICogY2xhc3MgdGhhdCBkb2VzIG5vdCByb3V0ZSB0aGUgbWV0cmljcyB0byBhIHNwZWNpZmljIGRlc3RpbmF0aW9uOyBjb25jcmV0ZSBzdWJjbGFzc2VzXG4gKiBtYXkgc3RvcmUgdGhlIG1ldHJpY3MgYXMgdGhleSBzZWUgZml0LlxuICpcbiAqIFRoZSBtZXRyaWNzIGZvcm1hdCBpcyBjdXJyZW50bHkgY29uc2lkZXJlZCBleHBlcmltZW50YWw7IGluIGEgZnV0dXJlIHJlbGVhc2UsXG4gKiBvbmNlIHRoZSBmb3JtYXQgaXMgY29uc2lkZXJlZCBzdGFibGUsIHRoaXMgY2xhc3Mgd2lsbCBiZSByZW5hbWVkIHRvIHJlbW92ZVxuICogdGhlIEV4cGVyaW1lbnRhbCBwcmVmaXguXG4gKlxuICogV0FSTklORzogZW5hYmxpbmcgdGhpcyBtaWRkbGV3YXJlIG1heSBoYXZlIG1pbm9yIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucyxcbiAqIHNvIGVuYWJsZSB3aXRoIGNhdXRpb24uXG4gKlxuICogU2VlIGBhZHZhbmNlZC50c2AgaW4gdGhlIGV4YW1wbGVzIGRpcmVjdG9yeSBmb3IgYW4gZXhhbXBsZSBvZiBob3cgdG8gc2V0IHVwXG4gKiB5b3VyIHtDb25maWd1cmF0aW9ufSB0byBlbmFibGUgdGhpcyBtaWRkbGV3YXJlLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmUgaW1wbGVtZW50cyBNaWRkbGV3YXJlIHtcbiAgcHJpdmF0ZSBudW1BY3RpdmVSZXF1ZXN0cyA9IDA7XG4gIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG5cbiAgcHJpdmF0ZSByZWFkb25seSByZXF1ZXN0SGFuZGxlckZhY3RvcnlGbjogKFxuICAgIHBhcmVudDogRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmUsXG4gICAgbG9nZ2VyOiBNb21lbnRvTG9nZ2VyLFxuICAgIGNvbnRleHQ6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHRcbiAgKSA9PiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgbG9nZ2VyRmFjdG9yeTogTW9tZW50b0xvZ2dlckZhY3RvcnksXG4gICAgcmVxdWVzdEhhbmRsZXJGYWN0b3J5Rm46IChcbiAgICAgIHBhcmVudDogRXhwZXJpbWVudGFsTWV0cmljc01pZGRsZXdhcmUsXG4gICAgICBsb2dnZXI6IE1vbWVudG9Mb2dnZXIsXG4gICAgICBjb250ZXh0OiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJDb250ZXh0XG4gICAgKSA9PiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJcbiAgKSB7XG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXJGYWN0b3J5LmdldExvZ2dlcih0aGlzKTtcbiAgICB0aGlzLnJlcXVlc3RIYW5kbGVyRmFjdG9yeUZuID0gcmVxdWVzdEhhbmRsZXJGYWN0b3J5Rm47XG4gIH1cblxuICBmaWVsZE5hbWVzKCk6IEFycmF5PHN0cmluZz4ge1xuICAgIHJldHVybiBGSUVMRF9OQU1FUztcbiAgfVxuXG4gIGluY3JlbWVudEFjdGl2ZVJlcXVlc3RDb3VudCgpOiBudW1iZXIge1xuICAgIHJldHVybiArK3RoaXMubnVtQWN0aXZlUmVxdWVzdHM7XG4gIH1cblxuICBhY3RpdmVSZXF1ZXN0Q291bnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5udW1BY3RpdmVSZXF1ZXN0cztcbiAgfVxuXG4gIGRlY3JlbWVudEFjdGl2ZVJlcXVlc3RDb3VudCgpOiB2b2lkIHtcbiAgICAtLXRoaXMubnVtQWN0aXZlUmVxdWVzdHM7XG4gIH1cblxuICBvbk5ld1JlcXVlc3QoXG4gICAgY29udGV4dDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dFxuICApOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIge1xuICAgIHJldHVybiB0aGlzLnJlcXVlc3RIYW5kbGVyRmFjdG9yeUZuKHRoaXMsIHRoaXMubG9nZ2VyLCBjb250ZXh0KTtcbiAgfVxufVxuIl19