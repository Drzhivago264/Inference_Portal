"use strict";var fe=Object.create;var T=Object.defineProperty;var be=Object.getOwnPropertyDescriptor;var _e=Object.getOwnPropertyNames;var xe=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty;var R=(e,t)=>{for(var r in t)T(e,r,{get:t[r],enumerable:!0})},D=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of _e(t))!he.call(e,i)&&i!==r&&T(e,i,{get:()=>t[i],enumerable:!(o=be(t,i))||o.enumerable});return e};var q=(e,t,r)=>(r=e!=null?fe(xe(e)):{},D(t||!e||!e.__esModule?T(r,"default",{value:e,enumerable:!0}):r,e)),Se=e=>D(T({},"__esModule",{value:!0}),e);var dt={};R(dt,{crawler:()=>me,dbCrawler:()=>ue,pageToString:()=>ge,pagesToString:()=>pt,serializer:()=>P});module.exports=Se(dt);var ce=require("@notionhq/client"),pe=require("md-utils-ts");var g=(e,t)=>t in e;var n=q(require("md-utils-ts"),1);var N={};R(N,{annotate:()=>v,fromDate:()=>$,fromLink:()=>b,fromRichText:()=>c,fromUser:()=>k});var m=q(require("md-utils-ts"),1);var v=(e,t)=>(t.code&&(e=m.inlineCode(e)),t.bold&&(e=m.bold(e)),t.italic&&(e=m.italic(e)),t.strikethrough&&(e=m.del(e)),t.underline&&(e=m.underline(e)),e),c=e=>e.map(({plain_text:t,annotations:r,href:o})=>{if(t.match(/^\s*$/))return t;let i=t.match(/^(\s*)/),p=t.match(/(\s*)$/),d=i?i[0]:"",_=p?p[0]:"",s=t.trim();if(s==="")return d+_;let x=v(s,r),h=o?m.anchor(x,o):x;return d+h+_}).join(""),b=e=>{let t=c(e.caption),r=e.type==="external"?e.external.url:e.file.url,o=r.match(/[^\/\\&\?]+\.\w{3,4}(?=([\?&].*$|$))/);return{title:t.trim()?t:o?o[0]:"link",href:r}},k=e=>{var r;if(!g(e,"type"))return"<empty>";let t=(r=e.name)!=null?r:"<empty>";return e.type==="person"?`${t}`:`${t}[bot]`},$=e=>e?e.end?`(start)${e.start}, (end): ${e.end}`:e.start:"<empty>";var ke=e=>{let{title:t,href:r}=b(e.audio);return n.anchor(t,r)},ze=e=>n.anchor(c(e.bookmark.caption),e.bookmark.url),Pe=()=>!1,Te=e=>n.bullet(c(e.bulleted_list_item.rich_text)),$e=e=>n.quote(c(e.callout.rich_text)),we=e=>`[${e.child_page.title}]`,Be=e=>`[${e.child_database.title}]`,Ne=e=>n.codeBlock(e.code.language)(c(e.code.rich_text)),Ce=()=>!1,Ee=()=>!1,Le=()=>n.hr(),Ie=e=>{let t=c(e.embed.caption);return n.anchor(t,e.embed.url)},Re=e=>n.equationBlock(e.equation.expression),De=e=>{let{title:t,href:r}=b(e.file);return n.anchor(t,r)},qe=e=>n.h1(c(e.heading_1.rich_text)),ve=e=>n.h2(c(e.heading_2.rich_text)),Oe=e=>n.h3(c(e.heading_3.rich_text)),je=e=>{let{title:t,href:r}=b(e.image);return n.image(t,r)},Fe=e=>n.anchor(e.type,e.link_preview.url),Ue=e=>{let t=e.link_to_page.type==="page_id"?e.link_to_page.page_id:"";return n.anchor(e.type,t)},Ae=e=>n.bullet(c(e.numbered_list_item.rich_text),1),He=e=>c(e.paragraph.rich_text),Me=e=>{let{title:t,href:r}=b(e.pdf);return n.anchor(t,r)},Ke=e=>n.quote(c(e.quote.rich_text)),Ve=()=>!1,Qe=()=>!1,Ge=()=>!1,Ye=e=>`| ${e.table_row.cells.flatMap(t=>t.map(r=>c([r]))).join(" | ")} |`,Je=e=>c(e.template.rich_text),We=e=>n.todo(c(e.to_do.rich_text),e.to_do.checked),Xe=e=>c(e.toggle.rich_text),Ze=()=>!1,et=e=>{let{title:t,href:r}=b(e.video);return n.anchor(t,r)},a={audio:ke,bookmark:ze,breadcrumb:Pe,bulletedListItem:Te,callout:$e,childDatabase:Be,childPage:we,code:Ne,column:Ce,columnList:Ee,divider:Le,embed:Ie,equation:Re,file:De,heading1:qe,heading2:ve,heading3:Oe,image:je,linkPreview:Fe,linkToPage:Ue,numberedListItem:Ae,paragraph:He,pdf:Me,quote:Ke,syncedBlock:Ve,table:Qe,tableOfContents:Ge,tableRow:Ye,template:Je,toDo:We,toggle:Xe,unsupported:Ze,video:et};var O={audio:a.audio,bookmark:a.bookmark,breadcrumb:a.breadcrumb,bulleted_list_item:a.bulletedListItem,callout:a.callout,child_database:a.childDatabase,child_page:a.childPage,code:a.code,column:a.column,column_list:a.columnList,divider:a.divider,embed:a.embed,equation:a.equation,file:a.file,heading_1:a.heading1,heading_2:a.heading2,heading_3:a.heading3,image:a.image,link_preview:a.linkPreview,link_to_page:a.linkToPage,numbered_list_item:a.numberedListItem,paragraph:a.paragraph,pdf:a.pdf,quote:a.quote,synced_block:a.syncedBlock,table:a.table,table_of_contents:a.tableOfContents,table_row:a.tableRow,template:a.template,to_do:a.toDo,toggle:a.toggle,unsupported:a.unsupported,video:a.video};var j={defaults:a,strategy:O};var F=require("md-utils-ts");var z=", ",y="<empty>",U=(e,t)=>`[${e}] ${t.checkbox}`,A=(e,t)=>`[${e}] ${k(t.created_by)}`,H=(e,t)=>`[${e}] ${t.created_time}`,C=(e,t)=>`[${e}] ${$(t.date)}`,M=(e,t)=>{var r;return`[${e}] ${(r=t.email)!=null?r:y}`},K=(e,t)=>`[${e}] `+t.files.map(r=>{let o=g(r,"external")?r.external.url:r.file.url;return(0,F.anchor)(r.name,o)}).join(z),V=(e,t)=>{var r,o;switch(t.formula.type){case"string":return`[${e}] ${(r=t.formula.string)!=null?r:y}`;case"boolean":return`[${e}] ${(o=t.formula.boolean)!=null?o:y}`;case"date":return`[${e}] ${$(t.formula.date)}`;case"number":return`[${e}] ${t.formula.number}`}},Q=(e,t)=>`[${e}] ${k(t.last_edited_by)}`,G=(e,t)=>`[${e}] ${t.last_edited_time}`,Y=(e,t)=>`[${e}] `+t.multi_select.map(r=>r.name).join(z),E=(e,t)=>{var r;return`[${e}] ${(r=t.number)!=null?r:y}`},J=(e,t)=>`[${e}] `+t.people.map(r=>k(r)).join(z),W=(e,t)=>{var r;return`[${e}] ${(r=t.phone_number)!=null?r:y}`},X=(e,t)=>`[${e}] `+t.relation.map(r=>`${r.id}`).join(z),Z=(e,t)=>`[${e}] ${c(t.rich_text)}`,ee=(e,t)=>{var r,o;return`[${e}] ${(o=(r=t.select)==null?void 0:r.name)!=null?o:y}`},te=(e,t)=>{var r,o;return`[${e}] ${(o=(r=t.status)==null?void 0:r.name)!=null?o:y}`},re=(e,t)=>`[${e}] ${c(t.title)}`,oe=(e,t)=>{var p,d;let r=(p=t.unique_id.prefix)!=null?p:"",o=(d=t.unique_id.number)!=null?d:"",i=r+o;return`[${e}] ${i||y}`},ie=(e,t)=>{var r;return`[${e}] ${(r=t.url)!=null?r:y}`},ae=()=>!1,tt={checkbox:U,created_by:A,created_time:H,date:C,email:M,files:K,formula:V,last_edited_by:Q,last_edited_time:G,multi_select:Y,number:E,people:J,phone_number:W,relation:X,rich_text:Z,select:ee,status:te,title:re,unique_id:oe,url:ie,verification:ae},rt=(e,t)=>{switch(t.rollup.type){case"number":return E(e,t.rollup);case"date":return C(e,t.rollup);case"array":return Promise.all(t.rollup.array.map(r=>tt[r.type](e,r))).then(r=>`[${e}] `+r.map(o=>o).map(o=>o.replace(`[${e}] `,"")).join(z))}},l={checkbox:U,createdBy:A,createdTime:H,date:C,email:M,files:K,formula:V,lastEditedBy:Q,lastEditedTime:G,multiSelect:Y,number:E,people:J,phoneNumber:W,relation:X,richText:Z,rollup:rt,select:ee,status:te,title:re,uniqueId:oe,url:ie,verification:ae};var ne={checkbox:l.checkbox,created_by:l.createdBy,created_time:l.createdTime,date:l.date,email:l.email,files:l.files,formula:l.formula,last_edited_by:l.lastEditedBy,last_edited_time:l.lastEditedTime,multi_select:l.multiSelect,number:l.number,people:l.people,phone_number:l.phoneNumber,relation:l.relation,rich_text:l.richText,rollup:l.rollup,select:l.select,status:l.status,title:l.title,unique_id:l.uniqueId,url:l.url,verification:l.verification};var le={defaults:l,strategy:ne},se=e=>t=>Promise.all(Object.entries(t).map(([r,o])=>e[o.type](r,o))).then(r=>r.filter(o=>o!==!1));var P={block:j,property:le,utils:N};var w=e=>async t=>(0,ce.collectPaginatedAPI)(e.blocks.children.list,{block_id:t}).catch(r=>(console.error(`Fetching Notion block failed. [blockId: ${t}]`),console.error(r),[])),ot=e=>t=>e.pages.retrieve({page_id:t}),it=e=>t=>e.databases.query({database_id:t}).then(({results:r})=>r).catch(()=>[]),L=(e,t)=>e.type===t,I=(e,t,r,o)=>({metadata:{id:e.id,title:t,createdTime:e.created_time,lastEditedTime:e.last_edited_time,parentId:r},properties:o||[],lines:[]}),at=["table","table_row","column_list","column"],nt=(0,pe.indent)(),de=e=>t=>async(r,o,i={},p=0)=>{var _;let d=de(e)(t);i[r.metadata.id]=i[r.metadata.id]||r;for(let s of o){if(!g(s,"type"))continue;let x=t.block[s.type],h=await x(s);if(h!==!1){let u=nt(h,p);r.lines.push(u)}if(L(s,"synced_block")){let u=((_=s.synced_block.synced_from)==null?void 0:_.block_id)||s.id,S=await w(e)(u),f=await d(r,S,i,p);i={...i,...f};continue}if(L(s,"child_page")){let{title:u}=s.child_page,S=I(s,u,r.metadata.id),f=await w(e)(s.id),B=await d(S,f,i,0);i={...i,...B};continue}if(L(s,"child_database")){let{title:u}=s.child_database;i[s.id]=I(s,u,r.metadata.id);let f=await ue({client:e,serializers:t})(s.id);i={...i,...f};continue}if(s.has_children){let u=await w(e)(s.id),{type:S}=s,f=at.includes(S)?p:p+1,B=await d(r,u,i,f);i={...i,...B};continue}}return i},lt=e=>{if(!g(e,"properties"))return"";let t="";for(let r of Object.values(e.properties)){if(r.type!=="title")continue;t=P.property.defaults.title("",r).replace("[] ","")}return t},st=e=>({block:{...P.block.strategy,...e==null?void 0:e.block},property:{...P.property.strategy,...e==null?void 0:e.property}}),me=({client:e,serializers:t,parentId:r})=>async o=>{let i=await ot(e)(o);if(!g(i,"parent"))return console.error("Unintended Notion Page object."),{};let p=st(t),d=lt(i),s=await se(p.property)(i.properties),x=await w(e)(i.id),h=I(i,d,r,s);return de(e)(p)(h,x)},ue=e=>async t=>{let r=me({...e,parentId:t}),o=await it(e.client)(t),i={};for(let p of o){let d=await r(p.id);i={...i,...d}}return i};var ye=require("md-utils-ts"),ct=e=>e.match(/^#+\s/)?"#"+e:e,ge=({metadata:e,properties:t,lines:r})=>{let o=(0,ye.h1)(e.title),i=["---",t.join(`
`),"---"].join(`
`),p=r.map(ct);return[o,i,...p].join(`
`)},pt=e=>Object.fromEntries(Object.entries(e).map(([t,r])=>[t,ge(r)]));0&&(module.exports={crawler,dbCrawler,pageToString,pagesToString,serializer});
//# sourceMappingURL=index.cjs.map