var ae=Object.defineProperty;var ne=(e,t)=>{for(var r in t)ae(e,r,{get:t[r],enumerable:!0})};import{collectPaginatedAPI as He}from"@notionhq/client";import{indent as Me}from"md-utils-ts";var g=(e,t)=>t in e;import*as n from"md-utils-ts";var B={};ne(B,{annotate:()=>I,fromDate:()=>P,fromLink:()=>b,fromRichText:()=>c,fromUser:()=>k});import*as m from"md-utils-ts";var I=(e,t)=>(t.code&&(e=m.inlineCode(e)),t.bold&&(e=m.bold(e)),t.italic&&(e=m.italic(e)),t.strikethrough&&(e=m.del(e)),t.underline&&(e=m.underline(e)),e),c=e=>e.map(({plain_text:t,annotations:r,href:o})=>{if(t.match(/^\s*$/))return t;let a=t.match(/^(\s*)/),p=t.match(/(\s*)$/),d=a?a[0]:"",_=p?p[0]:"",s=t.trim();if(s==="")return d+_;let x=I(s,r),h=o?m.anchor(x,o):x;return d+h+_}).join(""),b=e=>{let t=c(e.caption),r=e.type==="external"?e.external.url:e.file.url,o=r.match(/[^\/\\&\?]+\.\w{3,4}(?=([\?&].*$|$))/);return{title:t.trim()?t:o?o[0]:"link",href:r}},k=e=>{var r;if(!g(e,"type"))return"<empty>";let t=(r=e.name)!=null?r:"<empty>";return e.type==="person"?`${t}`:`${t}[bot]`},P=e=>e?e.end?`(start)${e.start}, (end): ${e.end}`:e.start:"<empty>";var le=e=>{let{title:t,href:r}=b(e.audio);return n.anchor(t,r)},se=e=>n.anchor(c(e.bookmark.caption),e.bookmark.url),ce=()=>!1,pe=e=>n.bullet(c(e.bulleted_list_item.rich_text)),de=e=>n.quote(c(e.callout.rich_text)),me=e=>`[${e.child_page.title}]`,ue=e=>`[${e.child_database.title}]`,ye=e=>n.codeBlock(e.code.language)(c(e.code.rich_text)),ge=()=>!1,fe=()=>!1,be=()=>n.hr(),_e=e=>{let t=c(e.embed.caption);return n.anchor(t,e.embed.url)},xe=e=>n.equationBlock(e.equation.expression),he=e=>{let{title:t,href:r}=b(e.file);return n.anchor(t,r)},Se=e=>n.h1(c(e.heading_1.rich_text)),ke=e=>n.h2(c(e.heading_2.rich_text)),ze=e=>n.h3(c(e.heading_3.rich_text)),Pe=e=>{let{title:t,href:r}=b(e.image);return n.image(t,r)},Te=e=>n.anchor(e.type,e.link_preview.url),$e=e=>{let t=e.link_to_page.type==="page_id"?e.link_to_page.page_id:"";return n.anchor(e.type,t)},we=e=>n.bullet(c(e.numbered_list_item.rich_text),1),Be=e=>c(e.paragraph.rich_text),Ne=e=>{let{title:t,href:r}=b(e.pdf);return n.anchor(t,r)},Ce=e=>n.quote(c(e.quote.rich_text)),Ee=()=>!1,Le=()=>!1,Ie=()=>!1,Re=e=>`| ${e.table_row.cells.flatMap(t=>t.map(r=>c([r]))).join(" | ")} |`,De=e=>c(e.template.rich_text),qe=e=>n.todo(c(e.to_do.rich_text),e.to_do.checked),ve=e=>c(e.toggle.rich_text),Oe=()=>!1,je=e=>{let{title:t,href:r}=b(e.video);return n.anchor(t,r)},i={audio:le,bookmark:se,breadcrumb:ce,bulletedListItem:pe,callout:de,childDatabase:ue,childPage:me,code:ye,column:ge,columnList:fe,divider:be,embed:_e,equation:xe,file:he,heading1:Se,heading2:ke,heading3:ze,image:Pe,linkPreview:Te,linkToPage:$e,numberedListItem:we,paragraph:Be,pdf:Ne,quote:Ce,syncedBlock:Ee,table:Le,tableOfContents:Ie,tableRow:Re,template:De,toDo:qe,toggle:ve,unsupported:Oe,video:je};var R={audio:i.audio,bookmark:i.bookmark,breadcrumb:i.breadcrumb,bulleted_list_item:i.bulletedListItem,callout:i.callout,child_database:i.childDatabase,child_page:i.childPage,code:i.code,column:i.column,column_list:i.columnList,divider:i.divider,embed:i.embed,equation:i.equation,file:i.file,heading_1:i.heading1,heading_2:i.heading2,heading_3:i.heading3,image:i.image,link_preview:i.linkPreview,link_to_page:i.linkToPage,numbered_list_item:i.numberedListItem,paragraph:i.paragraph,pdf:i.pdf,quote:i.quote,synced_block:i.syncedBlock,table:i.table,table_of_contents:i.tableOfContents,table_row:i.tableRow,template:i.template,to_do:i.toDo,toggle:i.toggle,unsupported:i.unsupported,video:i.video};var D={defaults:i,strategy:R};import{anchor as Fe}from"md-utils-ts";var z=", ",y="<empty>",q=(e,t)=>`[${e}] ${t.checkbox}`,v=(e,t)=>`[${e}] ${k(t.created_by)}`,O=(e,t)=>`[${e}] ${t.created_time}`,N=(e,t)=>`[${e}] ${P(t.date)}`,j=(e,t)=>{var r;return`[${e}] ${(r=t.email)!=null?r:y}`},F=(e,t)=>`[${e}] `+t.files.map(r=>{let o=g(r,"external")?r.external.url:r.file.url;return Fe(r.name,o)}).join(z),U=(e,t)=>{var r,o;switch(t.formula.type){case"string":return`[${e}] ${(r=t.formula.string)!=null?r:y}`;case"boolean":return`[${e}] ${(o=t.formula.boolean)!=null?o:y}`;case"date":return`[${e}] ${P(t.formula.date)}`;case"number":return`[${e}] ${t.formula.number}`}},A=(e,t)=>`[${e}] ${k(t.last_edited_by)}`,H=(e,t)=>`[${e}] ${t.last_edited_time}`,M=(e,t)=>`[${e}] `+t.multi_select.map(r=>r.name).join(z),C=(e,t)=>{var r;return`[${e}] ${(r=t.number)!=null?r:y}`},K=(e,t)=>`[${e}] `+t.people.map(r=>k(r)).join(z),V=(e,t)=>{var r;return`[${e}] ${(r=t.phone_number)!=null?r:y}`},Q=(e,t)=>`[${e}] `+t.relation.map(r=>`${r.id}`).join(z),G=(e,t)=>`[${e}] ${c(t.rich_text)}`,Y=(e,t)=>{var r,o;return`[${e}] ${(o=(r=t.select)==null?void 0:r.name)!=null?o:y}`},J=(e,t)=>{var r,o;return`[${e}] ${(o=(r=t.status)==null?void 0:r.name)!=null?o:y}`},W=(e,t)=>`[${e}] ${c(t.title)}`,X=(e,t)=>{var p,d;let r=(p=t.unique_id.prefix)!=null?p:"",o=(d=t.unique_id.number)!=null?d:"",a=r+o;return`[${e}] ${a||y}`},Z=(e,t)=>{var r;return`[${e}] ${(r=t.url)!=null?r:y}`},ee=()=>!1,Ue={checkbox:q,created_by:v,created_time:O,date:N,email:j,files:F,formula:U,last_edited_by:A,last_edited_time:H,multi_select:M,number:C,people:K,phone_number:V,relation:Q,rich_text:G,select:Y,status:J,title:W,unique_id:X,url:Z,verification:ee},Ae=(e,t)=>{switch(t.rollup.type){case"number":return C(e,t.rollup);case"date":return N(e,t.rollup);case"array":return Promise.all(t.rollup.array.map(r=>Ue[r.type](e,r))).then(r=>`[${e}] `+r.map(o=>o).map(o=>o.replace(`[${e}] `,"")).join(z))}},l={checkbox:q,createdBy:v,createdTime:O,date:N,email:j,files:F,formula:U,lastEditedBy:A,lastEditedTime:H,multiSelect:M,number:C,people:K,phoneNumber:V,relation:Q,richText:G,rollup:Ae,select:Y,status:J,title:W,uniqueId:X,url:Z,verification:ee};var te={checkbox:l.checkbox,created_by:l.createdBy,created_time:l.createdTime,date:l.date,email:l.email,files:l.files,formula:l.formula,last_edited_by:l.lastEditedBy,last_edited_time:l.lastEditedTime,multi_select:l.multiSelect,number:l.number,people:l.people,phone_number:l.phoneNumber,relation:l.relation,rich_text:l.richText,rollup:l.rollup,select:l.select,status:l.status,title:l.title,unique_id:l.uniqueId,url:l.url,verification:l.verification};var re={defaults:l,strategy:te},oe=e=>t=>Promise.all(Object.entries(t).map(([r,o])=>e[o.type](r,o))).then(r=>r.filter(o=>o!==!1));var T={block:D,property:re,utils:B};var $=e=>async t=>He(e.blocks.children.list,{block_id:t}).catch(r=>(console.error(`Fetching Notion block failed. [blockId: ${t}]`),console.error(r),[])),Ke=e=>t=>e.pages.retrieve({page_id:t}),Ve=e=>t=>e.databases.query({database_id:t}).then(({results:r})=>r).catch(()=>[]),E=(e,t)=>e.type===t,L=(e,t,r,o)=>({metadata:{id:e.id,title:t,createdTime:e.created_time,lastEditedTime:e.last_edited_time,parentId:r},properties:o||[],lines:[]}),Qe=["table","table_row","column_list","column"],Ge=Me(),ie=e=>t=>async(r,o,a={},p=0)=>{var _;let d=ie(e)(t);a[r.metadata.id]=a[r.metadata.id]||r;for(let s of o){if(!g(s,"type"))continue;let x=t.block[s.type],h=await x(s);if(h!==!1){let u=Ge(h,p);r.lines.push(u)}if(E(s,"synced_block")){let u=((_=s.synced_block.synced_from)==null?void 0:_.block_id)||s.id,S=await $(e)(u),f=await d(r,S,a,p);a={...a,...f};continue}if(E(s,"child_page")){let{title:u}=s.child_page,S=L(s,u,r.metadata.id),f=await $(e)(s.id),w=await d(S,f,a,0);a={...a,...w};continue}if(E(s,"child_database")){let{title:u}=s.child_database;a[s.id]=L(s,u,r.metadata.id);let f=await Xe({client:e,serializers:t})(s.id);a={...a,...f};continue}if(s.has_children){let u=await $(e)(s.id),{type:S}=s,f=Qe.includes(S)?p:p+1,w=await d(r,u,a,f);a={...a,...w};continue}}return a},Ye=e=>{if(!g(e,"properties"))return"";let t="";for(let r of Object.values(e.properties)){if(r.type!=="title")continue;t=T.property.defaults.title("",r).replace("[] ","")}return t},Je=e=>({block:{...T.block.strategy,...e==null?void 0:e.block},property:{...T.property.strategy,...e==null?void 0:e.property}}),We=({client:e,serializers:t,parentId:r})=>async o=>{let a=await Ke(e)(o);if(!g(a,"parent"))return console.error("Unintended Notion Page object."),{};let p=Je(t),d=Ye(a),s=await oe(p.property)(a.properties),x=await $(e)(a.id),h=L(a,d,r,s);return ie(e)(p)(h,x)},Xe=e=>async t=>{let r=We({...e,parentId:t}),o=await Ve(e.client)(t),a={};for(let p of o){let d=await r(p.id);a={...a,...d}}return a};import{h1 as Ze}from"md-utils-ts";var et=e=>e.match(/^#+\s/)?"#"+e:e,tt=({metadata:e,properties:t,lines:r})=>{let o=Ze(e.title),a=["---",t.join(`
`),"---"].join(`
`),p=r.map(et);return[o,a,...p].join(`
`)},qt=e=>Object.fromEntries(Object.entries(e).map(([t,r])=>[t,tt(r)]));export{We as crawler,Xe as dbCrawler,tt as pageToString,qt as pagesToString,T as serializer};
//# sourceMappingURL=index.js.map