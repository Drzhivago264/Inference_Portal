"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "UpsertsAndDeleteStrategy", {
    enumerable: true,
    get: function() {
        return UpsertsAndDeleteStrategy;
    }
});
const _classify = require("./classify.js");
class UpsertsAndDeleteStrategy {
    docStore;
    vectorStore;
    constructor(docStore, vectorStore){
        this.docStore = docStore;
        this.vectorStore = vectorStore;
    }
    async transform(nodes) {
        const { dedupedNodes, missingDocs, unusedDocs } = await (0, _classify.classify)(this.docStore, nodes);
        // remove unused docs
        for (const refDocId of unusedDocs){
            await this.docStore.deleteRefDoc(refDocId, false);
            if (this.vectorStore) {
                await this.vectorStore.delete(refDocId);
            }
        }
        // remove missing docs
        for (const docId of missingDocs){
            await this.docStore.deleteDocument(docId, true);
            if (this.vectorStore) {
                await this.vectorStore.delete(docId);
            }
        }
        await this.docStore.addDocuments(dedupedNodes, true);
        return dedupedNodes;
    }
}
