{% extends "component_html/base.html" %}
{% block head %}
<link rel="stylesheet" id="picotheme" href="/static/css/pico-main/css/pico.min.css" />
<link rel="stylesheet" href="/static/css/hotpot.css">

<meta name="viewport" content="width=device-width, initial-scale=1">

{% endblock head %}

{% block content%}
<style>
    html,
    body, 
    main,
    .pagewrapper 
    {
        min-width: 1250px!important;
    }
</style>
<main>
    <div class="pagewrapper container">
        
        <div class="grid" style="grid-template-columns: 25% 35% 35%;">
            <div id="container" style="padding-left: 10px">
                <span>Key:
                    <input type="password" style="height: 20px; width: 80%; font-size:calc(10px + 0.3vw);" id="api_key">
                </span>
                <br>
                <span>
                    <input type="checkbox" class="duplicate-message" name="duplicate-message" id="duplicate-message"
                        checked> Duplicate message
                </span>
                <h4>Swap Child Template</h4>
                <ul id="document-structure">
                    {% for child in child_template %}
                    {% if child.name == "Introduction"%}
                    <li><a class="primary">{{child.name}}</a></li>
                    {% else %}
                    <li><a class="secondary">{{child.name}}</a></li>
                    {% endif %}
                    {% endfor %}
                </ul>
                <div>
                    <small><i>NOTE: If the default parameters does not work for you, you can adjust them
                            here.</i></small> <br>
                    <small><i>NOTE: In order to better understand these parameters, refer to <a
                                href='https://huggingface.co/blog/how-to-generate'> This Blog </a> or <a
                                href='https://github.com/vllm-project/vllm/blob/main/vllm/sampling_params.py'> This
                                Code. </a>
                        </i></small>
                    <hr>
                    <label for="top_p">Top_p:</label>
                    <div class="grid" style="grid-template-columns: 80% 20%;">
                        <input type="range" step=".001" name="top_p" min="0.01" max="1" value="0.73"
                            oninput="this.nextElementSibling.value = parseFloat(this.value).toFixed(2)">
                        <output>0.73</output>
                    </div>
                    <label for="top_k">Top_k:</label>
                    <div class="grid" style="grid-template-columns: 80% 20%;">
                        <input type="range" step="1" name="top_k" min="0" max="100" value="0"
                            oninput="this.nextElementSibling.value = this.value">
                        <output>-1</output>
                    </div>
                    <label for="max_tokens">Max_tokens:</label>
                    <div class="grid" style="grid-template-columns: 80% 20%;">
                        <input type="range" step="1" name="max_tokens" min="1" max="4096" value="128"
                            oninput="this.nextElementSibling.value = this.value">
                        <output>128</output>
                    </div>


                    <label for="temperature">Temperature:</label>
                    <div class="grid" style="grid-template-columns: 80% 20%;">
                        <input type="range" step=".001" name="temperature" min="0" max="1.0" value="0.72"
                            oninput="this.nextElementSibling.value = parseFloat(this.value).toFixed(2)">
                        <output>0.72</output>
                    </div>
                    <label for="frequency_penalty">Frequency penalty:</label>
                    <div class="grid" style="grid-template-columns: 80% 20%;">
                        <input type="range" step=".001" name="frequency_penalty" min="-2.0" max="2.0" value="0"
                            oninput="this.nextElementSibling.value = parseFloat(this.value).toFixed(2)">
                        <output>0</output>
                    </div>
                    <label for="presence_penalty">Presence penalty:</label>
                    <div class="grid" style="grid-template-columns: 80% 20%;">
                        <input type="range" step=".001" name="presence_penalty" min="-2.0" max="2.0" value="0"
                            oninput="this.nextElementSibling.value = parseFloat(this.value).toFixed(2)">
                        <output>0</output>
                    </div>

                    <hr>
                    <small><i>NOTE: These parameters go along with each others, please know what you are
                            doing.</i></small><br>
                    <small><i>NOTE: Return to default value if you messed up the parameters</i></small>
                    <hr>
                    <input type="checkbox" class="checkbox_beam" name="beam" id="beam"> Beam Search (default =
                    False) <br>
                    <input type="checkbox" class="checkbox_early_stopping" name="early_stopping" id="early_stopping">
                    Early
                    Stop (default = False) <br><br>
                    <input style="width: 10ch;" type="number" step="0.01" name="length_penalty" min="-2.0" max="2.0"
                        value="0">
                    Length Penalty
                    (default = 0)<br>
                    <input style="width: 10ch;" type="number" step="1" name="best_of" min="1" max="5" value="2">
                    Best of
                    (default = 2 for beam
                    search, 1 for sampling) <br>
                </div>
            </div>
            <div class="container" id="site_content_document">
                <div class="grid" style="grid-template-columns: 35% 60%;">
                    <h4>Bot:</h4>
                    <select  name="template-select" id="bot-select" aria-label="Select your bot..."
                        required>
                        {% for model in llms %}
                        {% if model.name == 'Mistral Chat 13B' and not model.agent_availability %}
                        <option selected name="template" value="{{model.name}}">
                            {{model.name}}<br>
                            {% else %}
                        <option name="template" value="{{model.name}}"> {{model.name}}<br>
                            {% endif %}
                            {% endfor %}
                    </select>
                </div>
                <div id="chat-log-bot">
                    <div class="message_log_container"
                        style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">

                    </div>
                    <div id="chat-log-bot_">
                    </div>

                </div>
                <hr>
                <div class="input-wrapper">
                    <textarea id="chat-message-input-bot" name="message"></textarea>
                    <button id="chat-message-submit-bot">Send</button>
                </div>
                <hr>
                <div id="document-instruction">
                    <h4>Agent Instruction</h4>
                    <textarea id="agent_instruction" rows="10" style="font-size: 12px;"
                        autocomplete="off">{{template.instruct|safe}}</textarea>
                </div>

            </div>

            <div clas="container">
                <div class="grid" style="grid-template-columns: 20% 40% 30%;">
                    <h4>Agent:</h4>
                    <select autocomplete="off" name="template-select" id="template-select-agent"
                        aria-label="Select your agent..." required>
                        {% for template in templates %}
                        {% if template.name == 'Assignment Agent' %}
                        <option selected name="template" value="{{template.name}}">
                            {{template.name}}<br>
                            {% else %}
                        <option name="template" value="{{template.name}}"> {{template.name}}<br>
                            {% endif %}
                            {% endfor %}
                    </select>
                    <select autocomplete="off" name="template-select" id="agent-select"
                        aria-label="Select your agent..." required>
                        {% for model in llms %}
                        {% if model.name == 'gpt-4' and model.agent_availability %}
                        <option selected name="template" value="{{model.name}}">
                            {{model.name}}<br>
                            {% elif model.agent_availability%}
                        <option name="template" value="{{model.name}}"> {{model.name}}<br>
                            {% endif %}
                            {% endfor %}
                    </select>
                </div>
                <div id="chat-log-agent">
                    <div class="message_log_container"
                        style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">
                    </div>
                    <div id="chat-log-agent_">
                    </div>

                </div>
                <hr>
                <div class="input-wrapper">
                    <textarea id="chat-message-input-agent" name="message"></textarea>
                    <button id="chat-message-submit-agent">Send</button>
                </div>
                <hr>
                <div id="document-child-instruction">
                    <h4>Child Instruction</h4>
                    {% for child in child_template %}
                    {% if child.name == "Introduction"%}
                    <textarea id="child_instruction" rows="10" style="font-size: 12px;"
                        autocomplete="off">{{child.instruct|safe}}</textarea>
                    {% endif %}
                    {% endfor %}
                </div>
                {{ name|json_script:"name" }}
                {{ key|json_script:"key" }}
            </div>

        </div>
    </div>
</main>
<script>
    var duplicate = true
    document.getElementById("duplicate-message").onchange = function (e) {
        if (document.getElementById("duplicate-message").checked) {
            duplicate = true;
        } else {
            duplicate = false;
        }

    }
    const key = JSON.parse(document.getElementById('key').textContent);
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    const chatSocket_agent = new WebSocket(
        ws_scheme
        + '://'
        + window.location.host
        + '/ws/engineer/'
        + key
        + '/'
    );
    const chatSocket_bot = new WebSocket(
        ws_scheme
        + '://'
        + window.location.host
        + '/ws/chat/'
        + key
        + '/'
    );
    chatSocket_agent.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.role == 'Human') {
            document.querySelector('#chat-log-agent_').innerHTML += ('<div class="message_log_container" style="text-align: right;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + " (" + data.role + "-" + data.time + ") " + data.message.replace(/\n/g, "<br>") + '</span></div> ');
        }
        else if (data.holder) {
            document.querySelector('#chat-log-agent_').innerHTML += ('<div class="message_log_container" id =' + data.holderid + ' style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + data.role + "-" + data.time + ": " + '</span></div> ');
        }
        else if (data.swap_instruction) {
            document.getElementById("agent_instruction").value = data.swap_instruction;
            document.getElementById("child_instruction").value = data.default_child_instruct;
            document.querySelector('#document-structure').innerHTML = ""
            for (let child of data.child_template_name_list) {
                if (child == data.default_child) {
                    document.querySelector('#document-structure').innerHTML += ("<li><a class='primary'>" + child + "</a></li>")
                }
                else {
                    document.querySelector('#document-structure').innerHTML += ("<li><a class='secondary'>" + child + "</a></li>")
                }
            }
        }
        else if (data.child_instruct) {
            document.getElementById("child_instruction").value = data.child_instruct;
        }
        else if (data.stream_id) {
            document.getElementById(data.stream_id).innerHTML += data.message.replace(/\n/g, "<br>")
        }
        else {
            document.querySelector('#chat-log-agent_').innerHTML += ('<div class="message_log_container" style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + data.message.replace(/\n/g, "<br>") + " (" + data.role + "-" + data.time + ") " + '</span></div> ');
        }

        logTa = document.getElementById("chat-log-agent")
        logTa.scrollTop = logTa.scrollHeight;
    };
    chatSocket_agent.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };
    chatSocket_bot.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.role == 'Human') {
            document.querySelector('#chat-log-bot_').innerHTML += ('<div class="message_log_container" style="text-align: right;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + " (" + data.role + "-" + data.time + ") " + data.message.replace(/\n/g, "<br>") + '</span></div> ');
        }
        else if (data.holder) {
            document.querySelector('#chat-log-bot_').innerHTML += ('<div class="message_log_container" id =' + data.holderid + ' style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + data.role + "-" + data.time + ": " + '</span></div> ');
        }
        else if (data.stream_id) {
            document.getElementById(data.stream_id).innerHTML += data.message.replace(/\n/g, "<br>")
        }
        else {
            document.querySelector('#chat-log-bot_').innerHTML += ('<div class="message_log_container" style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + data.message.replace(/\n/g, "<br>") + " (" + data.role + "-" + data.time + ") " + '</span></div> ');
        }
        logTa = document.getElementById("chat-log-bot")
        logTa.scrollTop = logTa.scrollHeight;

    };

    chatSocket_bot.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };
    var textarea_agent = document.getElementById("chat-message-input-agent");
    var textarea_bot = document.getElementById("chat-message-input-bot")
    var textarea_submit_button_agent = document.querySelector('#chat-message-submit-agent')
    var textarea_submit_button_bot = document.querySelector('#chat-message-submit-bot')
    textarea_agent.focus();
    textarea_agent.onkeyup = function (e) {
        if (e.keyCode === 13 && !e.shiftKey) {
            textarea_submit_button_agent.click();
            if (duplicate) {
                textarea_submit_button_bot.click();
            }
        }
    };
    textarea_bot.onkeyup = function (e) {
        if (e.keyCode === 13 && !e.shiftKey) {
            textarea_submit_button_bot.click();
            if (duplicate) {
                textarea_submit_button_agent.click();
            }
        }
    };
    var textarea_size_litmit = 300;
    textarea_agent.oninput = function () {
        if (duplicate) {
            textarea_bot.value = textarea_agent.value
            textarea_bot.style.height = "";
            textarea_bot.style.height = Math.min(textarea_agent.scrollHeight, textarea_size_litmit) + "px";
        }
        textarea_agent.style.height = "";
        textarea_agent.style.height = Math.min(textarea_agent.scrollHeight, textarea_size_litmit) + "px";
    };
    textarea_bot.oninput = function () {
        if (duplicate) {
            textarea_agent.value = textarea_bot.value;
            textarea_agent.style.height = "";
            textarea_agent.style.height = Math.min(textarea_bot.scrollHeight, textarea_size_litmit) + "px";
        }
        textarea_bot.style.height = "";
        textarea_bot.style.height = Math.min(textarea_bot.scrollHeight, textarea_size_litmit) + "px";
    };

    textarea_submit_button_agent.onclick = function (e) {
        textarea_agent.style.height =  "100px";
        var choosen_models = document.getElementById("agent-select").value;
        var choosen_template = document.getElementById("template-select-agent").value;
        const agent_instruction = document.getElementById('agent_instruction').value
        const child_instruction = document.getElementById('child_instruction').value
        const api_key = document.getElementById('api_key').value
        const top_p = document.getElementsByName("top_p")[0].value
        var max_tokens = document.getElementsByName("max_tokens")[0].value
        if (max_tokens == 0) {
            max_tokens = null
        }

        const temperature = document.getElementsByName("temperature")[0].value
        const frequency_penalty = document.getElementsByName("frequency_penalty")[0].value
        const presence_penalty = document.getElementsByName("presence_penalty")[0].value

        const message_agent = textarea_agent.value;
        if (message_agent.trim() !== "") {
            chatSocket_agent.send(JSON.stringify({
                'currentParagraph': 0,
                'message': message_agent,
                'key': api_key,
                'choosen_models': choosen_models,
                'choosen_template': choosen_template,
                'role': 'Human',
                'top_p': parseFloat(top_p).toFixed(2),
                'max_tokens': max_tokens,
                'frequency_penalty': parseFloat(frequency_penalty).toFixed(2),
                'presence_penalty': parseFloat(presence_penalty).toFixed(2),
                'temperature': parseFloat(temperature).toFixed(2),
                'agent_instruction': agent_instruction,
                'child_instruction': child_instruction
            }));
            textarea_agent.value = '';
        };
    }
    textarea_submit_button_bot.onclick = function (e) {
        textarea_bot.style.height =  "100px";
        var choosen_models = document.getElementById("bot-select").value;
        const api_key = document.getElementById('api_key').value
        const top_p = document.getElementsByName("top_p")[0].value
        var top_k = document.getElementsByName("top_k")[0].value
        if (top_k <= 0) {
            top_k = -1
        }
        const best_of = document.getElementsByName("best_of")[0].value
        const max_tokens = document.getElementsByName("max_tokens")[0].value
        const temperature = document.getElementsByName("temperature")[0].value

        const frequency_penalty = document.getElementsByName("frequency_penalty")[0].value
        const presence_penalty = document.getElementsByName("presence_penalty")[0].value
        if (document.getElementById('beam').checked) {
            beam = true
        } else {
            beam = false
        }
        if (document.getElementById('early_stopping').checked) {
            early_stopping = true
        } else {
            early_stopping = false
        }

        const length_penalty = document.getElementsByName("length_penalty")[0].value
        const message_bot = textarea_bot.value;
        if (message_bot.trim() !== "") {
            chatSocket_bot.send(JSON.stringify({
                'mode': "chat",
                'message': message_bot,
                'key': api_key,
                'choosen_models': choosen_models,
                'role': 'Human',
                'top_k': top_k,
                'top_p': parseFloat(top_p).toFixed(2),
                'best_of': best_of,
                'max_tokens': max_tokens,
                'frequency_penalty': parseFloat(frequency_penalty).toFixed(2),
                'presence_penalty': parseFloat(presence_penalty).toFixed(2),
                'temperature': parseFloat(temperature).toFixed(2),
                'beam': beam,
                'early_stopping': early_stopping,
                'length_penalty': parseFloat(length_penalty).toFixed(2),
                'include_memory': true
            }));
            textarea_bot.value = '';
        }
    };

    var template_select = document.getElementById('template-select-agent');
    template_select.onchange = (event) => {
        var template = event.target.value;
        chatSocket_agent.send(JSON.stringify({
            'swap_template': template,
        }));
    }
    var ul = document.getElementById('document-structure');
    ul.onclick = function (event) {
        var lis = document.querySelectorAll('#document-structure a');
        for (var j = 0; j < lis.length; j++) {
            console.log(lis[j].className = "secondary");
        }
        if (event.target.tagName == "A") {
            event.target.className = "primary"
            chatSocket_agent.send(JSON.stringify({
                'swap_child_instruct': event.target.innerHTML,
            }));
        }
    };
</script>
{% endblock content%}