<!DOCTYPE HTML>
<html>

<head>
    <title>Engineering</title>
    <meta name="description" content="website description" />
    <meta name="keywords" content="website keywords, website keywords" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="/static/css/style.css" title="style" />
    <link rel="shortcut icon" type="image/png" href="/static/image/favicon.ico" />
</head>
<style>
    #chat-log {
        width: 60% !important;
        min-width: 250px;
        min-height: 150px;
        resize: vertical;
        background-color: rgb(37, 37, 37);
        color: white;
        border: 1px solid #ccc;
        box-sizing: border-box;
        height: 30vh;
        overflow: auto;
    }
    .message_log_container {
        margin: 10px;
    }

    input {
        width: 7ch;
    }

    #document-template {
        width: 75% !important;
        min-width: 350px;
        min-height: 250px;
        float: right;
        background-color: rgb(37, 37, 37);
        color: white;
        border: 1px solid #ccc;
        box-sizing: border-box;
        overflow: scroll;
    }

    #document-instruction {
        width: 75% !important;
        min-width: 350px;
        max-height: 250px;
        float: right;
        background-color: rgb(37, 37, 37);
        color: white;
        border: 1px solid #ccc;
        box-sizing: border-box;
        height: 100%;
        overflow: scroll;
    }

    .container {
        width: 95%;
        min-width: 1654px;
        display: flex;
        margin-left: auto;
        margin-right: auto;
        align-items: stretch;
        justify-content: space-around;
    }

    #site_content_chat {
        width: 45%;

        overflow: hidden;
        background: #FFF;
    }

    #site_content_document {
        width: 55%;
        min-width: 450px;
        overflow: scroll;
        background: #FFF;
    }

    .child {
        margin: 0 .5em;
        padding: .5em;
        /* optional */
        min-height: 100%;
    }

    .sidebar {
        float: right;
        min-width: 150px;
        overflow: scroll;
        padding: 0 15px 20px 15px;
    }

    #sidebar_left {
        float: left top;
        width: 210px;

        overflow: scroll;
        padding: 0 10px 10px 10px;
     
    }
</style>

<body>
    <div id="main">
        <div id="header">
            <div id="logo">
                <div id="logo_text">
                    <h1><a href="index">Inference <span class="logo_colour"></span></a></h1>
                </div>
            </div>
            <div id="menubar">
                <ul id="menu">
                    <div class="dropdown">
                        <a href="/">
                            <button class="dropbtn">Introduction</button>
                        </a>
                        <div class="dropdown-content">
                            <a href="/">Introduction</a>
                            <a href="/model_infor">Model</a>
                            <a href="/manual">User Manual</a>
                            <a href="/contact">Contact Us</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">
                            <button class="dropbtn-selected">Inference Modes</button>
                        </a>
                        <div class="dropdown-content">
                            <a href="/prompt">Prompt and API</a>
                            <a href="/chat">Chat Bot and Agent</a>
                        </div>
                    </div>
                    <a href="/buy">
                        <button class="dropbtn">Get Key</button>
                    </a>
                    <a href="/promptresponse">
                        <button class="dropbtn">Response Log</button>
                    </a>
                </ul>
            </div>
        </div>
        <div class="container">
            <div class="child" id="site_content_document">
                <div id="document-instruction">
                    <h3 style="color:white; padding:10px">Agent Instruction</h3>
                    {% for template in templates %}
                    {% if template.template_name == 'Assignment Agent' %}
                    <textarea id="agent_instruction"
                        style="padding: 10px; height: 100%; width:100%;" >{{template.bot_instruct|safe}}</textarea>
                    {% endif %}
                    {% endfor %}
                    
                </div>

                <div id="document-template">
                    <h3 style="color:white; padding:10px">Document template</h3>
                    {% for template in templates %}
                    {% if template.template_name == 'Assignment Agent' %}
                    <div id="document-template-holder" style="padding: 10px">
                        {{template.template|safe}}
                    </div>
                    {% endif %}
                    {% endfor %}
                    
                </div>
                <div id="sidebar_left">
                    <br>
                    <h3>Templates</h3>
                    <form autocomplete="off">
                        {% for template in templates %}
                        {% if template.template_name == 'Assignment Agent' %}
                        <input type="radio" class="checkbox" name="template" value="{{template.template_name}}" checked="checked"> {{template.template_name}}<br>
                        {% else %}
                        <input type="radio" class="checkbox" name="template" value="{{template.template_name}}"> {{template.template_name}}<br>
                        {% endif %}
                        {% endfor %}
                    </form>
                    <br>
                    <hr>
                    <br>
                    <button  style="display: block; margin: 0 auto;" id="doc-export">
                         Export Document 
                    </button>
                </div>

            </div>
            <div class="child" id="site_content_chat">
                <div class="sidebar">
                    <br>
                    <h3> Available Models </h3>
                    {% for llm in llms %}
                    {% if llm.name == 'gpt-4' %}
                    <input type="radio" class="checkbox_model" name="model" value="{{llm.name}}" checked="checked"> {{llm.name}}<br>
                    {% else %}
                    <input type="radio" class="checkbox_model" name="model" value="{{llm.name}}"> {{llm.name}}<br>
                    {% endif %}
                    {% endfor %}
                    <h3> Parameters </h3>
                    <h5>NOTE: If the default parameters does not work for you, you can adjust them here.</h5>
                    <h5>NOTE: In order to better understand these parameters, refer to <a
                            href='https://huggingface.co/blog/how-to-generate'> This Blog </a> or <a
                            href='https://github.com/vllm-project/vllm/blob/main/vllm/sampling_params.py'> This Code.
                        </a> </h5>
                    <input type="number" step="0.1" name="top_p" min="0.01" max="1" value="0.73"> Top_p (default = 0.73)
                    <br>
                    <input type="number" step="0.1" name="top_k" min="0.01" max="1" value="-1"> Top_k (default = -1)
                    <br>
                    <input type="number" step="0.1" name="max_tokens" min="1" max="2048" value="128"> Token Num (default
                    = 128)<br>
                    <input type="number" step="0.1" name="temperature" min="0" max="1" value="0.72"> Temperature
                    (default= 0.72) <br>
                    <input type="number" step="0.1" name="frequency_penalty" min="-2" max="2" value="0"> Frequency
                    Penalty (default=0)<br>
                    <input type="number" step="0.1" name="presense_penalty" min="-2" max="2" value="0"> Presense Penalty
                    (default=0)<br><br>
                    <hr>
                    <br>
                    <h5>NOTE: These parameters go along with each others, please know what you are doing.</h5>
                    <h5>NOTE: Return to default value if you messed up the parameters</h5>
                    <input type="checkbox" class="checkbox_beam" name="beam" id="beam"> Beam Search (default = False)
                    <br>
                    <input type="checkbox" class="checkbox_early_stopping" name="early_stopping" id="early_stopping">
                    Early Stop (default = False) <br>
                    <input type="number" step="0.1" name="length_penalty" min="-2" max="2" value="0"> Length Penalty
                    (default = 0)<br>
                    <input type="number" step="0.1" name="best_of" min="1" max="5" value="2"> Best of (default = 2 for
                    beam search, 1 for sampling) <br>

                </div>

                <div id="chat-log">
                    <div class="message_log_container"
                        style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">
                        <span> Input your Key Name:
                            <input id="api_key">
                        </span>
                    </div>
                    <div id="chat-log_">
                    </div>

                </div>
                <textarea id="chat-message-input" rows="5" style="width: 50%;" name="message"></textarea>
                <input id="chat-message-submit" type="button" value="Send">
                {{ name|json_script:"name" }}
                {{ key|json_script:"key" }}
            </div>
        </div>
        <script>
            var currentParagraph = "Introduction";

            function download(mimeType, filename){
                var download_content = ""
                var a = document.createElement('a')
                var paragraphs = document.getElementsByClassName('place-holder-template');
                for (var i = 0; paragraphs[i]; ++i) {
                    download_content += paragraphs[i].value
                }
                console.log(download_content)
                var blob = new Blob([download_content], {type: mimeType})
                var url = URL.createObjectURL(blob)
                a.setAttribute('href', url)
                a.setAttribute('download', filename)
                a.click()
            }
            document.getElementById("doc-export").addEventListener("click", function() {
                download('text/plain', 'Written_By_Professor_Parakeet.txt')
            });
            const key = JSON.parse(document.getElementById('key').textContent);
            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            const chatSocket = new WebSocket(
                ws_scheme
                + '://'
                + window.location.host
                + '/ws/engineer/'
                + key
                + '/'
            );

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                if (data.role == 'Human') {
                    document.querySelector('#chat-log_').innerHTML += ('<div class="message_log_container" style="text-align: right;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + " (" + data.role + "-" + data.time + ") " + data.message.replace(/\n/g, "<br>")  + '</span></div> ');
                }
                else if (data.holder) {
                    document.querySelector('#chat-log_').innerHTML += ('<div class="message_log_container" id =' + data.holderid + ' style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + data.role + "-" + data.time + ": " + '</span></div> ');
                }
                else if (data.stream_id) {
                    document.getElementById(data.stream_id).innerHTML += data.message.replace(/\n/g, "<br>") 
                }
                else if (data.paragraph) {
                    currentParagraph = data.paragraph    
                }
                else if (data.swap_instruction) {
                    document.getElementById("agent_instruction").value = data.swap_instruction; 
                    document.getElementById("document-template-holder").innerHTML = data.swap_template;
                }
                else if (data.agent_action == "STOP"){
                    document.getElementById(data.result_id).value = data.full_result;
                }
                else {
                    document.querySelector('#chat-log_').innerHTML += ('<div class="message_log_container" style="text-align: left;word-wrap: break-word; overflow-wrap: break-word;">  <span>' + data.message.replace(/\n/g, "<br>")  + " (" + data.role + "-" + data.time + ") " + '</span></div> ');
                }

                logTa = document.getElementById("chat-log")
                logTa.scrollTop = logTa.scrollHeight;
            };

            chatSocket.onclose = function (e) {
                console.error('Chat socket closed unexpectedly');
            };

            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function (e) {
                if (e.keyCode === 13) {  // enter, return
                    document.querySelector('#chat-message-submit').click();
                }
            };

            function reply_click(clicked_id) {
                chatSocket.send(JSON.stringify({
                    'paragraph': clicked_id,
                }));
            }
            document.querySelector('#chat-message-submit').onclick = function (e) {
                var choosen_models = null;
                var mode = null;
                var choosen_template = null

                var inputElements = document.getElementsByClassName('checkbox_model');
                for (var i = 0; inputElements[i]; ++i) {
                    if (inputElements[i].checked) {
                        choosen_models = inputElements[i].value;
                        break;
                    }
                }
                var templateElements = document.getElementsByClassName('checkbox');
                for (var i = 0; templateElements[i]; ++i) {
                    if (templateElements[i].checked) {
                        choosen_template = templateElements[i].value;
                        break;
                    }
                }                
                var modeElements = document.getElementsByClassName('checkbox_mode');
                for (var i = 0; modeElements[i]; ++i) {
                    if (modeElements[i].checked) {
                        mode = modeElements[i].value;
                        break;
                    }
                }
                const agent_instruction = document.getElementById('agent_instruction').value
                const api_key = document.getElementById('api_key').value
                const top_p = document.getElementsByName("top_p")[0].value
                const top_k = document.getElementsByName("top_k")[0].value
                const best_of = document.getElementsByName("best_of")[0].value
                const max_tokens = document.getElementsByName("max_tokens")[0].value
                const temperature = document.getElementsByName("temperature")[0].value
                const frequency_penalty = document.getElementsByName("frequency_penalty")[0].value
                const presense_penalty = document.getElementsByName("presense_penalty")[0].value
                if (document.getElementById('beam').checked) {
                    beam = "true"
                } else {
                    beam = "false"
                }
                if (document.getElementById('early_stopping').checked) {
                    early_stopping = "true"
                } else {
                    early_stopping = "false"
                }
                const length_penalty = document.getElementsByName("length_penalty")[0].value


                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value;
                chatSocket.send(JSON.stringify({
                    'mode': mode,
                    'currentParagraph': currentParagraph,
                    'message': message,
                    'key': api_key,
                    'choosen_models': choosen_models,
                    'choosen_template': choosen_template,
                    'role': 'Human',
                    'top_k': top_k,
                    'top_p': top_p,
                    'best_of': best_of,
                    'max_tokens': max_tokens,
                    'frequency_penalty': frequency_penalty,
                    'presense_penalty': presense_penalty,
                    'temperature': temperature,
                    'beam': beam,
                    'early_stopping': early_stopping,
                    'length_penalty': length_penalty,
                    'agent_instruction': agent_instruction
                }));
                messageInputDom.value = '';
            };
            function swaptemplate(event) {
                chatSocket.send(JSON.stringify({
                            'swap_template': event.target.value,
                    }));
            }
            document.querySelectorAll("input[name='template']").forEach((input) => {
                input.addEventListener('change', swaptemplate);
            });
        </script>
</body>
</html>